<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOMswap</title>
  
  <!-- 收藏图标和社交媒体标签 -->
  <link rel="icon" type="image/x-icon" href="https://i.imgur.com/HddyTrv.jpeg">
  <link rel="apple-touch-icon" href="https://i.imgur.com/HddyTrv.jpeg">
  <link rel="shortcut icon" href="https://i.imgur.com/HddyTrv.jpeg">
  
  <!-- Open Graph 标签 -->
  <meta property="og:title" content="LOMswap - Conflux 去中心化交易所">
  <meta property="og:description" content="在 Conflux eSpace 上交易 LOM 代币">
  <meta property="og:image" content="https://i.imgur.com/HddyTrv.jpeg">
  <meta property="og:url" content="https://lom-dex.com">
  <meta name="twitter:card" content="summary_large_image">
  
  <!-- 安全策略 -->
  <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self' https:;
                 script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval';
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' https://i.imgur.com data:;
                 connect-src 'self' https://*.confluxrpc.com wss: blob:;
                 font-src 'self' data:;
                 frame-src 'none';
                 object-src 'none';">
  
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    /* ========== 基础样式 ========== */
    :root {
      --primary-dark: #0d1117;
      --primary-blue: #1a73e8;
      --accent-purple: #8a2be2;
      --accent-yellow: #ffd700;
      --accent-red: #ff4757;
      --accent-green: #2ea043;
      --card-bg: #161b22;
      --card-bg-light: #1c2128;
      --border-color: #30363d;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --success: #2ea043;
      --warning: #ff6b6b;
      --gradient-primary: linear-gradient(135deg, #1a73e8, #8a2be2);
      --gradient-yellow: linear-gradient(135deg, #ffd700, #ffa500);
      --gradient-red: linear-gradient(135deg, #ff4757, #ff6b81);
      --gradient-green: linear-gradient(135deg, #2ea043, #3ddc84);
      --gradient-card: linear-gradient(135deg, rgba(26, 115, 232, 0.1), rgba(138, 43, 226, 0.05));
      --gradient-gold: linear-gradient(135deg, #FFD700, #FFA500);
      --gradient-silver: linear-gradient(135deg, #C0C0C0, #808080);
      --gradient-bronze: linear-gradient(135deg, #CD7F32, #8B4513);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent !important;
    }
    
    *:focus {
      outline: none !important;
      box-shadow: none !important;
    }
    
    body {
      background: var(--primary-dark);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Segoe UI Emoji', sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(26, 115, 232, 0.05) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(138, 43, 226, 0.05) 0%, transparent 40%);
    }
    
    .app {
      width: 100%;
      max-width: 500px;
      animation: fadeIn 0.5s ease-out;
    }

    /* ========== 项目介绍弹窗 ========== */
    .project-intro-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(13, 17, 23, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease-out;
    }
    
    .project-intro-overlay.show {
      display: flex;
    }
    
    .project-intro-card {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      border: 2px solid var(--accent-yellow);
      box-shadow: 0 20px 50px rgba(255, 215, 0, 0.2);
      position: relative;
      animation: slideUp 0.4s ease-out;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .project-intro-header {
      text-align: center;
      margin-bottom: 25px;
    }
    
    .project-intro-logo {
      width: 100px;
      height: 100px;
      margin: 0 auto 20px;
      border-radius: 50%;
      background-image: url('https://i.imgur.com/HddyTrv.jpeg');
      background-size: cover;
      background-position: center;
      border: 3px solid var(--accent-yellow);
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
    }
    
    .project-intro-title {
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 10px;
      background: var(--gradient-yellow);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
    }
    
    .project-intro-subtitle {
      font-size: 18px;
      color: var(--accent-yellow);
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .project-intro-slogan {
      font-size: 14px;
      color: var(--text-secondary);
      font-style: italic;
    }
    
    .project-intro-content {
      margin-bottom: 25px;
    }
    
    .project-intro-section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 215, 0, 0.2);
    }
    
    .project-intro-section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: var(--accent-yellow);
      font-size: 18px;
      font-weight: 700;
    }
    
    .project-intro-section-icon {
      font-size: 24px;
    }
    
    .project-intro-section-content {
      color: var(--text-primary);
      line-height: 1.6;
      font-size: 15px;
    }
    
    .project-intro-section-content ul {
      padding-left: 20px;
      margin-top: 10px;
    }
    
    .project-intro-section-content li {
      margin-bottom: 8px;
      position: relative;
    }
    
    .project-intro-section-content li:before {
      content: "✓";
      color: var(--success);
      font-weight: bold;
      position: absolute;
      left: -20px;
    }
    
    .project-intro-features {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 20px 0;
    }
    
    .project-intro-feature {
      background: rgba(255, 215, 0, 0.1);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      border: 1px solid rgba(255, 215, 0, 0.3);
    }
    
    .project-intro-feature-icon {
      font-size: 20px;
      margin-bottom: 8px;
      display: block;
    }
    
    .project-intro-feature-text {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .project-intro-close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 10;
    }
    
    .project-intro-close-btn:hover {
      background: rgba(255, 215, 0, 0.2);
      color: var(--accent-yellow);
      transform: rotate(90deg);
    }
    
    .project-intro-footer {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .project-intro-footer-text {
      font-size: 13px;
      color: var(--text-secondary);
      text-align: center;
      line-height: 1.5;
    }
    
    /* ========== 头部样式优化 ========== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 0 10px;
      position: relative;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .logo-container:hover {
      transform: translateY(-2px);
    }
    
    .logo-img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-image: url('https://i.imgur.com/HddyTrv.jpeg');
      background-size: cover;
      background-position: center;
      border: 2px solid var(--accent-yellow);
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
    }
    
    .logo-text {
      font-size: 24px;
      font-weight: 900;
      background: var(--gradient-yellow);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.5px;
    }
    
    .wallet-section {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-shrink: 0;
      width: auto;
    }
    
    .header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      min-width: 180px;
      max-width: 220px;
    }
    
    .btn {
      background: var(--gradient-primary);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px 16px;
      font-size: 14px;
      height: 40px;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.2);
      overflow: hidden;
      text-overflow: ellipsis;
      flex-shrink: 0;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(26, 115, 232, 0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    #walletBtn {
      min-width: 110px !important;
      max-width: 110px !important;
      width: 110px !important;
   }
    
    #walletBtn.connected {
      background: rgba(46, 160, 67, 0.15);
      border: 1px solid var(--success);
      color: var(--success);
      font-size: 13px;
      min-width: 140px;
      max-width: 160px;
      padding: 10px 12px;
    }
    
    #walletBtn.connecting {
      background: rgba(255, 215, 0, 0.15);
      border: 1px solid var(--accent-yellow);
      color: var(--accent-yellow);
      min-width: 140px;
      max-width: 160px;
    }
    
    #langBtn {
      width: 40px;
      height: 40px;
      min-width: 40px;
      min-height: 40px;
      max-width: 40px;
      max-height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    /* ========== 标签页样式 ========== */
    .tab-container {
      margin-bottom: 20px;
    }
    
    .tabs {
      display: flex;
      background: var(--card-bg);
      border-radius: 16px;
      padding: 4px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .tab-btn {
      flex: 1;
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 16px;
      white-space: nowrap;
    }
    
    .tab-btn.active {
      background: var(--gradient-primary);
      color: white;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* ========== 卡片样式 ========== */
    .card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }
    
    .card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-yellow), transparent);
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card-title-icon {
      color: var(--accent-yellow);
      font-size: 20px;
    }
    
    /* ========== 交易界面样式 ========== */
    .swap-container {
      position: relative;
      padding: 2px 0;
    }
    
    .token-input-wrapper {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 12px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      position: relative;
      margin-bottom: 6px;
    }
    
    .token-input-wrapper.focused {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }
    
    .token-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      position: relative;
    }
    
    .balance-info {
      font-size: 12px;
      color: var(--text-secondary);
      transform: translateY(-4px);
    }
    
    .balance-amount {
      color: var(--accent-yellow);
      font-weight: 600;
      cursor: pointer;
    }
    
    .balance-amount:hover {
      text-decoration: underline;
    }
    
    .token-selector {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(26, 115, 232, 0.15);
      border: 1px solid rgba(26, 115, 232, 0.3);
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 100px;
       margin-bottom: -4px;
    }
    
    .token-selector:hover {
      background: rgba(26, 115, 232, 0.25);
      transform: translateY(-1px);
    }
    
    .token-logo {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 10px;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .token-symbol {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 14px;
    }
    
    .token-dropdown-arrow {
      color: var(--text-secondary);
      font-size: 10px;
    }
    
    .percentage-buttons {
      display: flex;
      gap: 4px;
      margin-top: 8px;
      margin-bottom: 12px;
      justify-content: flex-end;
    }
    
    .percent-btn {
      flex: none;
      width: 40px;
      padding: 6px;
      background: rgba(26, 115, 232, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .percent-btn:hover {
      background: rgba(26, 115, 232, 0.2);
      border-color: var(--primary-blue);
    }
    
    .percent-btn.active {
      background: var(--accent-yellow);
      color: #0f172a;
      border-color: var(--accent-yellow);
      font-weight: 700;
    }
    
    .amount-input-area {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    
    .amount-input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 24px;
      font-weight: 700;
      text-align: right;
      width: 100%;
      outline: none;
      font-family: 'SF Mono', Monaco, monospace;
      padding: 0;
    }
    
    .amount-input::placeholder {
      color: var(--text-muted);
    }

    .swap-center {
      position: relative;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: -6px 0;
      z-index: 10;
    }
    
    .swap-arrow-btn {
      background: transparent;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      color: var(--text-secondary);
      z-index: 2;
    }
    
    .swap-arrow-btn:hover {
      transform: rotate(180deg) scale(1.1);
      box-shadow: 0 6px 16px rgba(26, 115, 232, 0.4);
    }
    
    .swap-arrow-btn:active {
      transform: rotate(180deg) scale(0.95);
    }
    
    /* ========== 交易详情 ========== */
    .swap-details {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 12px 16px;
      margin: 16px 0;
      border: 1px solid var(--border-color);
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0;
      font-size: 12px;
    }
    
    .detail-row:not(:last-child) {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .detail-label {
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .detail-value {
      color: var(--text-primary);
      font-weight: 600;
      text-align: right;
      font-family: 'SF Mono', Monaco, monospace;
    }
    
    .detail-value.positive {
      color: var(--success);
    }
    
    .detail-value.negative {
      color: var(--warning);
    }
    
    /* ========== 滑点控制 ========== */
    .slippage-control {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }
    
    .slippage-options {
      display: flex;
      gap: 4px;
    }
    
    .slippage-btn {
      padding: 4px 8px;
      background: rgba(26, 115, 232, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-secondary);
      min-width: 35px;
      text-align: center;
    }
    
    .slippage-btn:hover {
      border-color: var(--primary-blue);
    }
    
    .slippage-btn.active {
      background: var(--accent-yellow);
      color: #0f172a;
      border-color: var(--accent-yellow);
      font-weight: 600;
    }
    
    /* ========== 主操作按钮 ========== */
    .main-action-btn {
      background: var(--gradient-primary);
      color: white;
      font-weight: 700;
      padding: 16px;
      border: none;
      border-radius: 16px;
      width: 100%;
      font-size: 16px;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(26, 115, 232, 0.3);
    }
    
    .main-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(26, 115, 232, 0.4);
    }
    
    .main-action-btn:active {
      transform: translateY(0);
    }
    
    .main-action-btn:disabled {
      background: #475569;
      color: var(--text-secondary);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* ========== 流动性页面样式 ========== */
    .liquidity-summary {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    
    .liquidity-pair {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .pair-logo {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .pair-logo.cfx {
      background-image: url('https://i.imgur.com/70cXbUI.jpeg');
    }
    
    .pair-logo.lom {
      background-image: url('https://i.imgur.com/HddyTrv.jpeg');
    }
    
    .pair-symbol {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .liquidity-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .stat-item {
      text-align: center;
      background: rgba(26, 115, 232, 0.05);
      border-radius: 10px;
      padding: 12px;
      border: 1px solid var(--border-color);
    }
    
    .stat-label-small {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      font-weight: 600;
    }
    
    .stat-value-large {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .stat-value-large.positive {
      color: var(--accent-yellow);
    }
    
    .position-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 16px;
    }
    
    .position-btn {
      padding: 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .add-btn {
      background: var(--gradient-primary);
      color: white;
    }
    
    .remove-btn {
      background: rgba(255, 71, 87, 0.15);
      color: var(--accent-red);
      border: 1px solid rgba(255, 71, 87, 0.3);
    }
    
    .remove-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .add-btn:hover, .remove-btn:hover:not(:disabled) {
      transform: translateY(-1px);
    }
    
    /* ========== LP挖矿页面样式优化 ========== */
    .farm-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    /* 四列统计网格 */
    .farm-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .farm-stat-card {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(26, 115, 232, 0.05));
      border-radius: 12px;
      padding: 14px 10px;
      border: 1px solid rgba(255, 215, 0, 0.2);
      text-align: center;
      transition: all 0.3s ease;
      min-height: 70px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    
    .farm-stat-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-yellow), transparent);
    }
    
    .farm-stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 215, 0, 0.15);
    }
    
    .farm-stat-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
      font-weight: 600;
    }
    
    .farm-stat-value {
      font-size: 16px;
      font-weight: 800;
      color: var(--accent-yellow);
      line-height: 1.2;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .farm-stat-desc {
      font-size: 9px;
      color: var(--text-muted);
      opacity: 0.8;
      margin-top: 4px;
    }
    
    /* 用户信息卡片优化 - 双排布局 */
    .farm-user-info {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), rgba(26, 115, 232, 0.03));
      border-radius: 16px;
      padding: 18px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
    }
    
    .farm-user-info::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-yellow), transparent);
    }
    
    .user-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      border: 2px solid var(--accent-yellow);
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
    }
    
    .user-avatar::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(26, 115, 232, 0.2));
    }
    
    .user-avatar.gold {
      border-color: #FFD700;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }
    
    .user-avatar.silver {
      border-color: #C0C0C0;
      box-shadow: 0 0 15px rgba(192, 192, 192, 0.3);
    }
    
    .user-avatar.bronze {
      border-color: #CD7F32;
      box-shadow: 0 0 15px rgba(205, 127, 50, 0.3);
    }
    
    .user-avatar.inactive {
      border-color: var(--text-secondary);
    }
    
    .user-status {
      flex: 1;
      min-width: 0;
    }
    
    .user-name {
      font-size: 16px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .user-level {
      font-size: 12px;
      color: var(--accent-yellow);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    /* 收益信息网格 - 双排布局 */
    .revenue-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .revenue-card {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 14px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      position: relative;
      overflow: hidden;
    }
    
    .revenue-card.with-button {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 100px;
    }
    
    .revenue-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-yellow), transparent);
    }
    
    .revenue-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 600;
    }
    
    .revenue-value {
      font-size: 18px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 8px;
    }
    
    .revenue-value.success {
      color: var(--success);
      text-shadow: 0 1px 2px rgba(46, 160, 67, 0.2);
    }
    
    .revenue-value.warning {
      color: var(--accent-yellow);
      text-shadow: 0 1px 2px rgba(255, 215, 0, 0.2);
    }
    
    .revenue-action-btn {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--gradient-green);
      color: white;
      margin-top: 4px;
    }
    
    .revenue-action-btn:disabled {
      background: rgba(46, 160, 67, 0.3);
      color: rgba(255, 255, 255, 0.5);
      cursor: not-allowed;
    }
    
    .revenue-action-btn:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(46, 160, 67, 0.3);
    }
    
    .revenue-sub {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
      opacity: 0.8;
    }
    
    /* 用户统计网格 - 三列布局 */
    .user-stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .user-stat-item {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      padding: 12px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .user-stat-label {
      font-size: 10px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      white-space: nowrap;
      font-weight: 600;
    }
    
    .user-stat-value {
      font-size: 16px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.2;
    }
    
    .user-stat-value.highlight {
      color: var(--accent-yellow);
      text-shadow: 0 1px 2px rgba(255, 215, 0, 0.2);
    }
    
    .user-stat-value.success {
      color: var(--success);
    }
    
    .user-stat-value.warning {
      color: var(--accent-yellow);
    }
    
    /* 同步时间显示 - 优化 */
    .countdown-display {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(26, 115, 232, 0.05));
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      text-align: center;
      margin: 12px 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 600;
    }
    
    .countdown-value {
      color: var(--accent-yellow);
      font-weight: 800;
      font-size: 14px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .countdown-label {
      color: var(--text-secondary);
      font-size: 12px;
    }
    
    /* 农场操作按钮 - 新的四列布局，模仿流动性页面 */
    .farm-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 16px;
    }
    
    .farm-action-btn {
      height: 48px;
      padding: 0 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
      min-width: 0;
      position: relative;
      overflow: hidden;
    }
    
    .farm-action-btn::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: 0.5s;
    }
    
    .farm-action-btn:hover::before {
      left: 100%;
    }
    
    /* 同步按钮更大，占据两列 */
    .farm-action-btn.sync {
      grid-column: span 2;
      height: 52px;
      font-size: 16px;
      background: var(--gradient-yellow);
      color: #0f172a;
      font-weight: 800;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    }
    
    .farm-action-btn.sync:disabled {
      background: rgba(255, 215, 0, 0.3);
      color: var(--text-secondary);
      box-shadow: none;
    }
    
    .farm-action-btn.primary {
      background: var(--gradient-primary);
      color: white;
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }
    
    .farm-action-btn.success {
      background: var(--gradient-green);
      color: white;
      border: 1px solid rgba(46, 160, 67, 0.3);
      box-shadow: 0 4px 12px rgba(46, 160, 67, 0.3);
    }
    
    .farm-action-btn.warning {
      background: var(--gradient-yellow);
      color: #0f172a;
      font-weight: 800;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    }
    
    .farm-action-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none;
    }
    
    .farm-action-btn:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    .farm-action-btn:not(:disabled):active {
      transform: translateY(0);
    }
    
    .farm-btn-icon {
      font-size: 16px;
      flex-shrink: 0;
    }
    
    .farm-btn-text {
      flex: 1;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 13px;
    }
    
    /* 操作状态提示 */
    .action-status {
      font-size: 11px;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      text-align: center;
      display: none;
      font-weight: 600;
    }
    
    .action-status.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    .action-status.error {
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), rgba(255, 71, 87, 0.05));
      color: var(--accent-red);
      border: 1px solid rgba(255, 71, 87, 0.2);
    }
    
    .action-status.success {
      background: linear-gradient(135deg, rgba(46, 160, 67, 0.1), rgba(46, 160, 67, 0.05));
      color: var(--success);
      border: 1px solid rgba(46, 160, 67, 0.2);
    }
    
    .action-status.info {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
      color: var(--accent-yellow);
      border: 1px solid rgba(255, 215, 0, 0.2);
    }
    
    /* 状态指示器 */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
      margin-left: 6px;
    }
    
    .status-active {
      background: linear-gradient(135deg, rgba(46, 160, 67, 0.2), rgba(46, 160, 67, 0.1));
      color: var(--success);
      border: 1px solid rgba(46, 160, 67, 0.3);
    }
    
    .status-inactive {
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.2), rgba(255, 71, 87, 0.1));
      color: var(--accent-red);
      border: 1px solid rgba(255, 71, 87, 0.3);
    }
    
    .status-waiting {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
      color: var(--accent-yellow);
      border: 1px solid rgba(255, 215, 0, 0.3);
    }
    
    /* 时间显示优化 */
    .time-display {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      background: rgba(255, 215, 0, 0.1);
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      color: var(--accent-yellow);
    }
    
    /* ========== 模态框样式 ========== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(13, 17, 23, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease-out;
    }
    
    .modal-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      border: 1px solid var(--border-color);
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease-out;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .modal-input-group {
      margin-bottom: 12px;
    }
    
    .modal-input-label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    
    .modal-input {
      width: 100%;
      padding: 12px 14px;
      background: rgba(26, 115, 232, 0.05);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
      transition: all 0.2s ease;
    }
    
    .modal-input:focus {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .modal-btn.cancel {
      background: var(--card-bg);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }
    
    .modal-btn.confirm {
      background: var(--gradient-primary);
      color: white;
    }
    
    /* ========== 代币选择器 ========== */
    .token-selector-modal {
      position: fixed;
      inset: 0;
      background: rgba(13, 17, 23, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease-out;
    }
    
    .token-selector-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      border: 1px solid var(--border-color);
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease-out;
    }
    
    .token-search {
      width: 100%;
      padding: 10px 14px;
      background: rgba(26, 115, 232, 0.05);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 14px;
      margin-bottom: 12px;
      outline: none;
      transition: all 0.2s ease;
    }
    
    .token-search:focus {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }
    
    .token-search:hover {
      border-color: var(--accent-yellow);
    }
    
    .token-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .token-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .token-item:hover {
      background: rgba(26, 115, 232, 0.1);
      transform: translateX(4px);
    }
    
    .token-item-logo {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 2px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.2s ease;
    }
    
    .token-item:hover .token-item-logo {
      transform: scale(1.1);
    }
    
    .token-item-info {
      flex: 1;
      min-width: 0;
    }
    
    .token-item-symbol {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: color 0.2s ease;
    }
    
    .token-item:hover .token-item-symbol {
      color: var(--accent-yellow);
    }
    
    .token-item-name {
      font-size: 11px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .token-item-balance {
      font-size: 13px;
      color: var(--text-primary);
      font-weight: 600;
      min-width: 60px;
      text-align: right;
    }
    
    /* ========== 交易状态提示 ========== */
    .transaction-status {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--gradient-primary);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 8px 24px rgba(26, 115, 232, 0.4);
      z-index: 3000;
      transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      max-width: 90%;
      text-align: center;
    }
    
    .transaction-status.show {
      transform: translateX(-50%) translateY(0);
    }
    
    .transaction-status.success {
      background: var(--gradient-green);
    }
    
    .transaction-status.error {
      background: var(--gradient-red);
    }
    
    /* ========== 风险提示和页脚 ========== */
    .risk-warning {
      background: var(--gradient-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 16px;
      margin: 16px 0;
      text-align: center;
      font-size: 11px;
      color: var(--text-primary);
      line-height: 1.5;
      position: relative;
      overflow: hidden;
    }
    
    .risk-title {
      font-weight: 700;
      margin-bottom: 6px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      color: var(--accent-yellow);
    }
    
    .footer {
      text-align: center;
      padding: 16px 0;
      color: var(--text-secondary);
      font-size: 12px;
      opacity: 0.7;
    }
    
    /* ========== 动画 ========== */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ========== 加载动画 ========== */
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid rgba(26, 115, 232, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-blue);
      animation: spin 1s linear infinite;
    }
    
    .loading-spinner.small {
      width: 20px;
      height: 20px;
      border-width: 2px;
    }
    
    .loading-spinner.white {
      border-color: rgba(255, 255, 255, 0.3);
      border-top-color: white;
    }
    
    /* ========== 移除流动性弹窗 ========== */
    .remove-liquidity-modal .modal-content {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .remove-percentage {
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      color: var(--text-primary);
      margin: 8px 0;
    }
    
    .percentage-slider {
      width: 100%;
      margin: 16px 0;
      -webkit-appearance: none;
      height: 6px;
      background: rgba(26, 115, 232, 0.1);
      border-radius: 3px;
      outline: none;
    }
    
    .percentage-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--gradient-primary);
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(26, 115, 232, 0.3);
    }
    
    .percentage-options {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }
    
    .percentage-option {
      padding: 8px;
      text-align: center;
      background: rgba(26, 115, 232, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-secondary);
      font-size: 12px;
    }
    
    .percentage-option:hover {
      border-color: var(--primary-blue);
    }
    
    .percentage-option.active {
      background: var(--accent-yellow);
      color: #0f172a;
      border-color: var(--accent-yellow);
      font-weight: 600;
    }
    
    .remove-estimate {
      background: rgba(26, 115, 232, 0.1);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      border: 1px solid var(--border-color);
    }
    
    .remove-estimate-title {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }
    
    .remove-estimate-amounts {
      font-size: 16px;
      font-weight: bold;
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .remove-estimate-amount {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    
    .token-amount-display {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 15px;
    }
    
    /* ========== 简单确认对话框 ========== */
    .simple-confirm-modal .modal-card {
      max-width: 350px;
    }
    
    .confirm-summary {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
      border: 1px solid var(--border-color);
    }
    
    .confirm-icon {
      font-size: 48px;
      margin-bottom: 12px;
      display: block;
    }
    
    .confirm-action {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .confirm-amounts {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 16px 0;
    }
    
    .confirm-amount-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    
    .confirm-amount-logo {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .confirm-amount-text {
      font-size: 20px;
      font-weight: bold;
      color: var(--text-primary);
      font-family: 'SF Mono', Monaco, monospace;
    }
    
    .confirm-details-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 16px;
    }
    
    .confirm-detail-item {
      text-align: left;
      padding: 8px;
      background: rgba(26, 115, 232, 0.05);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }
    
    .confirm-detail-label {
      font-size: 10px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .confirm-detail-value {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .confirm-actions-simple {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .confirm-action-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
    }
    
    .confirm-action-btn.cancel {
      background: var(--card-bg);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }
    
    .confirm-action-btn.confirm {
      background: var(--gradient-primary);
      color: white;
    }
    
    .confirm-action-btn.confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }
    
    .confirm-action-btn.cancel:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    /* ========== 交易状态提示 ========== */
    .tx-status-overlay {
      position: fixed;
      inset: 0;
      background: rgba(13, 17, 23, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease-out;
    }
    
    .tx-status-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      max-width: 350px;
      text-align: center;
      border: 1px solid var(--border-color);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease-out;
    }
    
    .tx-status-icon {
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .tx-status-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .tx-status-message {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .tx-status-done-btn {
      background: var(--gradient-primary);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
    }
    
    .tx-status-done-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }
    
    /* ========== 错误提示框 ========== */
    .error-box {
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), rgba(255, 71, 87, 0.05));
      border: 1px solid var(--accent-red);
      border-radius: 10px;
      padding: 10px 14px;
      margin: 10px 0;
      font-size: 12px;
      color: var(--accent-red);
      display: none;
    }
    
    .error-box.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    .error-icon {
      display: inline-block;
      margin-right: 6px;
    }
    
    /* ========== 等级徽章样式 ========== */
    .level-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      border: 2px solid;
    }
    
    .level-bronze {
      background: var(--gradient-bronze);
      color: white;
      border-color: #8B4513;
    }
    
    .level-silver {
      background: var(--gradient-silver);
      color: white;
      border-color: #808080;
    }
    
    .level-gold {
      background: var(--gradient-gold);
      color: #000;
      border-color: #FFA500;
    }
    
    /* ========== 进度条样式 ========== */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--gradient-yellow);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    /* ========== 响应式调整 ========== */
    @media (max-width: 480px) {
      .app {
        padding: 0;
      }
      
      .card {
        margin: 10px;
        padding: 14px;
      }
      
      .header {
        padding: 10px;
        margin-bottom: 16px;
      }
      
      .logo-img {
        width: 44px;
        height: 44px;
      }
      
      .logo-text {
        font-size: 18px;
      }
      
      .header-buttons {
        min-width: 150px;
        max-width: 180px;
      }
      
      #walletBtn {
        min-width: 120px;
        max-width: 140px;
        padding: 8px 12px;
        font-size: 12px;
        height: 36px;
      }
      
      #langBtn {
        width: 36px;
        height: 36px;
        min-width: 36px;
        min-height: 36px;
        max-width: 36px;
        max-height: 36px;
        font-size: 12px;
      }
      
      .tab-btn {
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .modal-card {
        padding: 16px;
      }
      
      .transaction-status {
        bottom: 60px;
      }
      
      .farm-stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .farm-stat-card {
        padding: 12px 8px;
        min-height: 60px;
      }
      
      .farm-stat-label {
        font-size: 10px;
      }
      
      .farm-stat-value {
        font-size: 14px;
      }
      
      .revenue-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .user-stats-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }
      
      .revenue-card {
        padding: 12px;
        min-height: 90px;
      }
      
      .revenue-value {
        font-size: 16px;
      }
      
      .revenue-action-btn {
        padding: 6px 10px;
        font-size: 11px;
      }
      
      .farm-actions {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .farm-action-btn {
        height: 44px;
        font-size: 13px;
      }
      
      .farm-action-btn.sync {
        height: 48px;
        font-size: 15px;
      }
      
      .farm-btn-text {
        font-size: 12px;
      }
      
      .user-avatar {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .user-name {
        font-size: 14px;
      }
      
      .user-level {
        font-size: 11px;
      }
      
      .project-intro-card {
        padding: 20px;
      }
      
      .project-intro-title {
        font-size: 24px;
      }
      
      .project-intro-features {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 380px) {
      .logo-text {
        font-size: 16px;
      }
      
      .logo-img {
        width: 36px;
        height: 36px;
      }
      
      .header-buttons {
        min-width: 130px;
        max-width: 150px;
      }
      
      #walletBtn {
        min-width: 100px;
        max-width: 120px;
        font-size: 11px;
        padding: 6px 10px;
      }
      
      #langBtn {
        width: 32px;
        height: 32px;
        min-width: 32px;
        min-height: 32px;
        max-width: 32px;
        max-height: 32px;
      }
      
      .farm-stats-grid {
        grid-template-columns: 1fr;
      }
      
      .revenue-grid {
        grid-template-columns: 1fr;
      }
      
      .user-stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .farm-actions {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 350px) {
      .farm-actions {
        grid-template-columns: 1fr;
        gap: 6px;
      }
      
      .farm-action-btn.sync {
        grid-column: span 1;
      }
      
      .user-stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- 项目介绍弹窗 -->
  <div class="project-intro-overlay" id="projectIntroOverlay">
    <div class="project-intro-card">
      <button class="project-intro-close-btn" id="projectIntroCloseBtn">×</button>
      
      <div class="project-intro-header">
        <div class="project-intro-logo"></div>
        <h1 class="project-intro-title">龙脉 LOM</h1>
        <div class="project-intro-subtitle">Conflux生态核心资产</div>
        <div class="project-intro-slogan">共识创造价值</div>
      </div>
      
      <div class="project-intro-content">
        <div class="project-intro-section">
          <div class="project-intro-section-title">
            <span class="project-intro-section-icon">🐉</span>
            <span>关于龙脉LOM</span>
          </div>
          <div class="project-intro-section-content">
            <p>龙脉LOM灵感源自中国传统文化中的"龙脉"概念，象征着财富、繁荣和能量的流动。是深度赋能中国唯一合规公链——树图（Conflux）的生态核心资产，更是链接公链价值、用户收益与生态繁荣的关键纽带，依托公链优势构建专属价值闭环，为参与者带来确定性回报。</p>
            <p>作为树图公链的赋能载体，LOM深度绑定公链核心优势：这条由清华团队打造的"conflux数字龙脉"，以合规为根，串联40国节点与"一带一路"跨境场景，更兼容以太坊生态。从RWA资产上链到稳定币结算，它正以自主可控的技术底气，承接全球Web3.0爆发浪潮，让中国公链力量贯通数字未来。</p>
            <p>其核心价值聚焦锁定质押+二代奖励的生态激励机制，精准匹配树图公链发展需求：用户通过锁定LOM参与质押，不仅能深度享受树图公链生态扩张、技术升级带来的长期质押收益，更能依托"赋能公链"的核心定位，通过邀请分享解锁丰厚二代奖励，让收益随生态辐射持续放大。</p>
            <ul>
              <li><strong>总供应量</strong>：88,888,888枚（永不增发）</li>
              <li><strong>底层技术</strong>：基于Conflux eSpace智能合约</li>
              <li><strong>治理模式</strong>：完全去中心化，社区驱动</li>
              <li><strong>经济模型</strong>：通缩机制 + 流动性激励</li>
            </ul>
          </div>
        </div>
        
        <div class="project-intro-features">
          <div class="project-intro-feature">
            <span class="project-intro-feature-icon">⚡</span>
            <div class="project-intro-feature-text">总量稀缺</div>
          </div>
          <div class="project-intro-feature">
            <span class="project-intro-feature-icon">🛡️</span>
            <div class="project-intro-feature-text">去中心化</div>
          </div>
          <div class="project-intro-feature">
            <span class="project-intro-feature-icon">📈</span>
            <div class="project-intro-feature-text">高收益率</div>
          </div>
          <div class="project-intro-feature">
            <span class="project-intro-feature-icon">🌐</span>
            <div class="project-intro-feature-text">全球交易</div>
          </div>
        </div>
        
        <div class="project-intro-section">
          <div class="project-intro-section-title">
            <span class="project-intro-section-icon">🎯</span>
            <span>核心价值</span>
          </div>
          <div class="project-intro-section-content">
            <ul>
              <li><strong>价值存储</strong>：深度绑定公链价值确保价值增长</li>
              <li><strong>流动性核心</strong>：作为DEX交易对的基准资产</li>
              <li><strong>治理权益</strong>：持有者共同参与生态治理决策</li>
              <li><strong>收益生成</strong>：通过质押和流动性挖矿获得收益</li>
            </ul>
          </div>
        </div>
        
        <div class="project-intro-section">
          <div class="project-intro-section-title">
            <span class="project-intro-section-icon">🚀</span>
            <span>LOMswap功能</span>
          </div>
          <div class="project-intro-section-content">
            <p>在LOMswap上，您可以：</p>
            <ul>
              <li><strong>兑换交易</strong>：在CFX-LOM-USDC-USDT0-AxCNH之间快速兑换</li>
              <li><strong>提供流动性</strong>：添加CFX-LOM流动性赚取手续费</li>
              <li><strong>LP质押挖矿</strong>：质押LP代币获得LOM奖励</li>
              <li><strong>每日签到</strong>：每日签到获得额外奖励</li>
            </ul>
          </div>
        </div>
      </div>
      
      <div class="project-intro-footer">
        <div class="project-intro-footer-text">
          💡 提示：请确保已安装TP或web3钱包，并切换到Conflux eSpace网络（ChainID: 1030）
        </div>
      </div>
    </div>
  </div>

  <!-- 原有应用界面 -->
  <div class="app">
    <!-- 头部 -->
    <div class="header">
      <div class="logo-container" id="logoContainer">
        <div class="logo-img"></div>
        <div class="logo-text">LOMswap</div>
      </div>
      <div class="header-buttons">
        <button class="btn" id="langBtn">EN</button>
        <button class="btn" id="walletBtn">连接钱包</button>
      </div>
    </div>

    <!-- 标签页 -->
    <div class="tab-container">
      <div class="tabs">
        <button class="tab-btn active" data-tab="swap">兑换</button>
        <button class="tab-btn" data-tab="liquidity">流动性</button>
        <button class="tab-btn" data-tab="farm">LP挖矿</button>
      </div>
    </div>

    <!-- 兑换页面 -->
    <div class="tab-content active" id="swapTab">
      <div class="card">
        <div class="swap-container">
          <!-- 输入代币 -->
          <div class="token-input-wrapper" id="fromTokenWrapper">
            <div class="token-header">
              <div class="balance-info">
                余额: <span class="balance-amount" id="fromBal">0</span>
              </div>
              <div class="token-selector" id="fromTokenSelector">
                <div class="token-logo" id="fromTokenLogo" style="background-image: url('https://i.imgur.com/70cXbUI.jpeg');"></div>
                <div class="token-symbol" id="fromTokenSymbol">CFX</div>
                <div class="token-dropdown-arrow">▼</div>
              </div>
            </div>
            
            <div class="percentage-buttons">
              <button class="percent-btn" data-percent="0.25">25%</button>
              <button class="percent-btn" data-percent="0.5">50%</button>
              <button class="percent-btn" data-percent="1">MAX</button>
            </div>
            
            <div class="amount-input-area">
              <input class="amount-input" id="fromAmount" placeholder="0" type="number" min="0" step="any">
            </div>
          </div>

          <!-- 交换箭头 -->
          <div class="swap-center">
            <button class="swap-arrow-btn" id="reverse">🔃</button>
          </div>

          <!-- 输出代币 -->
          <div class="token-input-wrapper" id="toTokenWrapper">
            <div class="token-header">
              <div class="balance-info">
                余额: <span class="balance-amount" id="toBal">0</span>
              </div>
              <div class="token-selector" id="toTokenSelector">
                <div class="token-logo" id="toTokenLogo" style="background-image: url('https://i.imgur.com/HddyTrv.jpeg');"></div>
                <div class="token-symbol" id="toTokenSymbol">LOM</div>
                <div class="token-dropdown-arrow">▼</div>
              </div>
            </div>
            
            <div class="amount-input-area">
              <input class="amount-input" id="toAmount" placeholder="0" type="number" min="0" step="any" readonly>
            </div>
          </div>

          <!-- 错误提示框 -->
          <div class="error-box" id="swapErrorBox">
            <span class="error-icon">⚠️</span>
            <span id="swapErrorText"></span>
          </div>

          <!-- 交易详情 -->
          <div class="swap-details">
            <div class="detail-row">
              <span class="detail-label">滑点容差</span>
              <div class="slippage-options">
                <button class="slippage-btn active" data-slip="0.1">0.1%</button>
                <button class="slippage-btn" data-slip="0.5">0.5%</button>
                <button class="slippage-btn" data-slip="5">5%</button>
                <button class="slippage-btn" data-slip="10">10%</button>
              </div>
            </div>
            <div class="detail-row">
              <span class="detail-label">价格</span>
              <span class="detail-value" id="price">1 CFX = 0 LOM</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">最低收到</span>
              <span class="detail-value" id="minReceived">0 LOM</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">路由</span>
              <span class="detail-value" id="routeInfo">CFX → LOM</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">价格影响</span>
              <span class="detail-value positive" id="priceImpact">< 0.01%</span>
            </div>
          </div>

          <!-- 交易按钮 -->
          <button class="main-action-btn" id="swapBtn">连接钱包</button>
        </div>
      </div>
    </div>
    
    <!-- 流动性页面 -->
    <div class="tab-content" id="liquidityTab">
      <div class="card">
        <div class="card-title">
          <span class="card-title-icon">💧</span>
          <span id="poolInfoTitle">CFX-LOM 池</span>
        </div>

        <div class="liquidity-summary">
          <!-- 池子统计信息 -->
          <div class="liquidity-pair">
            <div class="pair-logo cfx"></div>
            <div class="pair-symbol">+</div>
            <div class="pair-logo lom"></div>
            <div class="pair-symbol">CFX-LOM</div>
          </div>
          
          <div class="liquidity-stats">
            <div class="stat-item">
              <div class="stat-label-small" id="cfxReserveLabel">CFX 储备</div>
              <div class="stat-value-large" id="cfxReserve">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label-small" id="lomReserveLabel">LOM 储备</div>
              <div class="stat-value-large" id="lomReserve">0</div>
            </div>
          </div>
          
          <!-- 我的流动池详情 -->
          <div class="user-position" style="background: var(--gradient-card); border-radius: 12px; padding: 16px; margin-top: 16px; border: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);" id="myPositionTitle">我的流动池</div>
              <div style="font-size: 12px; color: var(--text-secondary);" id="positionValue">$0.00</div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <div style="text-align: center;">
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;" id="myCfxLabel">我的CFX</div>
                <div style="font-size: 16px; font-weight: 700; color: var(--accent-yellow);" id="userCfx">0</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;" id="myLomLabel">我的LOM</div>
                <div style="font-size: 16px; font-weight: 700; color: var(--accent-yellow);" id="userLom">0</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;" id="myLpLabel">我的LP代币</div>
                <div style="font-size: 16px; font-weight: 700; color: var(--text-primary);" id="userLp">0</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;" id="myShareLabel">池子份额</div>
                <div style="font-size: 16px; font-weight: 700; color: var(--success);" id="userPoolShare">0%</div>
              </div>
            </div>
          </div>

          <div class="position-actions">
            <button class="position-btn add-btn" id="addBtn">添加流动性</button>
            <button class="position-btn remove-btn" id="removeBtn" disabled>移除流动性</button>
          </div>
        </div>
      </div>
    </div>

    <!-- LP挖矿页面优化版 -->
    <div class="tab-content" id="farmTab">
      <div class="card">
        <div class="card-title">
          <span class="card-title-icon">🚜</span>
          <span id="farmTitle">LP挖矿农场</span>
        </div>

        <div class="farm-panel">
          <!-- 农场统计网格 -->
          <div class="farm-stats-grid">
            <div class="farm-stat-card">
              <div class="farm-stat-label">🏆 总奖励池</div>
              <div class="farm-stat-value" id="totalRewardPool">-- LOM</div>
              <div class="farm-stat-desc">全部可用于奖励</div>
            </div>
            
            <div class="farm-stat-card">
              <div class="farm-stat-label">⏳ 剩余奖励</div>
              <div class="farm-stat-value warning" id="remainingRewards">-- LOM</div>
              <div class="farm-stat-desc">待分配奖励</div>
            </div>
          </div>

          <!-- 用户信息卡片 -->
          <div class="farm-user-info">
            <div class="user-header">
              <div class="user-avatar" id="userAvatar">👤</div>
              <div class="user-status">
                <div class="user-name" id="userName">未连接钱包</div>
                <div class="user-level" id="userLevel">请连接钱包查看数据</div>
              </div>
            </div>
            
            <!-- 收益信息网格 - 双排布局 -->
            <div class="revenue-grid">
              <div class="revenue-card">
                <div class="revenue-label">📊 日收益率</div>
                <div class="revenue-value warning" id="dailyRewardRate">--%</div>
                <div class="revenue-sub">每日奖励比例</div>
              </div>
              
              <div class="revenue-card">
                <div class="revenue-label">💎 已领取收益</div>
                <div class="revenue-value success" id="totalEarned">-- LOM</div>
                <div class="revenue-sub">累计已领取</div>
              </div>
              
              <!-- 待领取收益卡片 - 包含领取按钮 -->
              <div class="revenue-card with-button">
                <div class="revenue-label">🎁 待领取收益</div>
                <div class="revenue-value warning" id="pendingRewards">-- LOM</div>
                <button class="revenue-action-btn" id="claimInCardBtn" disabled>
                  领取奖励
                </button>
              </div>
              
              <div class="revenue-card">
                <div class="revenue-label">📈 日收益预估</div>
                <div class="revenue-value" id="dailyEstimate">-- LOM</div>
                <div class="revenue-sub">基于当前质押</div>
              </div>
            </div>
            
            <!-- 用户统计网格 -->
            <div class="user-stats-grid">
              <div class="user-stat-item">
                <div class="user-stat-label">💧 LP余额</div>
                <div class="user-stat-value highlight" id="lpBalance">--</div>
              </div>
              <div class="user-stat-item">
                <div class="user-stat-label">⭐ 活动分数</div>
                <div class="user-stat-value" id="activityScore">--</div>
              </div>
              <div class="user-stat-item">
                <div class="user-stat-label">📅 连续天数</div>
                <div class="user-stat-value" id="consecutiveDays">--</div>
              </div>
            </div>
            
            <!-- 同步时间显示 -->
            <div class="countdown-display">
              <span class="countdown-label">下次同步:</span>
              <span class="countdown-value" id="nextSyncTime">--</span>
            </div>
            
            <!-- 操作状态提示 -->
            <div class="action-status" id="actionStatus"></div>
          </div>

          <!-- 农场操作按钮 - 类似流动性页面布局 -->
          <div class="farm-actions">
            <button class="farm-action-btn primary" id="activateBtn">
              <span class="farm-btn-icon">✅</span>
              <span class="farm-btn-text" id="activateBtnText">激活账户</span>
            </button>
            
            <button class="farm-action-btn sync" id="syncBtn" disabled>
              <span class="farm-btn-icon">🔄</span>
              <span class="farm-btn-text" id="syncBtnText">同步奖励</span>
            </button>
            
            <button class="farm-action-btn warning" id="checkinBtn" disabled>
              <span class="farm-btn-icon">📅</span>
              <span class="farm-btn-text" id="checkinBtnText">每日签到</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 风险提示 -->
    <div class="risk-warning" id="riskWarning">
      <div class="risk-title">
        <span>⚠️</span>
        <span id="riskTitle">风险提示</span>
      </div>
      <div id="riskText">
        本应用仅作为技术演示，不构成任何投资建议。加密货币市场波动巨大，投资需谨慎，请理性对待数字资产交易。
      </div>
    </div>

    <!-- 页脚 -->
    <div class="footer" id="footerText">LOMswap · Conflux eSpace</div>
  </div>

  <!-- 代币选择器模态框 -->
  <div class="token-selector-modal" id="tokenSelectorModal">
    <div class="token-selector-card">
      <h3 class="modal-title" id="tokenSelectorTitle">选择代币</h3>
      <input type="text" class="token-search" id="tokenSearch" placeholder="搜索代币名称或地址">
      <div class="token-list" id="tokenList">
        <!-- 代币列表将通过JS动态生成 -->
      </div>
    </div>
  </div>

  <!-- 添加流动性模态框 -->
  <div class="modal-overlay" id="addModal">
    <div class="modal-card">
      <h3 class="modal-title" id="addTitle">添加流动性</h3>
      
      <div class="modal-input-group">
        <label class="modal-input-label">CFX 数量</label>
        <div style="display: flex; gap: 8px;">
          <input type="number" class="modal-input" id="addCfx" placeholder="0" step="any" min="0">
          <button class="btn" id="cfxMaxBtn" style="height: auto; padding: 8px 12px; min-width: 50px; font-size: 12px;">MAX</button>
        </div>
        <div style="text-align: right; margin-top: 4px; font-size: 11px; color: var(--text-secondary);">
          余额: <span id="addCfxBal">0</span> CFX
        </div>
      </div>
      
      <div style="text-align: center; font-size: 20px; color: var(--text-primary); margin: 12px 0;">+</div>
      
      <div class="modal-input-group">
        <label class="modal-input-label">LOM 数量</label>
        <div style="display: flex; gap: 8px;">
          <input type="number" class="modal-input" id="addLom" placeholder="0" step="any" min="0">
          <button class="btn" id="lomMaxBtn" style="height: auto; padding: 8px 12px; min-width: 50px; font-size: 12px;">MAX</button>
        </div>
        <div style="text-align: right; margin-top: 4px; font-size: 11px; color: var(--text-secondary);">
          余额: <span id="addLomBal">0</span> LOM
        </div>
      </div>
      
      <div style="background: rgba(26, 115, 232, 0.1); border-radius: 10px; padding: 10px; margin: 12px 0; text-align: center;">
        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">比例</div>
        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); word-break: break-all;" id="addRatio">1 CFX = 0 LOM</div>
      </div>
      
      <div class="modal-actions">
        <button class="modal-btn cancel" id="cancelAddBtn">取消</button>
        <button class="modal-btn confirm" id="confirmAddBtn" disabled>确认添加</button>
      </div>
    </div>
  </div>

  <!-- 移除流动性模态框 -->
  <div class="modal-overlay remove-liquidity-modal" id="removeModal">
    <div class="modal-card">
      <h3 class="modal-title" id="removeTitle">移除流动性</h3>
      
      <div class="modal-content">
        <div class="remove-percentage">
          <span id="removePercent">100%</span>
        </div>
        
        <input type="range" min="0" max="100" value="100" step="1" class="percentage-slider" id="removeSlider">
        
        <div class="percentage-options">
          <div class="percentage-option" data-percent="25">25%</div>
          <div class="percentage-option" data-percent="50">50%</div>
          <div class="percentage-option" data-percent="75">75%</div>
          <div class="percentage-option active" data-percent="100">100%</div>
        </div>
        
        <div class="remove-estimate">
          <div class="remove-estimate-title">预计获得</div>
          <div class="remove-estimate-amounts">
            <div class="remove-estimate-amount">
              <span class="token-amount-display" id="removeEstCfx">0</span> CFX
            </div>
            <div class="remove-estimate-amount">
              <span class="token-amount-display" id="removeEstLom">0</span> LOM
            </div>
          </div>
        </div>
        
        <div class="modal-actions">
          <button class="modal-btn cancel" id="cancelRemoveBtn">取消</button>
          <button class="modal-btn confirm" id="confirmRemoveBtn" style="background: var(--gradient-red);">确认移除</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 简单交易确认模态框 -->
  <div class="modal-overlay simple-confirm-modal" id="simpleConfirmModal">
    <div class="modal-card">
      <div class="confirm-summary">
        <div class="confirm-icon" id="simpleConfirmIcon">🔄</div>
        <div class="confirm-action" id="simpleConfirmAction">兑换确认</div>
        <div class="confirm-amounts" id="simpleConfirmAmounts">
          <!-- 金额信息由JS动态生成 -->
        </div>
        <div class="confirm-details-grid" id="simpleConfirmDetails">
          <!-- 详细信息由JS动态生成 -->
        </div>
      </div>
      <div class="confirm-actions-simple">
        <button class="confirm-action-btn cancel" id="simpleCancelBtn">取消</button>
        <button class="confirm-action-btn confirm" id="simpleConfirmBtn">确认交易</button>
      </div>
    </div>
  </div>

  <!-- 交易状态提示 -->
  <div class="tx-status-overlay" id="txStatusOverlay">
    <div class="tx-status-card">
      <div class="tx-status-icon" id="txStatusIcon">
        <div class="loading-spinner white"></div>
      </div>
      <div class="tx-status-title" id="txStatusTitle">交易处理中</div>
      <div class="tx-status-message" id="txStatusMessage">请等待区块链确认...</div>
      <button class="tx-status-done-btn" id="txStatusDoneBtn" style="display:none;">完成</button>
    </div>
  </div>

  <!-- 农场确认对话框 -->
  <div class="modal-overlay simple-confirm-modal" id="farmConfirmModal">
    <div class="modal-card">
      <div class="confirm-summary">
        <div class="confirm-icon" id="farmConfirmIcon">🚜</div>
        <div class="confirm-action" id="farmConfirmAction">农场操作确认</div>
        <div class="confirm-amounts" id="farmConfirmAmounts">
          <!-- 金额信息由JS动态生成 -->
        </div>
        <div class="confirm-details-grid" id="farmConfirmDetails">
          <!-- 详细信息由JS动态生成 -->
        </div>
      </div>
      <div class="confirm-actions-simple">
        <button class="confirm-action-btn cancel" id="farmCancelBtn">取消</button>
        <button class="confirm-action-btn confirm" id="farmConfirmBtn">确认操作</button>
      </div>
    </div>
  </div>

  <script>
    'use strict';

    // ==================== 项目介绍弹窗功能 ====================
    document.addEventListener('DOMContentLoaded', function() {
      const logoContainer = document.getElementById('logoContainer');
      const projectIntroOverlay = document.getElementById('projectIntroOverlay');
      const projectIntroCloseBtn = document.getElementById('projectIntroCloseBtn');
      
      // 点击Logo显示项目介绍弹窗
      logoContainer.addEventListener('click', function() {
        projectIntroOverlay.classList.add('show');
      });
      
      // 点击关闭按钮关闭弹窗
      projectIntroCloseBtn.addEventListener('click', function() {
        projectIntroOverlay.classList.remove('show');
      });
      
      // 点击弹窗外部关闭
      projectIntroOverlay.addEventListener('click', function(e) {
        if (e.target === projectIntroOverlay) {
          projectIntroOverlay.classList.remove('show');
        }
      });
      
      // 按ESC键关闭
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && projectIntroOverlay.classList.contains('show')) {
          projectIntroOverlay.classList.remove('show');
        }
      });
    });

// ==================== 统一配置 ====================
const APP_CONFIG = {
  CONTRACTS: {
    ROUTER: "0x62b0873055bf896dd869e172119871ac24aea305",
    LOM: "0xb4ca1cb2651a822bf65c614c880a26fd124932a3",
    WCFX: "0x14b2d3bc65e74dae1030eafd8ac30c533c976a9b",
    PAIR: "0x063128f4e6BDFBC693d03649000B6E4dA00Bec85",
    USDC: "0x6963efed0ab40f6c3d7bda44a05dcf1437c44372",
    AXCNH: "0x70BFD7F7eADF9b9827541272589A6B2Bb760aE2E",
    USDT0: "0xaf37e8b6c9ed7f6318979f56fc287d76c30847ff",
    CNHT0: "0xDEd1660192d4d82e7c0B628ba556861EdBB5CAda",
    AXCNH_USDT0_PAIR: "0x50b095DF7a8f856C6fA07fF89bcBC2dF8491A8df",
    LP_REWARD_FARM: "0xD1a50fB7DbDE52a180Ab6Dc83a6969869259D32a"
  },
  TOKEN_LOGOS: {
    CFX: "https://i.imgur.com/70cXbUI.jpeg",
    LOM: "https://i.imgur.com/HddyTrv.jpeg",
    USDC: "https://i.imgur.com/9UDXcUF.jpeg",
    AXCNH: "https://i.imgur.com/x8317um.jpeg",
    USDT0: "https://i.imgur.com/KgnTsn1.jpeg",
    CNHT0: "https://i.imgur.com/zObg9RY.jpeg"
  },
  CHAIN_ID: 1030
};

// ==================== LP奖励农场 ABI ====================
const LP_REWARD_FARM_ABI = [
  // 构造函数
  {"inputs":[{"internalType":"address","name":"_lpToken","type":"address"},{"internalType":"address","name":"_rewardToken","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
  
  // 用户操作
  "function activate()",
  "function sync() returns (uint256 totalReward)",
  "function claimLOMRewards()",
  "function dailyCheckIn()",
  
  // 信息查询
  "function getPoolInfo() view returns (uint256 totalUsers, uint256 lomDeposited, uint256 lomDistributed, uint256 lomRemaining, uint256 currentDailyRate, uint256 currentDailyLimit, bool isActive, bool isPaused)",
  "function getUserInfo(address userAddr) view returns (uint256 currentBalance, uint256 pendingLOMRewards, uint256 activityScore, string memory level, uint256 consecutiveDays, uint256 nextSyncAvailable, uint256 dailyLOMLeft, bool canCheckInToday)",
  "function getLOMPoolStatus() view returns (uint256 maxSupply, uint256 totalDeposited, uint256 totalDistributed, uint256 remaining, uint256 depositProgress, uint256 distributionProgress, uint256 estimatedDaysLeft, string memory status)",
  "function getPendingRewardsEstimate(address userAddr) view returns (uint256 safeRewards, uint256 optimisticRewards, bool estimateValid)",
  "function getSecurityStatus() view returns (bool isAdminSet, address currentAdmin, uint256 lomContractBalance, uint256 excessLOM)",
  
  // 用户数据
  "function users(address) view returns (uint256 lastSyncTime, uint256 lastCheckInTime, uint256 firstJoinTime, uint256 lastRewardDay, uint256 activityScore, uint256 consecutiveDays, uint256 totalSyncs, uint8 level, bool isActive)",
  "function userRewards(address) view returns (uint256 accumulatedLOM, uint256 totalLOMEarned, uint256 dailyLOMEarned, uint256 lastRewardDay)",
  
  // 池子信息
  "function totalLOMDeposited() view returns (uint256)",
  "function totalLOMDistributed() view returns (uint256)",
  "function remainingLOM() view returns (uint256)",
  "function totalActiveUsers() view returns (uint256)",
  "function farmingActive() view returns (bool)",
  "function paused() view returns (bool)",
  
  // 参数查询
  "function DAILY_CHECKIN_BONUS() view returns (uint256)",
  "function LOM_DECIMALS() view returns (uint256)",
  "function MAX_LOM_SUPPLY() view returns (uint256)",
  "function SYNC_ACTIVITY_POINTS() view returns (uint256)",
  "function SYNC_BONUS_RATE() view returns (uint256)",
  "function admin() view returns (address)",
  "function dailyRewardRate() view returns (uint256)",
  "function firstDepositTime() view returns (uint256)",
  "function lpToken() view returns (address)",
  "function maxDailyLOMPerUser() view returns (uint256)",
  "function minSyncInterval() view returns (uint256)",
  "function rewardToken() view returns (address)"
];

// ==================== 应用状态 ====================
let provider, signer, account, router, pair, lom, usdc, axcnh, usdt0, cnht0, axcnhUsdt0Pair, lpRewardFarm;
let slippage = 0.1;
let isChinese = true;
let currentRatio = 0;
let fromToken = "CFX";
let toToken = "LOM";
let refreshInterval;
let currentTokenSelector = null;
let transactionLock = false;
let currentReserves = { cfx: 0, lom: 0 };
let lastInputWasFrom = true;
let farmRefreshInterval;

// 农场数据缓存
const farmDataCache = {
  lastUpdate: 0,
  data: null
};

// ==================== 核心代币列表 ====================
const TOKEN_LIST = [
  {
    symbol: "CFX",
    name: "Conflux",
    address: APP_CONFIG.CONTRACTS.WCFX,
    logo: APP_CONFIG.TOKEN_LOGOS.CFX,
    decimals: 18,
    isNative: true
  },
  {
    symbol: "LOM",
    name: "Longmai",
    address: APP_CONFIG.CONTRACTS.LOM,
    logo: APP_CONFIG.TOKEN_LOGOS.LOM,
    decimals: 18
  },
  {
    symbol: "USDC",
    name: "USD Coin",
    address: APP_CONFIG.CONTRACTS.USDC,
    logo: APP_CONFIG.TOKEN_LOGOS.USDC,
    decimals: 18
  },
  {
    symbol: "AXCNH",
    name: "AxCNH",
    address: APP_CONFIG.CONTRACTS.AXCNH,
    logo: APP_CONFIG.TOKEN_LOGOS.AXCNH,
    decimals: 6
  },
  {
    symbol: "USDT0",
    name: "Tether USD (Test)",
    address: APP_CONFIG.CONTRACTS.USDT0,
    logo: APP_CONFIG.TOKEN_LOGOS.USDT0,
    decimals: 6
  },
  {
    symbol: "CNHT0",
    name: "CNH Token (Test)",
    address: APP_CONFIG.CONTRACTS.CNHT0,
    logo: APP_CONFIG.TOKEN_LOGOS.CNHT0,
    decimals: 6
  }
];

// ==================== 合约 ABI ====================
const ROUTER_ABI = [
  "function getAmountsOut(uint amountIn, address[] path) view returns (uint[] memory amounts)",
  "function swapExactETHForTokensSupportingFeeOnTransferTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) payable",
  "function swapExactTokensForETHSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline)",
  "function swapExactTokensForTokensSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline)",
  "function addLiquidityETH(address token, uint amountTokenDesired, uint amountTokenMin, uint amountETHMin, address to, uint deadline) payable returns (uint amountToken, uint amountETH, uint liquidity)",
  "function removeLiquidityETHSupportingFeeOnTransferTokens(address token, uint liquidity, uint amountTokenMin, uint amountETHMin, address to, uint deadline) returns (uint amountETH)",
  "function removeLiquidityETH(address token, uint liquidity, uint amountTokenMin, uint amountETHMin, address to, uint deadline) returns (uint amountToken, uint amountETH)"
];

const ERC20_ABI = [
  "function approve(address spender, uint256 amount) returns (bool)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function balanceOf(address owner) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function totalSupply() view returns (uint256)"
];

const PAIR_ABI = [
  "function getReserves() view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)",
  "function totalSupply() view returns (uint256)",
  "function balanceOf(address owner) view returns (uint256)",
  "function token0() view returns (address)",
  "function token1() view returns (address)",
  "function approve(address spender, uint256 amount) returns (bool)",
  "function allowance(address owner, address spender) view returns (uint256)"
];

// ==================== 工具模块 ====================
const Utils = {
  debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  },

  formatDisplay(value) {
    if (!value && value !== 0) return '0.000000';
    
    const num = parseFloat(value);
    if (isNaN(num)) return '0.000000';
    
    const truncated = Math.floor(num * 1000000) / 1000000;
    
    const parts = truncated.toString().split('.');
    let integerPart = parts[0];
    let decimalPart = parts[1] || '';
    
    if (decimalPart.length < 6) {
      decimalPart = decimalPart.padEnd(6, '0');
    } else if (decimalPart.length > 6) {
      decimalPart = decimalPart.substring(0, 6);
    }
    
    let result = integerPart + '.' + decimalPart;
    
    if (result.includes('.')) {
      result = result.replace(/0+$/, '');
      if (result.endsWith('.')) {
        result = result.slice(0, -1);
      }
    }
    
    return result;
  },

  formatAddress(address) {
    if (!address) return '';
    return address.slice(0, 4) + '...' + address.slice(-6);
  },

  showError(message) {
    const errorBox = document.getElementById('swapErrorBox');
    const errorText = document.getElementById('swapErrorText');
    if (errorBox && errorText) {
      errorText.textContent = message;
      errorBox.classList.add('show');
      
      setTimeout(() => {
        errorBox.classList.remove('show');
      }, 5000);
    }
  },

  showNotification(message, type = 'info') {
    const status = document.getElementById('txStatusOverlay');
    const icon = document.getElementById('txStatusIcon');
    const title = document.getElementById('txStatusTitle');
    const msg = document.getElementById('txStatusMessage');
    const doneBtn = document.getElementById('txStatusDoneBtn');
    
    const statusConfig = {
      info: { 
        icon: '<div class="loading-spinner white"></div>', 
        title: isChinese ? '处理中' : 'Processing' 
      },
      success: { 
        icon: '✅', 
        title: isChinese ? '操作成功' : 'Success' 
      },
      error: { 
        icon: '❌', 
        title: isChinese ? '操作失败' : 'Failed' 
      },
      warning: { 
        icon: '⚠️', 
        title: isChinese ? '提示' : 'Notice' 
      }
    };
    
    const config = statusConfig[type] || statusConfig.info;
    icon.innerHTML = config.icon;
    title.textContent = config.title;
    msg.textContent = message;
    
    if (type === 'success' || type === 'error' || type === 'warning') {
      doneBtn.style.display = 'block';
    } else {
      doneBtn.style.display = 'none';
    }
    
    status.style.display = 'flex';
  },

  hideNotification() {
    const status = document.getElementById('txStatusOverlay');
    if (status) {
      status.style.display = 'none';
    }
    document.querySelectorAll('button').forEach(btn => {
      if (!btn.id.includes('Cancel') && !btn.id.includes('Done')) {
        btn.disabled = false;
      }
    });
  },

  getErrorMessage(error) {
    const message = error.message || error.toString();
    
    const errorMap = {
      'user rejected': isChinese ? '用户取消了交易' : 'Transaction rejected by user',
      'INSUFFICIENT_OUTPUT_AMOUNT': isChinese ? '输出数量不足，请提高滑点容差' : 'Insufficient output amount, increase slippage',
      'INSUFFICIENT_INPUT_AMOUNT': isChinese ? '输入数量不足' : 'Insufficient input amount',
      'insufficient funds': isChinese ? '余额不足' : 'Insufficient balance',
      'allowance': isChinese ? '请先授权代币' : 'Please approve token first',
      'deadline': isChinese ? '交易超时，请重试' : 'Transaction expired, please try again',
      'Not enough liquidity': isChinese ? '流动性不足' : 'Insufficient liquidity',
      'execution reverted': isChinese ? '交易执行失败' : 'Transaction execution failed',
      'reverted': isChinese ? '交易失败' : 'Transaction failed',
      'invalid decimal value': isChinese ? '数量格式错误' : 'Invalid amount format',
      'underflow': isChinese ? '数量太小' : 'Amount too small',
      'No LP tokens': isChinese ? '您没有LP代币' : 'You have no LP tokens',
      'Not active': isChinese ? '账户未激活' : 'Account not active',
      'Sync too frequent': isChinese ? '同步太频繁' : 'Sync too frequent',
      'Daily limit reached': isChinese ? '达到每日上限' : 'Daily limit reached',
      'Insufficient LOM rewards': isChinese ? 'LOM奖励不足' : 'Insufficient LOM rewards',
      'Transaction failed': isChinese ? '交易失败' : 'Transaction failed'
    };
    
    for (const [key, value] of Object.entries(errorMap)) {
      if (message.toLowerCase().includes(key.toLowerCase())) {
        return value;
      }
    }
    
    return isChinese ? '交易失败，请重试' : 'Transaction failed, please try again';
  },

  formatNumber(num) {
    if (num >= 1000000) {
      return (num / 1000000).toFixed(2) + 'M';
    } else if (num >= 1000) {
      return (num / 1000).toFixed(2) + 'K';
    } else {
      return this.formatDisplay(num);
    }
  },

  formatTime(seconds) {
    if (seconds <= 0) return isChinese ? '现在可同步' : 'Ready to sync';
    
    if (seconds < 60) {
      return isChinese ? `${Math.ceil(seconds)}秒后` : `in ${Math.ceil(seconds)}s`;
    } else if (seconds < 3600) {
      return isChinese ? `${Math.ceil(seconds / 60)}分钟后` : `in ${Math.ceil(seconds / 60)}min`;
    } else if (seconds < 86400) {
      return isChinese ? `${Math.ceil(seconds / 3600)}小时后` : `in ${Math.ceil(seconds / 3600)}h`;
    } else {
      return isChinese ? `${Math.ceil(seconds / 86400)}天后` : `in ${Math.ceil(seconds / 86400)}d`;
    }
  },

  formatLevel(level) {
    const levelMap = {
      'BRONZE': isChinese ? '青铜' : 'Bronze',
      'SILVER': isChinese ? '白银' : 'Silver',
      'GOLD': isChinese ? '黄金' : 'Gold',
      'INACTIVE': isChinese ? '未激活' : 'Inactive',
      '0': isChinese ? '未激活' : 'Inactive',
      '1': isChinese ? '青铜' : 'Bronze',
      '2': isChinese ? '白银' : 'Silver',
      '3': isChinese ? '黄金' : 'Gold'
    };
    return levelMap[level] || level;
  },

  getLevelIcon(level) {
    const levelIconMap = {
      'BRONZE': '🥉',
      'SILVER': '🥈',
      'GOLD': '🥇',
      'INACTIVE': '⏳',
      '0': '⏳',
      '1': '🥉',
      '2': '🥈',
      '3': '🥇'
    };
    return levelIconMap[level] || '⏳';
  }
};

// ==================== 代币工具模块 ====================
const TokenUtils = {
  getToken(symbol) {
    return TOKEN_LIST.find(t => t.symbol === symbol);
  },

  getTokenDecimals(symbol) {
    const token = this.getToken(symbol);
    return token ? token.decimals : 18;
  },

  getTokenContract(symbol) {
    const tokenContracts = {
      "LOM": lom,
      "USDC": usdc,
      "AXCNH": axcnh,
      "USDT0": usdt0,
      "CNHT0": cnht0
    };
    return tokenContracts[symbol] || null;
  },

  formatTokenAmount(amount, symbol) {
    const decimals = this.getTokenDecimals(symbol);
    try {
      const formatted = ethers.utils.formatUnits(amount, decimals);
      return Utils.formatDisplay(formatted);
    } catch {
      return '0.000000';
    }
  },

  parseTokenAmount(amount, symbol) {
    const decimals = this.getTokenDecimals(symbol);
    try {
      return ethers.utils.parseUnits(amount.toString(), decimals);
    } catch {
      return ethers.BigNumber.from(0);
    }
  }
};

// ==================== LP奖励农场管理器优化 ====================
const FarmManager = {
  async refreshFarmData() {
    if (!account || !lpRewardFarm) {
      console.log('未连接钱包，清空数据');
      this.clearUI();
      return;
    }
    
    try {
      console.log('开始从链上获取农场数据...');
      
      // 检查缓存，避免频繁请求
      const now = Date.now();
      if (farmDataCache.data && now - farmDataCache.lastUpdate < 5000) {
        console.log('使用缓存数据');
        this.updateUIFromCache();
        return;
      }
      
      // 并行获取所有必要数据
      await Promise.allSettled([
        this.updateFarmInfo(),
        this.updateUserInfo(),
        this.updatePoolParameters(),
        this.updateRewardEstimates()
      ]);
      
      // 更新缓存
      farmDataCache.lastUpdate = Date.now();
      console.log('农场数据获取完成');
      
    } catch (error) {
      console.error('获取农场数据失败:', error);
      Utils.showError(isChinese ? '获取数据失败，请检查网络' : 'Failed to fetch data, check network');
    }
  },

  clearUI() {
    // 清空农场统计
    document.getElementById('totalRewardPool').textContent = '-- LOM';
    document.getElementById('remainingRewards').textContent = '-- LOM';
    
    // 清空用户信息
    const userAvatar = document.getElementById('userAvatar');
    userAvatar.textContent = '👤';
    userAvatar.className = 'user-avatar';
    document.getElementById('userName').textContent = isChinese ? '未连接钱包' : 'Wallet Not Connected';
    document.getElementById('userLevel').textContent = isChinese ? '请连接钱包查看数据' : 'Connect wallet to view data';
    
    // 清空收益信息
    document.getElementById('dailyRewardRate').textContent = '--%';
    document.getElementById('totalEarned').textContent = '-- LOM';
    document.getElementById('pendingRewards').textContent = '-- LOM';
    document.getElementById('dailyEstimate').textContent = '-- LOM';
    
    // 清空用户统计
    document.getElementById('lpBalance').textContent = '--';
    document.getElementById('activityScore').textContent = '--';
    document.getElementById('consecutiveDays').textContent = '--';
    
    // 清空时间显示
    document.getElementById('nextSyncTime').textContent = '--';
    
    // 清空状态提示
    const actionStatus = document.getElementById('actionStatus');
    if (actionStatus) {
      actionStatus.className = 'action-status';
      actionStatus.textContent = '';
    }
    
    this.disableAllButtons();
  },

  updateUIFromCache() {
    if (!farmDataCache.data) return;
    
    const data = farmDataCache.data;
    
    // 更新农场统计
    if (data.farmInfo) {
      document.getElementById('totalRewardPool').textContent = 
        Utils.formatNumber(data.farmInfo.totalRewardPool || 0) + ' LOM';
      document.getElementById('remainingRewards').textContent = 
        Utils.formatNumber(data.farmInfo.remainingRewards || 0) + ' LOM';
    }
    
    // 更新用户信息
    if (data.userInfo) {
      this.updateUserUI(data.userInfo);
    }
    
    // 更新池子参数
    if (data.poolParameters) {
      const dailyRatePercent = (data.poolParameters.dailyRewardRate * 100).toFixed(2);
      document.getElementById('dailyRewardRate').textContent = `${dailyRatePercent}%`;
    }
  },

  disableAllButtons() {
    document.getElementById('activateBtn').disabled = true;
    document.getElementById('syncBtn').disabled = true;
    document.getElementById('checkinBtn').disabled = true;
    document.getElementById('claimInCardBtn').disabled = true;
  },

  async updateFarmInfo() {
    try {
      console.log('=== 更新农场信息 ===');
      
      if (!lpRewardFarm) {
        console.error('LP挖矿合约未初始化');
        return;
      }
      
      // 获取农场基本信息
      const [
        totalLOMDeposited,
        totalLOMDistributed,
        remainingLOM,
        farmingActive,
        paused
      ] = await Promise.all([
        lpRewardFarm.totalLOMDeposited().catch(() => ethers.BigNumber.from(0)),
        lpRewardFarm.totalLOMDistributed().catch(() => ethers.BigNumber.from(0)),
        lpRewardFarm.remainingLOM().catch(() => ethers.BigNumber.from(0)),
        lpRewardFarm.farmingActive().catch(() => false),
        lpRewardFarm.paused().catch(() => false)
      ]);
      
      // 转换数据格式
      const farmInfo = {
        totalRewardPool: parseFloat(ethers.utils.formatUnits(totalLOMDeposited, 18)),
        totalDistributed: parseFloat(ethers.utils.formatUnits(totalLOMDistributed, 18)),
        remainingRewards: parseFloat(ethers.utils.formatUnits(remainingLOM, 18)),
        farmingActive: farmingActive,
        paused: paused
      };
      
      // 更新UI
      document.getElementById('totalRewardPool').textContent = 
        Utils.formatNumber(farmInfo.totalRewardPool) + ' LOM';
      document.getElementById('remainingRewards').textContent = 
        Utils.formatNumber(farmInfo.remainingRewards) + ' LOM';
      
      // 更新缓存
      if (!farmDataCache.data) farmDataCache.data = {};
      farmDataCache.data.farmInfo = farmInfo;
      
      console.log('农场信息更新完成:', farmInfo);
      
    } catch (error) {
      console.error('更新农场信息失败:', error);
    }
  },

  async updatePoolParameters() {
    try {
      if (!lpRewardFarm) return;
      
      // 获取池子参数
      const [
        dailyRewardRate,
        maxDailyLOMPerUser,
        dailyCheckinBonus
      ] = await Promise.all([
        lpRewardFarm.dailyRewardRate().catch(() => ethers.BigNumber.from(0)),
        lpRewardFarm.maxDailyLOMPerUser().catch(() => ethers.BigNumber.from(0)),
        lpRewardFarm.DAILY_CHECKIN_BONUS().catch(() => ethers.BigNumber.from(0))
      ]);
      
      // 计算日收益率
      const dailyRate = parseFloat(ethers.utils.formatUnits(dailyRewardRate, 18));
      const dailyRatePercent = (dailyRate * 100).toFixed(2);
      
      // 更新UI
      document.getElementById('dailyRewardRate').textContent = `${dailyRatePercent}%`;
      
      // 更新缓存
      if (!farmDataCache.data) farmDataCache.data = {};
      farmDataCache.data.poolParameters = {
        dailyRewardRate: dailyRate,
        maxDailyLOMPerUser: parseFloat(ethers.utils.formatUnits(maxDailyLOMPerUser, 18)),
        dailyCheckinBonus: parseFloat(ethers.utils.formatUnits(dailyCheckinBonus, 18))
      };
      
    } catch (error) {
      console.error('获取池子参数失败:', error);
    }
  },

  async updateUserInfo() {
    try {
      if (!account || !lpRewardFarm) return;
      
      console.log('=== 更新用户信息 ===');
      
      // 获取用户信息
      const userInfo = await lpRewardFarm.getUserInfo(account).catch(() => null);
      
      if (!userInfo) {
        console.warn('无法获取用户信息');
        this.updateUserUI(null);
        return;
      }
      
      // 解析用户信息
      const [
        currentBalance,
        pendingLOMRewards,
        activityScore,
        level,
        consecutiveDays,
        nextSyncAvailable,
        dailyLOMLeft,
        canCheckInToday
      ] = userInfo;
      
      // 获取LP余额
      let lpBalance = 0;
      try {
        const lpBalanceBN = await pair.balanceOf(account);
        lpBalance = parseFloat(ethers.utils.formatUnits(lpBalanceBN, 18));
      } catch (e) {
        console.error('获取LP余额失败:', e);
      }
      
      // 获取用户奖励历史
      let totalEarned = 0;
      try {
        const userRewards = await lpRewardFarm.userRewards(account);
        totalEarned = parseFloat(ethers.utils.formatUnits(userRewards.totalLOMEarned || userRewards[1], 18));
      } catch (e) {
        console.warn('获取用户奖励历史失败:', e);
      }
      
      // 计算日收益预估
      let dailyEstimate = 0;
      if (lpBalance > 0 && farmDataCache.data?.poolParameters?.dailyRewardRate) {
        const dailyRate = farmDataCache.data.poolParameters.dailyRewardRate;
        dailyEstimate = lpBalance * dailyRate;
      }
      
      // 格式化数据
      const userData = {
        currentBalance: lpBalance,
        pendingRewards: parseFloat(ethers.utils.formatUnits(pendingLOMRewards, 18)),
        totalEarned: totalEarned,
        dailyEstimate: dailyEstimate,
        activityScore: parseInt(activityScore.toString()),
        level: level,
        consecutiveDays: parseInt(consecutiveDays.toString()),
        nextSyncAvailable: parseInt(nextSyncAvailable.toString()),
        dailyLOMLeft: parseFloat(ethers.utils.formatUnits(dailyLOMLeft, 18)),
        canCheckInToday: canCheckInToday,
        isActive: level !== "INACTIVE" && level !== "0"
      };
      
      // 更新UI
      this.updateUserUI(userData);
      
      // 更新缓存
      if (!farmDataCache.data) farmDataCache.data = {};
      farmDataCache.data.userInfo = userData;
      
      console.log('用户信息更新完成:', userData);
      
    } catch (error) {
      console.error('更新用户信息失败:', error);
      this.updateUserUI(null);
    }
  },

  updateUserUI(userData) {
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const userLevel = document.getElementById('userLevel');
    const claimInCardBtn = document.getElementById('claimInCardBtn');
    
    if (!userData || !userData.isActive) {
      // 未激活状态
      userAvatar.textContent = '⏳';
      userAvatar.className = 'user-avatar inactive';
      userName.textContent = isChinese ? '未激活账户' : 'Inactive Account';
      userLevel.textContent = isChinese ? 
        '需要LP代币激活账户' : 'Need LP tokens to activate account';
      
      // 清空收益数据
      document.getElementById('pendingRewards').textContent = '-- LOM';
      document.getElementById('totalEarned').textContent = '-- LOM';
      document.getElementById('dailyEstimate').textContent = '-- LOM';
      document.getElementById('lpBalance').textContent = '--';
      document.getElementById('activityScore').textContent = '--';
      document.getElementById('consecutiveDays').textContent = '--';
      document.getElementById('nextSyncTime').textContent = isChinese ? '未激活' : 'Inactive';
      
      // 禁用卡片内领取按钮
      if (claimInCardBtn) {
        claimInCardBtn.disabled = true;
      }
      
      // 更新按钮状态
      this.updateButtonStates(false, false, 0, false, 0);
      return;
    }
    
    // 已激活状态
    const levelIcon = Utils.getLevelIcon(userData.level);
    const levelDisplay = Utils.formatLevel(userData.level);
    
    userAvatar.textContent = levelIcon;
    
    // 设置头像样式
    if (userData.level === 'GOLD' || userData.level === '3') {
      userAvatar.className = 'user-avatar gold';
    } else if (userData.level === 'SILVER' || userData.level === '2') {
      userAvatar.className = 'user-avatar silver';
    } else if (userData.level === 'BRONZE' || userData.level === '1') {
      userAvatar.className = 'user-avatar bronze';
    } else {
      userAvatar.className = 'user-avatar';
    }
    
    userName.textContent = Utils.formatAddress(account);
    userLevel.textContent = `${levelDisplay} · ${userData.activityScore}分`;
    
    // 更新收益数据
    document.getElementById('pendingRewards').textContent = 
      Utils.formatDisplay(userData.pendingRewards) + ' LOM';
    document.getElementById('totalEarned').textContent = 
      Utils.formatDisplay(userData.totalEarned) + ' LOM';
    document.getElementById('dailyEstimate').textContent = 
      Utils.formatDisplay(userData.dailyEstimate) + ' LOM';
    
    // 更新统计数据
    document.getElementById('lpBalance').textContent = Utils.formatDisplay(userData.currentBalance);
    document.getElementById('activityScore').textContent = userData.activityScore.toString();
    document.getElementById('consecutiveDays').textContent = userData.consecutiveDays.toString();
    
    // 更新同步时间
    const nextSyncTime = userData.nextSyncAvailable;
    document.getElementById('nextSyncTime').textContent = Utils.formatTime(nextSyncTime);
    
    // 更新卡片内领取按钮
    if (claimInCardBtn) {
      claimInCardBtn.disabled = userData.pendingRewards < 0.000001;
      if (userData.pendingRewards >= 0.000001) {
        claimInCardBtn.textContent = `领取 ${Utils.formatDisplay(userData.pendingRewards)} LOM`;
      } else {
        claimInCardBtn.textContent = '暂无奖励';
      }
    }
    
    // 更新按钮状态
    const canSync = nextSyncTime <= 0 && userData.currentBalance > 0;
    this.updateButtonStates(
      true,
      userData.currentBalance > 0,
      canSync,
      userData.canCheckInToday,
      userData.pendingRewards
    );
  },

  async updateRewardEstimates() {
    try {
      if (!account || !lpRewardFarm) return;
      
      // 获取奖励预估
      const estimate = await lpRewardFarm.getPendingRewardsEstimate(account).catch(() => null);
      
      if (!estimate) {
        console.warn('无法获取奖励预估，尝试备用方法');
        // 备用方法：基于用户信息计算
        const userInfo = await lpRewardFarm.getUserInfo(account).catch(() => null);
        if (userInfo) {
          const pendingRewards = parseFloat(ethers.utils.formatUnits(userInfo[1], 18));
          const estimates = {
            safeRewards: pendingRewards,
            estimateValid: true
          };
          
          // 更新缓存
          if (!farmDataCache.data) farmDataCache.data = {};
          farmDataCache.data.estimates = estimates;
          return;
        }
        return;
      }
      
      const [safeRewardsBN, optimisticRewardsBN, estimateValid] = estimate;
      
      const estimates = {
        safeRewards: parseFloat(ethers.utils.formatUnits(safeRewardsBN, 18)),
        optimisticRewards: parseFloat(ethers.utils.formatUnits(optimisticRewardsBN, 18)),
        estimateValid: estimateValid
      };
      
      // 更新缓存
      if (!farmDataCache.data) farmDataCache.data = {};
      farmDataCache.data.estimates = estimates;
      
      console.log('奖励预估更新完成:', estimates);
      
    } catch (error) {
      console.warn('获取奖励预估失败:', error);
    }
  },

  updateButtonStates(isActive, hasLPBalance, canSync, canCheckIn, pendingRewards) {
    const activateBtn = document.getElementById('activateBtn');
    const syncBtn = document.getElementById('syncBtn');
    const checkinBtn = document.getElementById('checkinBtn');
    
    if (isActive) {
      // 已激活状态
      activateBtn.disabled = true;
      activateBtn.querySelector('.farm-btn-text').textContent = isChinese ? '已激活' : 'Activated';
      
      // 同步按钮
      syncBtn.disabled = !canSync;
      if (canSync) {
        syncBtn.querySelector('.farm-btn-text').textContent = isChinese ? '同步奖励' : 'Sync Rewards';
      } else {
        // 显示剩余时间
        const nextSyncTime = document.getElementById('nextSyncTime').textContent;
        syncBtn.querySelector('.farm-btn-text').textContent = nextSyncTime;
      }
      
      // 签到按钮
      checkinBtn.disabled = !canCheckIn;
      checkinBtn.querySelector('.farm-btn-text').textContent = isChinese ? '每日签到' : 'Daily Check-in';
      
    } else {
      // 未激活状态
      activateBtn.disabled = !hasLPBalance;
      activateBtn.querySelector('.farm-btn-text').textContent = isChinese ? '激活账户' : 'Activate Account';
      
      syncBtn.disabled = true;
      syncBtn.querySelector('.farm-btn-text').textContent = isChinese ? '需要先激活' : 'Need Activation';
      
      checkinBtn.disabled = true;
      checkinBtn.querySelector('.farm-btn-text').textContent = isChinese ? '未激活账户' : 'Inactive Account';
    }
  },

  // 操作状态管理器
  async executeWithValidation(actionType, actionFunction) {
    const statusElement = document.getElementById('actionStatus');
    
    // 重置状态
    statusElement.className = 'action-status';
    statusElement.textContent = '';
    
    // 验证前置条件
    const validation = await this.validateAction(actionType);
    if (!validation.valid) {
      statusElement.className = 'action-status error show';
      statusElement.textContent = validation.message;
      
      // 3秒后自动隐藏
      setTimeout(() => {
        statusElement.classList.remove('show');
      }, 3000);
      return false;
    }
    
    try {
      // 执行操作
      statusElement.className = 'action-status info show';
      statusElement.textContent = validation.processingMessage;
      
      await actionFunction();
      
      // 成功
      statusElement.className = 'action-status success show';
      statusElement.textContent = validation.successMessage;
      
      // 刷新数据
      setTimeout(() => {
        this.refreshFarmData();
        statusElement.classList.remove('show');
      }, 2000);
      
      return true;
      
    } catch (error) {
      console.error(`${actionType}操作失败:`, error);
      
      statusElement.className = 'action-status error show';
      statusElement.textContent = Utils.getErrorMessage(error);
      
      // 5秒后自动隐藏
      setTimeout(() => {
        statusElement.classList.remove('show');
      }, 5000);
      
      return false;
    }
  },

  async validateAction(actionType) {
    const validations = {
      'activate': {
        check: async () => {
          if (!account) return '请先连接钱包';
          
          // 检查是否已激活
          try {
            const userInfo = await lpRewardFarm.getUserInfo(account);
            const level = userInfo[3];
            if (level !== "INACTIVE" && level !== "0") return '账户已激活';
          } catch (e) {
            // 如果无法获取用户信息，继续检查
          }
          
          // 检查LP余额
          const lpBalance = parseFloat(document.getElementById('lpBalance').textContent);
          if (lpBalance <= 0.000001) return '需要LP代币才能激活';
          
          return null;
        },
        processingMessage: isChinese ? '激活账户中...' : 'Activating...',
        successMessage: isChinese ? '账户激活成功！' : 'Account activated!'
      },
      
      'sync': {
        check: async () => {
          if (!account) return '请先连接钱包';
          
          // 检查是否激活
          try {
            const userInfo = await lpRewardFarm.getUserInfo(account);
            const level = userInfo[3];
            if (level === "INACTIVE" || level === "0") return '请先激活账户';
            
            // 检查同步时间
            const nextSyncAvailable = parseInt(userInfo[5].toString());
            if (nextSyncAvailable > 0) {
              return `距离下次同步还有 ${Utils.formatTime(nextSyncAvailable)}`;
            }
          } catch (e) {
            return '无法获取用户信息';
          }
          
          // 检查LP余额
          const lpBalance = parseFloat(document.getElementById('lpBalance').textContent);
          if (lpBalance <= 0.000001) return '需要LP代币才能同步';
          
          return null;
        },
        processingMessage: isChinese ? '同步奖励中...' : 'Syncing...',
        successMessage: isChinese ? '奖励同步成功！' : 'Rewards synced!'
      },
      
      'claim': {
        check: async () => {
          if (!account) return '请先连接钱包';
          
          // 检查是否激活
          try {
            const userInfo = await lpRewardFarm.getUserInfo(account);
            const level = userInfo[3];
            if (level === "INACTIVE" || level === "0") return '请先激活账户';
            
            // 检查奖励余额
            const pendingRewards = parseFloat(ethers.utils.formatUnits(userInfo[1], 18));
            if (pendingRewards < 0.000001) return '暂无奖励可领取';
          } catch (e) {
            return '无法获取用户信息';
          }
          
          return null;
        },
        processingMessage: isChinese ? '领取奖励中...' : 'Claiming...',
        successMessage: isChinese ? '奖励领取成功！' : 'Rewards claimed!'
      },
      
      'checkin': {
        check: async () => {
          if (!account) return '请先连接钱包';
          
          // 检查是否激活
          try {
            const userInfo = await lpRewardFarm.getUserInfo(account);
            const level = userInfo[3];
            if (level === "INACTIVE" || level === "0") return '请先激活账户';
            
            // 检查是否可以签到
            const canCheckInToday = userInfo[7];
            if (!canCheckInToday) return '今日已签到';
          } catch (e) {
            return '无法获取用户信息';
          }
          
          return null;
        },
        processingMessage: isChinese ? '签到中...' : 'Checking in...',
        successMessage: isChinese ? '签到成功！' : 'Checked in!'
      }
    };
    
    const validation = validations[actionType];
    if (!validation) {
      return {
        valid: false,
        message: isChinese ? '未知操作类型' : 'Unknown action'
      };
    }
    
    const error = await validation.check();
    if (error) {
      return {
        valid: false,
        message: error
      };
    }
    
    return {
      valid: true,
      processingMessage: validation.processingMessage,
      successMessage: validation.successMessage
    };
  },

  async activateAccount() {
    return await this.executeWithValidation('activate', async () => {
      const tx = await lpRewardFarm.activate();
      await tx.wait();
    });
  },

  async syncRewards() {
    return await this.executeWithValidation('sync', async () => {
      const tx = await lpRewardFarm.sync();
      await tx.wait();
    });
  },

  async claimRewards() {
    return await this.executeWithValidation('claim', async () => {
      const tx = await lpRewardFarm.claimLOMRewards();
      await tx.wait();
    });
  },

  async dailyCheckIn() {
    return await this.executeWithValidation('checkin', async () => {
      const tx = await lpRewardFarm.dailyCheckIn();
      await tx.wait();
    });
  }
};

// ==================== 交易管理器 ====================
const TransactionManager = {
  async executeTransaction(operation) {
    if (transactionLock) {
      Utils.showError(isChinese ? '已有交易在处理中' : 'Transaction already in progress');
      return false;
    }
    
    if (!account) {
      Utils.showError(isChinese ? '请先连接钱包' : 'Please connect wallet first');
      return false;
    }
    
    transactionLock = true;
    
    try {
      const confirmed = await ConfirmDialog.show(operation);
      if (!confirmed) {
        transactionLock = false;
        return false;
      }
      
      Utils.showNotification(operation.processingMessage, 'info');
      await operation.execute();
      
      Utils.showNotification(operation.successMessage, 'success');
      await DataManager.refreshAll();
      await FarmManager.refreshFarmData();
      return true;
      
    } catch (error) {
      console.error('交易失败:', error);
      Utils.showNotification(Utils.getErrorMessage(error), 'error');
      return false;
    } finally {
      transactionLock = false;
    }
  },

  async executeFarmTransaction(operation) {
    return await this.executeTransaction(operation);
  },

  async checkAndApprove(tokenContract, spenderAddress, amount) {
    if (!tokenContract || !account) return true;
    
    try {
      const allowance = await tokenContract.allowance(account, spenderAddress);
      if (allowance.lt(amount)) {
        Utils.showNotification(isChinese ? '授权代币中...' : 'Approving token...', 'info');
        const approveTx = await tokenContract.approve(spenderAddress, ethers.constants.MaxUint256);
        await approveTx.wait();
      }
      return true;
    } catch (error) {
      console.error('授权失败:', error);
      throw new Error('approval');
    }
  }
};

// ==================== 确认对话框管理器 ====================
const ConfirmDialog = {
  async show(operation) {
    return new Promise((resolve) => {
      const modal = document.getElementById('farmConfirmModal');
      const icon = document.getElementById('farmConfirmIcon');
      const action = document.getElementById('farmConfirmAction');
      const amountsDiv = document.getElementById('farmConfirmAmounts');
      const detailsDiv = document.getElementById('farmConfirmDetails');
      
      icon.textContent = operation.icon;
      action.textContent = operation.title;
      
      amountsDiv.innerHTML = this.generateAmountsHTML(operation);
      detailsDiv.innerHTML = this.generateDetailsHTML(operation);
      
      modal.style.display = "flex";
      
      const cancelBtn = document.getElementById('farmCancelBtn');
      const confirmBtn = document.getElementById('farmConfirmBtn');
      
      const cleanup = () => {
        cancelBtn.removeEventListener('click', onCancel);
        confirmBtn.removeEventListener('click', onConfirm);
        modal.style.display = 'none';
        if (operation.confirmBtnStyle) {
          confirmBtn.style.background = '';
        }
      };
      
      const onCancel = () => {
        cleanup();
        resolve(false);
      };
      
      const onConfirm = () => {
        cleanup();
        resolve(true);
      };
      
      cancelBtn.addEventListener('click', onCancel);
      confirmBtn.addEventListener('click', onConfirm);
      
      if (operation.confirmBtnStyle) {
        confirmBtn.style.background = operation.confirmBtnStyle;
      }
    });
  },

  generateAmountsHTML(operation) {
    if (operation.type === 'activate') {
      return `
        <div class="confirm-amount-row">
          <div class="confirm-amount-logo" style="background-image: url('${APP_CONFIG.TOKEN_LOGOS.LOM}')"></div>
          <div class="confirm-amount-text">激活挖矿账户</div>
        </div>
      `;
    } else if (operation.type === 'sync') {
      return `
        <div class="confirm-amount-row">
          <div class="confirm-amount-logo" style="background-image: url('${APP_CONFIG.TOKEN_LOGOS.LOM}')"></div>
          <div class="confirm-amount-text">同步LOM奖励</div>
        </div>
      `;
    } else if (operation.type === 'claim') {
      const displayAmount = Utils.formatDisplay(operation.amount || 0);
      return `
        <div class="confirm-amount-row">
          <div class="confirm-amount-logo" style="background-image: url('${APP_CONFIG.TOKEN_LOGOS.LOM}')"></div>
          <div class="confirm-amount-text">${displayAmount} LOM</div>
        </div>
      `;
    } else if (operation.type === 'checkin') {
      return `
        <div class="confirm-amount-row">
          <div class="confirm-amount-logo" style="background-image: url('${APP_CONFIG.TOKEN_LOGOS.LOM}')"></div>
          <div class="confirm-amount-text">每日签到</div>
        </div>
      `;
    }
    return '';
  },

  generateDetailsHTML(operation) {
    if (operation.type === 'activate') {
      return `
        <div class="confirm-detail-item">
          <div class="confirm-detail-label">${isChinese ? '操作类型' : 'Action Type'}</div>
          <div class="confirm-detail-value">${isChinese ? '激活挖矿账户' : 'Activate Mining Account'}</div>
        </div>
        <div class="confirm-detail-item">
          <div class="confirm-detail-label">${isChinese ? '要求' : 'Requirement'}</div>
          <div class="confirm-detail-value">${isChinese ? '拥有LP代币' : 'Must have LP tokens'}</div>
        </div>
        <div class="confirm-detail-item">
          <div class="confirm-detail-label">${isChinese ? '费用' : 'Fee'}</div>
          <div class="confirm-detail-value">${isChinese ? '仅Gas费' : 'Gas fee only'}</div>
        </div>
      `;
    } else if (operation.type === 'sync') {
      return `
        <div class="confirm-detail-item">
          <div class="confirm-detail-label">${isChinese ? '操作类型' : 'Action Type'}</div>
          <div class="confirm-detail-value">${isChinese ? '同步奖励' : 'Sync Rewards'}</div>
        </div>
        <div class="confirm-detail-item">
          <div class="confirm-detail-label">${isChinese ? '要求' : 'Requirement'}</div>
          <div class="confirm-detail-value">${isChinese ? '需要LP代币' : 'Requires LP tokens'}</div>
        </div>
        <div class="confirm-detail-item">
          <div class="confirm-detail-label">${isChinese ? '间隔时间' : 'Interval'}</div>
          <div class="confirm-detail-value">${isChinese ? '12小时' : '12 hours'}</div>
        </div>
      `;
    } else if (operation.type === 'claim') {
      return `
        <div class="confirm-detail-item">
          <div class="confirm-detail-label">${isChinese ? '操作类型' : 'Action Type'}</div>
          <div class="confirm-detail-value">${isChinese ? '领取奖励' : 'Claim Rewards'}</div>
        </div>
        <div class="confirm-detail-item">
          <div class="confirm-detail-label">${isChinese ? '奖励数量' : 'Reward Amount'}</div>
          <div class="confirm-detail-value">${Utils.formatDisplay(operation.amount || 0)} LOM</div>
        </div>
      `;
    }
    return '';
  }
};

// ==================== 钱包管理器 ====================
const WalletManager = {
  async checkNetwork() {
    try {
      if (!window.ethereum) {
        throw new Error(isChinese ? "未检测到钱包" : "No wallet detected");
      }
      
      const chainId = await window.ethereum.request({ method: 'eth_chainId' });
      const targetChainId = '0x' + APP_CONFIG.CHAIN_ID.toString(16);
      
      if (chainId !== targetChainId) {
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: targetChainId }]
          });
        } catch (switchError) {
          if (switchError.code === 4902) {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: targetChainId,
                chainName: 'Conflux eSpace',
                nativeCurrency: {
                  name: 'CFX',
                  symbol: 'CFX',
                  decimals: 18
                },
                rpcUrls: ['https://evm.confluxrpc.com'],
                blockExplorerUrls: ['https://evm.confluxscan.io']
              }]
            });
          } else {
            throw switchError;
          }
        }
      }
      return true;
    } catch (error) {
      console.error("网络切换失败:", error);
      const errorMsg = isChinese ? 
        `请切换到Conflux eSpace网络 (ChainID: ${APP_CONFIG.CHAIN_ID})` :
        `Please switch to Conflux eSpace network (ChainID: ${APP_CONFIG.CHAIN_ID})`;
      Utils.showError(errorMsg);
      return false;
    }
  },

  initContracts() {
    try {
      if (!provider) {
        throw new Error('Provider not initialized');
      }
      
      signer = provider.getSigner();
      
      router = new ethers.Contract(
        APP_CONFIG.CONTRACTS.ROUTER,
        ROUTER_ABI,
        signer
      );
      
      pair = new ethers.Contract(
        APP_CONFIG.CONTRACTS.PAIR,
        PAIR_ABI,
        provider
      );
      
      lom = new ethers.Contract(
        APP_CONFIG.CONTRACTS.LOM,
        ERC20_ABI,
        signer
      );
      
      usdc = new ethers.Contract(
        APP_CONFIG.CONTRACTS.USDC,
        ERC20_ABI,
        signer
      );
      
      axcnh = new ethers.Contract(
        APP_CONFIG.CONTRACTS.AXCNH,
        ERC20_ABI,
        signer
      );
      
      usdt0 = new ethers.Contract(
        APP_CONFIG.CONTRACTS.USDT0,
        ERC20_ABI,
        signer
      );
      
      cnht0 = new ethers.Contract(
        APP_CONFIG.CONTRACTS.CNHT0,
        ERC20_ABI,
        signer
      );
      
      axcnhUsdt0Pair = new ethers.Contract(
        APP_CONFIG.CONTRACTS.AXCNH_USDT0_PAIR,
        PAIR_ABI,
        provider
      );
      
      // 初始化LP挖矿合约
      lpRewardFarm = new ethers.Contract(
        APP_CONFIG.CONTRACTS.LP_REWARD_FARM,
        LP_REWARD_FARM_ABI,
        signer
      );
      
      console.log('所有合约已初始化');
      return true;
    } catch (error) {
      console.error('初始化合约失败:', error);
      return false;
    }
  },

  async connect() {
    try {
      const walletBtn = document.getElementById('walletBtn');
      
      if (!window.ethereum) {
        Utils.showError(isChinese ? 
          "请安装TP钱包或MetaMask等Web3钱包" : 
          "Please install TP Wallet, MetaMask or other Web3 wallet"
        );
        walletBtn.textContent = isChinese ? '连接钱包' : 'Connect Wallet';
        return false;
      }
      
      walletBtn.textContent = isChinese ? '连接中...' : 'Connecting...';
      walletBtn.classList.add('connecting');
      walletBtn.disabled = true;
      
      const accounts = await window.ethereum.request({
        method: 'eth_requestAccounts'
      });
      
      if (!accounts || accounts.length === 0) {
        throw new Error(isChinese ? '用户拒绝连接' : 'User rejected connection');
      }
      
      account = accounts[0];
      console.log('连接账户:', account);
      
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      
      const networkOk = await this.checkNetwork();
      if (!networkOk) {
        throw new Error(isChinese ? '网络切换失败' : 'Network switch failed');
      }
      
      const contractsOk = this.initContracts();
      if (!contractsOk) {
        throw new Error(isChinese ? '合约初始化失败' : 'Contract initialization failed');
      }
      
      this.updateUI();
      
      await DataManager.refreshAll();
      await FarmManager.refreshFarmData();
      
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(() => DataManager.refreshAll(), 10000);
      
      if (farmRefreshInterval) clearInterval(farmRefreshInterval);
      farmRefreshInterval = setInterval(() => FarmManager.refreshFarmData(), 15000);
      
      Utils.showNotification(
        isChinese ? '钱包连接成功' : 'Wallet connected successfully',
        'success'
      );
      
      return true;
      
    } catch (error) {
      console.error("钱包连接失败:", error);
      
      let errorMessage;
      if (error.code === 4001) {
        errorMessage = isChinese ? '用户拒绝连接请求' : 'User rejected connection request';
      } else if (error.code === -32002) {
        errorMessage = isChinese ? '已有连接请求在处理中' : 'Connection request already processing';
      } else {
        errorMessage = isChinese ? `连接失败: ${error.message}` : `Connection failed: ${error.message}`;
      }
      
      Utils.showError(errorMessage);
      return false;
      
    } finally {
      this.updateUI();
    }
  },

  disconnect() {
    account = null;
    provider = null;
    signer = null;
    router = null;
    pair = null;
    lom = null;
    usdc = null;
    axcnh = null;
    usdt0 = null;
    cnht0 = null;
    axcnhUsdt0Pair = null;
    lpRewardFarm = null;
    
    if (refreshInterval) {
      clearInterval(refreshInterval);
      refreshInterval = null;
    }
    
    if (farmRefreshInterval) {
      clearInterval(farmRefreshInterval);
      farmRefreshInterval = null;
    }
    
    this.updateUI();
    DataManager.resetAllData();
    FarmManager.clearUI();
    
    Utils.showNotification(
      isChinese ? "钱包已断开连接" : "Wallet disconnected",
      'success'
    );
  },

  updateUI() {
    const walletBtn = document.getElementById('walletBtn');
    
    if (walletBtn) {
      walletBtn.disabled = false;
      walletBtn.classList.remove('connecting');
      
      if (account) {
        const displayAddress = Utils.formatAddress(account);
        walletBtn.textContent = displayAddress;
        walletBtn.classList.add('connected');
      } else {
        walletBtn.textContent = isChinese ? "连接钱包" : "Connect Wallet";
        walletBtn.classList.remove('connected');
      }
    }
    
    UIManager.updateAllTexts();
    DataManager.updateSwapButtonState();
  }
};

// ==================== 数据管理器 ====================
const DataManager = {
  async refreshAll() {
    if (!account) return;
    
    try {
      await this.updateAllBalances();
      await this.updatePoolInfo();
      this.updateSwapButtonState();
      await FarmManager.refreshFarmData();
    } catch (error) {
      console.error('刷新数据失败:', error);
    }
  },

  async updateAllBalances() {
    if (!account) return;
    
    try {
      const balancePromises = TOKEN_LIST.map(async (token) => {
        try {
          let balance = 0;
          
          if (token.symbol === 'CFX' && provider) {
            const cfxBal = await provider.getBalance(account);
            balance = parseFloat(ethers.utils.formatEther(cfxBal));
          } else {
            const contract = TokenUtils.getTokenContract(token.symbol);
            if (contract) {
              const tokenBal = await contract.balanceOf(account);
              balance = parseFloat(ethers.utils.formatUnits(tokenBal, token.decimals));
            }
          }
          
          return { symbol: token.symbol, balance };
        } catch (error) {
          console.error(`获取 ${token.symbol} 余额失败:`, error);
          return { symbol: token.symbol, balance: 0 };
        }
      });
      
      const balances = await Promise.all(balancePromises);
      
      balances.forEach(({ symbol, balance }) => {
        this.updateBalanceUI(symbol, balance);
      });
      
      if (lom && provider) {
        const cfxBal = balances.find(b => b.symbol === 'CFX')?.balance || 0;
        const lomBal = balances.find(b => b.symbol === 'LOM')?.balance || 0;
        
        document.getElementById("addCfxBal").textContent = Utils.formatDisplay(cfxBal);
        document.getElementById("addLomBal").textContent = Utils.formatDisplay(lomBal);
      }
      
      if (pair) {
        const lpBal = await pair.balanceOf(account);
        const lpAmt = parseFloat(ethers.utils.formatUnits(lpBal, 18));
        document.getElementById("removeBtn").disabled = lpBal.isZero();
      }
      
    } catch (error) {
      console.error("更新余额失败:", error);
    }
  },

  updateBalanceUI(symbol, balance) {
    const formattedBalance = Utils.formatDisplay(balance);
    
    if (symbol === fromToken) {
      const fromBalEl = document.getElementById('fromBal');
      if (fromBalEl) fromBalEl.textContent = formattedBalance;
    }
    
    if (symbol === toToken) {
      const toBalEl = document.getElementById('toBal');
      if (toBalEl) toBalEl.textContent = formattedBalance;
    }
  },

  async updatePoolInfo() {
    try {
      if (!pair || !account) return;
      
      const [r0, r1] = await pair.getReserves();
      const t0 = await pair.token0();
      const totalSupply = await pair.totalSupply();
      
      const reserveCfx = t0.toLowerCase() === APP_CONFIG.CONTRACTS.WCFX.toLowerCase() ? r0 : r1;
      const reserveLom = t0.toLowerCase() === APP_CONFIG.CONTRACTS.WCFX.toLowerCase() ? r1 : r0;
      
      const cfxReserve = parseFloat(ethers.utils.formatEther(reserveCfx));
      const lomReserve = parseFloat(ethers.utils.formatUnits(reserveLom, 18));
      
      currentReserves.cfx = cfxReserve;
      currentReserves.lom = lomReserve;
      
      const price = lomReserve / cfxReserve;
      currentRatio = price;
      
      const priceFormatted = Utils.formatDisplay(price);
      const priceText = isChinese ? 
        `${priceFormatted} LOM` : 
        `${priceFormatted} LOM`;
      document.getElementById("price").textContent = `1 CFX = ${priceText}`;
      document.getElementById("addRatio").textContent = `1 CFX = ${priceFormatted} LOM`;

      const totalSupplyNum = parseFloat(ethers.utils.formatUnits(totalSupply, 18));
      
      let lpAmt = 0;
      let share = 0;
      let userCfx = 0;
      let userLom = 0;
      
      const lpBal = await pair.balanceOf(account);
      lpAmt = parseFloat(ethers.utils.formatUnits(lpBal, 18));
      
      if (totalSupplyNum > 0 && lpAmt > 0) {
        share = (lpAmt / totalSupplyNum) * 100;
        userCfx = cfxReserve * (share / 100);
        userLom = lomReserve * (share / 100);
      }
      
      const cfxReserveEl = document.getElementById("cfxReserve");
      const lomReserveEl = document.getElementById("lomReserve");
      
      if (cfxReserveEl) cfxReserveEl.textContent = cfxReserve.toFixed(2);
      if (lomReserveEl) lomReserveEl.textContent = lomReserve.toFixed(2);
      
      const userCfxEl = document.getElementById("userCfx");
      const userLomEl = document.getElementById("userLom");
      const userLpEl = document.getElementById("userLp");
      const userPoolShareEl = document.getElementById("userPoolShare");
      
      if (userCfxEl) userCfxEl.textContent = userCfx.toFixed(2);
      if (userLomEl) userLomEl.textContent = userLom.toFixed(2);
      if (userLpEl) userLpEl.textContent = lpAmt.toFixed(2);
      if (userPoolShareEl) userPoolShareEl.textContent = share.toFixed(4) + "%";
      
      const poolTitle = isChinese ? 
        `CFX-LOM流动池` :
        `CFX-LOM Pool`;
      
      const poolInfoTitleEl = document.getElementById("poolInfoTitle");
      if (poolInfoTitleEl) poolInfoTitleEl.textContent = poolTitle;
      
      const removeBtn = document.getElementById("removeBtn");
      if (removeBtn) {
        removeBtn.disabled = lpAmt <= 0;
      }
      
    } catch (error) {
      console.error("更新池子信息失败:", error);
    }
  },

  updateSwapButtonState() {
    const swapBtn = document.getElementById("swapBtn");
    const fromAmount = document.getElementById("fromAmount").value;
    
    if (!account) {
      swapBtn.textContent = isChinese ? "连接钱包" : "Connect Wallet";
      swapBtn.disabled = false;
      return;
    }
    
    if (!fromAmount || fromAmount === "0" || fromAmount === "") {
      swapBtn.textContent = isChinese ? "请输入数量" : "Enter Amount";
      swapBtn.disabled = true;
      return;
    }
    
    swapBtn.textContent = isChinese ? "立即兑换" : "Swap Now";
    swapBtn.disabled = false;
  },

  resetAllData() {
    const elements = {
      'fromBal': '0.000000',
      'toBal': '0.000000',
      'addCfxBal': '0.000000',
      'addLomBal': '0.000000',
      'price': '1 CFX = 0.000000 LOM',
      'minReceived': '0.000000 LOM'
    };
    
    Object.keys(elements).forEach(id => {
      const element = document.getElementById(id);
      if (element) element.textContent = elements[id];
    });
    
    document.getElementById("fromAmount").value = "";
    document.getElementById("toAmount").value = "";
    document.getElementById("removeBtn").disabled = true;
  }
};

// ==================== 兑换模块 ====================
const SwapModule = {
  async executeSwap() {
    const fromAmount = document.getElementById('fromAmount').value;
    const toAmount = document.getElementById('toAmount').value;
    
    if (!fromAmount || fromAmount === '0') {
      Utils.showError(isChinese ? "请输入兑换数量" : "Please enter swap amount");
      return;
    }
    
    const operation = {
      type: 'swap',
      icon: '🔄',
      title: isChinese ? '兑换确认' : 'Swap Confirmation',
      fromToken,
      toToken,
      fromAmount: parseFloat(fromAmount),
      toAmount: parseFloat(toAmount),
      slippage: slippage,
      processingMessage: isChinese ? '处理兑换中...' : 'Processing swap...',
      successMessage: isChinese ? `兑换成功！获得 ${Utils.formatDisplay(toAmount)} ${toToken}` : 
                               `Swap successful! Received ${Utils.formatDisplay(toAmount)} ${toToken}`,
      execute: async () => {
        await this.processSwap(fromAmount, toAmount);
      }
    };
    
    await TransactionManager.executeTransaction(operation);
  },

  async processSwap(fromAmount, toAmount) {
    const fromDecimals = TokenUtils.getTokenDecimals(fromToken);
    const toDecimals = TokenUtils.getTokenDecimals(toToken);
    
    const amountIn = TokenUtils.parseTokenAmount(fromAmount, fromToken);
    const path = this.getSwapPath();
    
    if (!router) {
      throw new Error('路由器合约未初始化');
    }
    
    const amounts = await router.getAmountsOut(amountIn, path);
    const amountOutMin = amounts[amounts.length - 1].mul(1000 - slippage * 10).div(1000);
    
    const deadline = Math.floor(Date.now() / 1000) + 1200;
    
    let tx;
    
    if (fromToken === "CFX") {
      tx = await router.swapExactETHForTokensSupportingFeeOnTransferTokens(
        amountOutMin, path, account, deadline, 
        { value: amountIn }
      );
    } else if (toToken === "CFX") {
      const tokenContract = TokenUtils.getTokenContract(fromToken);
      if (!tokenContract) throw new Error('代币合约未找到');
      
      await TransactionManager.checkAndApprove(tokenContract, APP_CONFIG.CONTRACTS.ROUTER, amountIn);
      
      tx = await router.swapExactTokensForETHSupportingFeeOnTransferTokens(
        amountIn, amountOutMin, path, account, deadline
      );
    } else {
      const tokenContract = TokenUtils.getTokenContract(fromToken);
      if (!tokenContract) throw new Error('代币合约未找到');
      
      await TransactionManager.checkAndApprove(tokenContract, APP_CONFIG.CONTRACTS.ROUTER, amountIn);
      
      tx = await router.swapExactTokensForTokensSupportingFeeOnTransferTokens(
        amountIn, amountOutMin, path, account, deadline
      );
    }
    
    await tx.wait();
    document.getElementById('fromAmount').value = '';
    document.getElementById('toAmount').value = '';
  },

  getSwapPath() {
    let path = [];
    
    if ((fromToken === 'AXCNH' && toToken === 'USDT0') || 
        (fromToken === 'USDT0' && toToken === 'AXCNH')) {
      
      if (fromToken === 'AXCNH') {
        path.push(APP_CONFIG.CONTRACTS.AXCNH);
        path.push(APP_CONFIG.CONTRACTS.USDT0);
      } else {
        path.push(APP_CONFIG.CONTRACTS.USDT0);
        path.push(APP_CONFIG.CONTRACTS.AXCNH);
      }
      return path;
    }
    
    if (fromToken === 'CFX') {
      path.push(APP_CONFIG.CONTRACTS.WCFX);
      if (toToken === 'LOM') path.push(APP_CONFIG.CONTRACTS.LOM);
      else if (toToken === 'USDC') path.push(APP_CONFIG.CONTRACTS.USDC);
      else if (toToken === 'AXCNH') path.push(APP_CONFIG.CONTRACTS.AXCNH);
      else if (toToken === 'USDT0') path.push(APP_CONFIG.CONTRACTS.USDT0);
      else if (toToken === 'CNHT0') path.push(APP_CONFIG.CONTRACTS.CNHT0);
    } else if (toToken === 'CFX') {
      if (fromToken === 'LOM') path.push(APP_CONFIG.CONTRACTS.LOM);
      else if (fromToken === 'USDC') path.push(APP_CONFIG.CONTRACTS.USDC);
      else if (fromToken === 'AXCNH') path.push(APP_CONFIG.CONTRACTS.AXCNH);
      else if (fromToken === 'USDT0') path.push(APP_CONFIG.CONTRACTS.USDT0);
      else if (fromToken === 'CNHT0') path.push(APP_CONFIG.CONTRACTS.CNHT0);
      path.push(APP_CONFIG.CONTRACTS.WCFX);
    } else {
      if (fromToken === 'LOM') path.push(APP_CONFIG.CONTRACTS.LOM);
      else if (fromToken === 'USDC') path.push(APP_CONFIG.CONTRACTS.USDC);
      else if (fromToken === 'AXCNH') path.push(APP_CONFIG.CONTRACTS.AXCNH);
      else if (fromToken === 'USDT0') path.push(APP_CONFIG.CONTRACTS.USDT0);
      else if (fromToken === 'CNHT0') path.push(APP_CONFIG.CONTRACTS.CNHT0);
      
      path.push(APP_CONFIG.CONTRACTS.WCFX);
      
      if (toToken === 'LOM') path.push(APP_CONFIG.CONTRACTS.LOM);
      else if (toToken === 'USDC') path.push(APP_CONFIG.CONTRACTS.USDC);
      else if (toToken === 'AXCNH') path.push(APP_CONFIG.CONTRACTS.AXCNH);
      else if (toToken === 'USDT0') path.push(APP_CONFIG.CONTRACTS.USDT0);
      else if (toToken === 'CNHT0') path.push(APP_CONFIG.CONTRACTS.CNHT0);
    }
    
    return path;
  },

  async updateOutputFromInput() {
    const amount = document.getElementById('fromAmount').value;
    
    if (!amount || amount === '0' || amount === '' || !router) {
      document.getElementById('toAmount').value = "";
      document.getElementById('minReceived').textContent = `0 ${toToken}`;
      DataManager.updateSwapButtonState();
      return;
    }
    
    try {
      const fromDecimals = TokenUtils.getTokenDecimals(fromToken);
      const toDecimals = TokenUtils.getTokenDecimals(toToken);
      
      const amountIn = TokenUtils.parseTokenAmount(amount, fromToken);
      const path = this.getSwapPath();
      
      const amounts = await router.getAmountsOut(amountIn, path);
      const out = TokenUtils.formatTokenAmount(amounts[amounts.length - 1], toToken);
      
      document.getElementById('toAmount').value = out;
      
      const amountOutMin = amounts[amounts.length - 1].mul(1000 - slippage * 10).div(1000);
      const minOutFormatted = TokenUtils.formatTokenAmount(amountOutMin, toToken);
      document.getElementById('minReceived').textContent = 
        `${minOutFormatted} ${toToken}`;
      
      const price = parseFloat(out) / parseFloat(amount);
      const priceFormatted = Utils.formatDisplay(price);
      document.getElementById('price').textContent = 
        `1 ${fromToken} = ${priceFormatted} ${toToken}`;
      
      DataManager.updateSwapButtonState();
      
    } catch (error) {
      console.error('计算输出失败:', error);
      document.getElementById('toAmount').value = "";
      document.getElementById('swapBtn').textContent = isChinese ? '计算失败' : 'Calculation Failed';
      document.getElementById('swapBtn').disabled = true;
    }
  },

  reverseTokens() {
    const tempToken = fromToken;
    fromToken = toToken;
    toToken = tempToken;
    
    document.getElementById("fromTokenSymbol").textContent = fromToken;
    document.getElementById("toTokenSymbol").textContent = toToken;
    
    const fromTokenData = TokenUtils.getToken(fromToken);
    const toTokenData = TokenUtils.getToken(toToken);
    
    if (fromTokenData) {
      document.getElementById("fromTokenLogo").style.backgroundImage = `url('${fromTokenData.logo}')`;
    }
    
    if (toTokenData) {
      document.getElementById("toTokenLogo").style.backgroundImage = `url('${toTokenData.logo}')`;
    }
    
    document.getElementById("fromAmount").value = "";
    document.getElementById("toAmount").value = "";
    
    DataManager.updateAllBalances();
    DataManager.updateSwapButtonState();
    document.getElementById("price").textContent = `1 ${fromToken} = 0.000000 ${toToken}`;
    document.getElementById("minReceived").textContent = `0.000000 ${toToken}`;
    
    lastInputWasFrom = true;
  }
};

// ==================== 流动性模块 ====================
const LiquidityModule = {
  async addLiquidity() {
    const cfxAmount = document.getElementById("addCfx").value;
    const lomAmount = document.getElementById("addLom").value;
    
    if (!cfxAmount || !lomAmount || parseFloat(cfxAmount) <= 0 || parseFloat(lomAmount) <= 0) {
      Utils.showError(isChinese ? "请输入有效数量" : "Please enter valid amounts");
      return;
    }
    
    const operation = {
      type: 'addLiquidity',
      icon: '💧',
      title: isChinese ? '添加流动性' : 'Add Liquidity',
      cfxAmount: parseFloat(cfxAmount),
      lomAmount: parseFloat(lomAmount),
      slippage: slippage,
      processingMessage: isChinese ? '添加流动性中...' : 'Adding liquidity...',
      successMessage: isChinese ? '添加流动性成功！' : 'Liquidity added successfully!',
      execute: async () => {
        await this.executeAddLiquidity(cfxAmount, lomAmount);
      }
    };
    
    await TransactionManager.executeTransaction(operation);
  },

  async executeAddLiquidity(cfxAmount, lomAmount) {
    const amountCfx = TokenUtils.parseTokenAmount(cfxAmount, 'CFX');
    const amountLom = TokenUtils.parseTokenAmount(lomAmount, 'LOM');
    
    if (!lom || !router) {
      throw new Error('合约未初始化');
    }
    
    await TransactionManager.checkAndApprove(lom, APP_CONFIG.CONTRACTS.ROUTER, amountLom);
    
    const amountCfxMin = amountCfx.mul(1000 - slippage * 10).div(1000);
    const amountLomMin = amountLom.mul(1000 - slippage * 10).div(1000);
    const deadline = Math.floor(Date.now() / 1000) + 1800;
    
    const tx = await router.addLiquidityETH(
      APP_CONFIG.CONTRACTS.LOM,
      amountLom,
      amountLomMin,
      amountCfxMin,
      account,
      deadline,
      { value: amountCfx }
    );
    
    await tx.wait();
    document.getElementById("addModal").style.display = "none";
    document.getElementById("addCfx").value = "";
    document.getElementById("addLom").value = "";
  },

  async removeLiquidity() {
    const percent = document.getElementById("removeSlider").value;
    const cfxEst = document.getElementById("removeEstCfx").textContent;
    const lomEst = document.getElementById("removeEstLom").textContent;
    
    const operation = {
      type: 'removeLiquidity',
      icon: '🔥',
      title: isChinese ? '移除流动性' : 'Remove Liquidity',
      cfxEst: parseFloat(cfxEst),
      lomEst: parseFloat(lomEst),
      percent: parseFloat(percent),
      slippage: slippage,
      processingMessage: isChinese ? '移除流动性中...' : 'Removing liquidity...',
      successMessage: isChinese ? `移除流动性成功！获得 ${cfxEst} CFX 和 ${lomEst} LOM` : 
                               `Success! Received ${cfxEst} CFX and ${lomEst} LOM`,
      confirmBtnStyle: 'var(--gradient-red)',
      execute: async () => {
        await this.executeRemoveLiquidity(percent);
      }
    };
    
    await TransactionManager.executeTransaction(operation);
  },

  async executeRemoveLiquidity(percent) {
    if (!pair || !router) {
      throw new Error('合约未初始化');
    }
    
    const lpBal = await pair.balanceOf(account);
    const liquidity = lpBal.mul(percent).div(100);
    
    if (liquidity.isZero()) {
      throw new Error(isChinese ? '没有流动性可移除' : 'No liquidity to remove');
    }
    
    await TransactionManager.checkAndApprove(pair, APP_CONFIG.CONTRACTS.ROUTER, liquidity);
    
    const deadline = Math.floor(Date.now() / 1000) + 1800;
    
    const tx = await router.removeLiquidityETH(
      APP_CONFIG.CONTRACTS.LOM, 
      liquidity, 
      0,
      0,
      account, 
      deadline
    );
    
    await tx.wait();
    document.getElementById("removeModal").style.display = "none";
  },

  async updateRemoveEstimate(percent) {
    try {
      if (!account || !pair) return;
      
      document.getElementById("removePercent").textContent = percent + "%";
      
      const lpBal = await pair.balanceOf(account);
      const liquidity = lpBal.mul(percent).div(100);
      
      if (liquidity.isZero()) {
        document.getElementById("removeEstCfx").textContent = "0.000000";
        document.getElementById("removeEstLom").textContent = "0.000000";
        return;
      }
      
      const total = await pair.totalSupply();
      const { cfx: rCfx, lom: rLom } = currentReserves;
      
      const cfxReserve = TokenUtils.parseTokenAmount(rCfx.toString(), 'CFX');
      const lomReserve = TokenUtils.parseTokenAmount(rLom.toString(), 'LOM');
      
      const cfxOut = cfxReserve.mul(liquidity).div(total);
      const lomOut = lomReserve.mul(liquidity).div(total);
      
      const cfxOutFormatted = TokenUtils.formatTokenAmount(cfxOut, 'CFX');
      const lomOutFormatted = TokenUtils.formatTokenAmount(lomOut, 'LOM');
      
      document.getElementById("removeEstCfx").textContent = cfxOutFormatted;
      document.getElementById("removeEstLom").textContent = lomOutFormatted;
      
    } catch (error) {
      console.error("更新移除估算失败:", error);
      document.getElementById("removeEstCfx").textContent = "0.000000";
      document.getElementById("removeEstLom").textContent = "0.000000";
    }
  },

  handleCfxInput() {
    const cfxAmount = document.getElementById("addCfx").value;
    
    if (!cfxAmount || cfxAmount === "" || parseFloat(cfxAmount) <= 0) {
      document.getElementById("addLom").value = "";
      document.getElementById("confirmAddBtn").disabled = true;
      return;
    }
    
    if (currentRatio > 0) {
      const cfxNum = parseFloat(cfxAmount);
      const lomAmount = cfxNum * currentRatio;
      document.getElementById("addLom").value = Utils.formatDisplay(lomAmount);
    }
    
    this.updateAddButtonState();
  },

  handleLomInput() {
    const lomAmount = document.getElementById("addLom").value;
    
    if (!lomAmount || lomAmount === "" || parseFloat(lomAmount) <= 0) {
      document.getElementById("addCfx").value = "";
      document.getElementById("confirmAddBtn").disabled = true;
      return;
    }
    
    if (currentRatio > 0) {
      const lomNum = parseFloat(lomAmount);
      const cfxAmount = lomNum / currentRatio;
      document.getElementById("addCfx").value = Utils.formatDisplay(cfxAmount);
    }
    
    this.updateAddButtonState();
  },

  updateAddButtonState() {
    const cfxAmount = document.getElementById("addCfx").value;
    const lomAmount = document.getElementById("addLom").value;
    const cfxBalance = parseFloat(document.getElementById("addCfxBal").textContent);
    const lomBalance = parseFloat(document.getElementById("addLomBal").textContent);
    const confirmButton = document.getElementById("confirmAddBtn");
    
    if (!cfxAmount || !lomAmount || cfxAmount === "" || lomAmount === "") {
      confirmButton.disabled = true;
      return;
    }
    
    const cfxNum = parseFloat(cfxAmount);
      const lomNum = parseFloat(lomAmount);
    
    if (isNaN(cfxNum) || isNaN(lomNum) || cfxNum <= 0 || lomNum <= 0) {
      confirmButton.disabled = true;
      return;
    }
    
    if (cfxNum > cfxBalance) {
      confirmButton.disabled = true;
      return;
    }
    
    if (lomNum > lomBalance) {
      confirmButton.disabled = true;
      return;
    }
    
    const remainingCfx = cfxBalance - cfxNum;
    if (remainingCfx < 0.01) {
      confirmButton.disabled = true;
      return;
    }
    
    confirmButton.disabled = false;
  },

  async setMaxCfx() {
    const cfxBal = parseFloat(document.getElementById("addCfxBal").textContent);
    if (cfxBal <= 0) {
      Utils.showError(isChinese ? "CFX余额不足" : "Insufficient CFX balance");
      return;
    }
    
    const maxCfx = Math.max(0, cfxBal - 0.1);
    document.getElementById("addCfx").value = Utils.formatDisplay(maxCfx);
    
    if (currentRatio > 0) {
      const requiredLom = maxCfx * currentRatio;
      const lomBal = parseFloat(document.getElementById("addLomBal").textContent);
      
      if (requiredLom <= lomBal) {
        document.getElementById("addLom").value = Utils.formatDisplay(requiredLom);
      } else {
        const adjustedCfx = lomBal / currentRatio;
        document.getElementById("addCfx").value = Utils.formatDisplay(Math.min(adjustedCfx, maxCfx));
        document.getElementById("addLom").value = Utils.formatDisplay(lomBal);
      }
    }
    
    this.updateAddButtonState();
  },

  async setMaxLom() {
    const lomBal = parseFloat(document.getElementById("addLomBal").textContent);
    if (lomBal <= 0) {
      Utils.showError(isChinese ? "LOM余额不足" : "Insufficient LOM balance");
      return;
    }
    
    document.getElementById("addLom").value = Utils.formatDisplay(lomBal);
    
    if (currentRatio > 0) {
      const requiredCfx = lomBal / currentRatio;
      const cfxBal = parseFloat(document.getElementById("addCfxBal").textContent);
      const availableCfx = Math.max(0, cfxBal - 0.1);
      
      if (requiredCfx <= availableCfx) {
        document.getElementById("addCfx").value = Utils.formatDisplay(requiredCfx);
      } else {
        const adjustedLom = availableCfx * currentRatio;
        document.getElementById("addLom").value = Utils.formatDisplay(Math.min(adjustedLom, lomBal));
        document.getElementById("addCfx").value = Utils.formatDisplay(availableCfx);
      }
    }
    
    this.updateAddButtonState();
  }
};

// ==================== 界面管理器 ====================
const UIManager = {
  init() {
    this.setupEventListeners();
    this.setupTabs();
    this.updateAllTexts();
    
    document.getElementById('txStatusDoneBtn').addEventListener('click', () => {
      Utils.hideNotification();
    });
    
    // 添加卡片内领取按钮的事件监听
    document.getElementById('claimInCardBtn').addEventListener('click', () => {
      this.handleFarmAction('claim');
    });
    
    this.showFooterAndRiskWarning();
  },

  setupEventListeners() {
    document.getElementById("walletBtn").addEventListener("click", () => this.handleWalletClick());
    document.getElementById("langBtn").addEventListener("click", () => this.toggleLanguage());
    
    const debouncedFromInput = Utils.debounce(() => this.handleFromAmountInput(), 300);
    document.getElementById("fromAmount").addEventListener("input", debouncedFromInput);
    
    document.getElementById("reverse").addEventListener("click", () => SwapModule.reverseTokens());
    document.getElementById("swapBtn").addEventListener("click", async () => {
      if (!account) {
        await this.handleWalletClick();
      } else {
        await SwapModule.executeSwap();
      }
    });
    
    document.querySelectorAll('.percent-btn').forEach(btn => {
      btn.addEventListener('click', (e) => this.handlePercentageClick(e));
    });
    
    document.querySelectorAll('.slippage-btn').forEach(btn => {
      btn.addEventListener('click', (e) => this.handleSlippageClick(e));
    });
    
    document.getElementById("fromTokenSelector").addEventListener("click", () => this.openTokenSelector('from'));
    document.getElementById("toTokenSelector").addEventListener("click", () => this.openTokenSelector('to'));
    
    document.getElementById("addBtn").addEventListener("click", () => this.openAddModal());
    document.getElementById("removeBtn").addEventListener("click", () => this.openRemoveModal());
    
    document.getElementById("activateBtn").addEventListener("click", () => this.handleFarmAction('activate'));
    document.getElementById("syncBtn").addEventListener("click", () => this.handleFarmAction('sync'));
    document.getElementById("checkinBtn").addEventListener("click", () => this.handleFarmAction('checkin'));
    
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("modal-overlay") || 
          e.target.classList.contains("token-selector-modal") ||
          e.target.id === "farmConfirmModal") {
        e.target.style.display = "none";
      }
    });
    
    const debouncedCfxInput = Utils.debounce(() => LiquidityModule.handleCfxInput(), 300);
    const debouncedLomInput = Utils.debounce(() => LiquidityModule.handleLomInput(), 300);
    document.getElementById("addCfx").addEventListener("input", debouncedCfxInput);
    document.getElementById("addLom").addEventListener("input", debouncedLomInput);
    
    document.getElementById("cfxMaxBtn").addEventListener("click", () => LiquidityModule.setMaxCfx());
    document.getElementById("lomMaxBtn").addEventListener("click", () => LiquidityModule.setMaxLom());
    
    document.getElementById("cancelAddBtn").addEventListener("click", () => document.getElementById("addModal").style.display = "none");
    document.getElementById("confirmAddBtn").addEventListener("click", () => LiquidityModule.addLiquidity());
    
    document.getElementById("removeSlider").addEventListener("input", (e) => LiquidityModule.updateRemoveEstimate(e.target.value));
    document.querySelectorAll('.percentage-option').forEach(btn => {
      btn.addEventListener('click', (e) => this.handlePercentageOption(e));
    });
    document.getElementById("cancelRemoveBtn").addEventListener("click", () => document.getElementById("removeModal").style.display = "none");
    document.getElementById("confirmRemoveBtn").addEventListener("click", () => LiquidityModule.removeLiquidity());
  },

  showFooterAndRiskWarning() {
    const riskWarning = document.getElementById('riskWarning');
    const footer = document.getElementById('footerText');
    
    if (riskWarning) riskWarning.style.display = 'block';
    if (footer) footer.style.display = 'block';
  },

  async handleWalletClick() {
    if (account) {
      const confirmMessage = isChinese ? 
        "确定要断开钱包连接吗？" : 
        "Are you sure you want to disconnect wallet?";
      
      if (confirm(confirmMessage)) {
        WalletManager.disconnect();
      }
      return;
    }
    
    document.getElementById("walletBtn").disabled = true;
    
    try {
      const success = await WalletManager.connect();
      if (success) {
        WalletManager.updateUI();
        DataManager.refreshAll();
        FarmManager.refreshFarmData();
      }
    } catch (error) {
      console.error("钱包连接失败:", error);
    } finally {
      document.getElementById("walletBtn").disabled = false;
      WalletManager.updateUI();
    }
  },

  setupTabs() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.dataset.tab;
        
        tabBtns.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        btn.classList.add('active');
        document.getElementById(tabId + 'Tab').classList.add('active');
        
        if (account) {
          DataManager.refreshAll();
        }
        
        if (tabId === 'farm' && account) {
          setTimeout(() => FarmManager.refreshFarmData(), 500);
        }
      });
    });
  },

  handleFromAmountInput() {
    const amount = document.getElementById("fromAmount").value;
    if (amount && amount !== "0") {
      lastInputWasFrom = true;
      SwapModule.updateOutputFromInput();
    } else {
      document.getElementById("toAmount").value = "";
      DataManager.updateSwapButtonState();
      document.getElementById("minReceived").textContent = `0.000000 ${toToken}`;
    }
  },

  handlePercentageClick(e) {
    const percent = parseFloat(e.target.dataset.percent);
    
    document.querySelectorAll('.percent-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    
    if (!account) {
      Utils.showError(isChinese ? "请先连接钱包" : "Please connect wallet first");
      return;
    }
    
    let balance = parseFloat(document.getElementById("fromBal").textContent);
    
    if (balance > 0) {
      let amount;
      
      if (percent === 1) {
        if (fromToken === 'CFX') {
          amount = Math.max(0, balance - 0.1);
        } else {
          amount = balance * 0.9;
        }
      } else {
        amount = balance * percent;
      }
      
      if (amount > 0) {
        document.getElementById("fromAmount").value = Utils.formatDisplay(amount);
        lastInputWasFrom = true;
        SwapModule.updateOutputFromInput();
      }
    }
  },

  handleSlippageClick(e) {
    slippage = parseFloat(e.target.dataset.slip);
    document.querySelectorAll('.slippage-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    
    if (lastInputWasFrom && document.getElementById("fromAmount").value) {
      SwapModule.updateOutputFromInput();
    }
  },

  handlePercentageOption(e) {
    const percent = e.target.dataset.percent;
    document.querySelectorAll('.percentage-option').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    document.getElementById("removeSlider").value = percent;
    document.getElementById("removePercent").textContent = percent + "%";
    LiquidityModule.updateRemoveEstimate(percent);
  },

  openTokenSelector(type) {
    currentTokenSelector = type;
    const modal = document.getElementById("tokenSelectorModal");
    modal.style.display = "flex";
    document.getElementById("tokenSearch").value = "";
    this.populateTokenList();
  },

  async populateTokenList(searchTerm = "") {
    const tokenList = document.getElementById("tokenList");
    tokenList.innerHTML = "";
    
    const filteredTokens = TOKEN_LIST.filter(token => {
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        return token.symbol.toLowerCase().includes(term) || 
               token.name.toLowerCase().includes(term);
      }
      return true;
    });
    
    const fragment = document.createDocumentFragment();
    
    for (const token of filteredTokens) {
      if ((currentTokenSelector === 'from' && token.symbol === toToken) ||
          (currentTokenSelector === 'to' && token.symbol === fromToken)) {
        continue;
      }
      
      const tokenItem = document.createElement("div");
      tokenItem.className = "token-item";
      
      tokenItem.innerHTML = `
        <div class="token-item-logo" style="background-image: url('${token.logo}')"></div>
        <div class="token-item-info">
          <div class="token-item-symbol">${token.symbol}</div>
          <div class="token-item-name">${token.name}</div>
        </div>
        <div class="token-item-balance" id="selectorBalance-${token.symbol}">获取中...</div>
      `;
      
      tokenItem.addEventListener("click", () => {
        this.selectToken(token);
      });
      
      fragment.appendChild(tokenItem);
      
      setTimeout(async () => {
        try {
          const balance = await this.getTokenBalance(token.symbol);
          const balanceEl = document.getElementById(`selectorBalance-${token.symbol}`);
          if (balanceEl) {
            balanceEl.textContent = Utils.formatDisplay(balance);
          }
        } catch (error) {
          console.error(`获取 ${token.symbol} 余额失败:`, error);
          const balanceEl = document.getElementById(`selectorBalance-${token.symbol}`);
          if (balanceEl) {
            balanceEl.textContent = "0.000000";
          }
        }
      }, 0);
    }
    
    tokenList.appendChild(fragment);
    
    const searchInput = document.getElementById("tokenSearch");
    searchInput.addEventListener('input', Utils.debounce((e) => {
      this.populateTokenList(e.target.value);
    }, 300));
    
    setTimeout(() => searchInput.focus(), 100);
  },

  async getTokenBalance(symbol) {
    if (!account) return 0;
    
    const token = TokenUtils.getToken(symbol);
    if (!token) return 0;
    
    try {
      if (symbol === 'CFX') {
        const balance = await provider.getBalance(account);
        return parseFloat(ethers.utils.formatEther(balance));
      } else {
        const contract = TokenUtils.getTokenContract(symbol);
        if (!contract) return 0;
        
        const balance = await contract.balanceOf(account);
        return parseFloat(ethers.utils.formatUnits(balance, token.decimals));
      }
    } catch (error) {
      console.error(`获取 ${symbol} 余额失败:`, error);
      return 0;
    }
  },

  selectToken(token) {
    if (currentTokenSelector === 'from') {
      fromToken = token.symbol;
      document.getElementById("fromTokenSymbol").textContent = token.symbol;
      document.getElementById("fromTokenLogo").style.backgroundImage = `url('${token.logo}')`;
    } else if (currentTokenSelector === 'to') {
      toToken = token.symbol;
      document.getElementById("toTokenSymbol").textContent = token.symbol;
      document.getElementById("toTokenLogo").style.backgroundImage = `url('${token.logo}')`;
    }
    
    document.getElementById("tokenSelectorModal").style.display = "none";
    
    DataManager.updateAllBalances();
    
    document.getElementById("fromAmount").value = "";
    document.getElementById("toAmount").value = "";
    
    DataManager.updateSwapButtonState();
    document.getElementById("price").textContent = `1 ${fromToken} = 0.000000 ${toToken}`;
    document.getElementById("minReceived").textContent = `0.000000 ${toToken}`;
  },

  toggleLanguage() {
    isChinese = !isChinese;
    document.getElementById("langBtn").innerText = isChinese ? "EN" : "ZN";
    this.updateAllTexts();
  },

  updateAllTexts() {
    const walletBtn = document.getElementById("walletBtn");
    if (account) {
      const displayAddress = Utils.formatAddress(account);
      walletBtn.textContent = displayAddress;
      walletBtn.classList.add('connected');
    } else {
      walletBtn.textContent = isChinese ? "连接钱包" : "Connect Wallet";
      walletBtn.classList.remove('connected');
    }
    
    document.querySelector('[data-tab="swap"]').textContent = isChinese ? "兑换" : "Swap";
    document.querySelector('[data-tab="liquidity"]').textContent = isChinese ? "流动性" : "Liquidity";
    document.querySelector('[data-tab="farm"]').textContent = isChinese ? "LP挖矿" : "LP Farm";
    
    document.getElementById('farmTitle').textContent = isChinese ? "LP挖矿农场" : "LP Mining Farm";
    
    const swapBtn = document.getElementById("swapBtn");
    if (!account) {
      swapBtn.textContent = isChinese ? "连接钱包" : "Connect Wallet";
      swapBtn.disabled = false;
    } else if (document.getElementById("fromAmount").value && document.getElementById("fromAmount").value !== "0") {
      swapBtn.textContent = isChinese ? "立即兑换" : "Swap Now";
      swapBtn.disabled = false;
    } else {
      swapBtn.textContent = isChinese ? "请输入数量" : "Enter Amount";
      swapBtn.disabled = true;
    }
    
    document.getElementById("addBtn").textContent = isChinese ? "添加流动性" : "Add Liquidity";
    document.getElementById("removeBtn").textContent = isChinese ? "移除流动性" : "Remove Liquidity";
    
    document.getElementById("tokenSelectorTitle").textContent = isChinese ? "选择代币" : "Select Token";
    document.getElementById("addTitle").textContent = isChinese ? "添加流动性" : "Add Liquidity";
    document.getElementById("removeTitle").textContent = isChinese ? "移除流动性" : "Remove Liquidity";
    document.getElementById("confirmAddBtn").textContent = isChinese ? "确认添加" : "Confirm Add";
    document.getElementById("confirmRemoveBtn").textContent = isChinese ? "确认移除" : "Confirm Remove";
    document.getElementById("cancelAddBtn").textContent = isChinese ? "取消" : "Cancel";
    document.getElementById("cancelRemoveBtn").textContent = isChinese ? "取消" : "Cancel";
    
    document.getElementById('activateBtnText').textContent = isChinese ? '激活账户' : 'Activate Account';
    document.getElementById('syncBtnText').textContent = isChinese ? '同步奖励' : 'Sync Rewards';
    document.getElementById('checkinBtnText').textContent = isChinese ? '每日签到' : 'Daily Check-in';
    
    const claimInCardBtn = document.getElementById('claimInCardBtn');
    if (claimInCardBtn) {
      claimInCardBtn.textContent = isChinese ? '领取奖励' : 'Claim Rewards';
    }
    
    document.getElementById("riskTitle").textContent = isChinese ? "风险提示" : "Risk Warning";
    document.getElementById("riskText").textContent = isChinese ? 
      "本应用仅作为技术演示，不构成任何投资建议。加密货币市场波动巨大，投资需谨慎，请理性对待数字资产交易。" :
      "This application is for technical demonstration only and does not constitute investment advice. The cryptocurrency market is highly volatile. Please invest cautiously and treat digital asset trading rationally.";
    
    document.getElementById("footerText").textContent = isChinese ? "LOMswap · Conflux eSpace" : "LOMswap · Conflux eSpace";
  },

  openAddModal() {
    if (!account) {
      Utils.showError(isChinese ? "请先连接钱包" : "Please connect wallet first");
      return;
    }
    
    document.getElementById("addModal").style.display = "flex";
    document.getElementById("addCfx").value = "";
    document.getElementById("addLom").value = "";
    document.getElementById("confirmAddBtn").disabled = true;
    
    if (currentRatio > 0) {
      const ratioFormatted = Utils.formatDisplay(currentRatio);
      document.getElementById("addRatio").textContent = `1 CFX = ${ratioFormatted} LOM`;
    }
  },

  openRemoveModal() {
    if (!account) {
      Utils.showError(isChinese ? "请先连接钱包" : "Please connect wallet first");
      return;
    }
    
    document.getElementById("removeModal").style.display = "flex";
    LiquidityModule.updateRemoveEstimate(100);
  },

  async handleFarmAction(action) {
    const btn = document.getElementById(action + 'Btn');
    if (btn && btn.disabled) {
      return;
    }
    
    if (!account) {
      Utils.showError(isChinese ? "请先连接钱包" : "Please connect wallet first");
      return;
    }
    
    switch (action) {
      case 'activate':
        await FarmManager.activateAccount();
        break;
      case 'sync':
        await FarmManager.syncRewards();
        break;
      case 'claim':
        await FarmManager.claimRewards();
        break;
      case 'checkin':
        await FarmManager.dailyCheckIn();
        break;
    }
  }
};

// ==================== 初始化应用 ====================
document.addEventListener('DOMContentLoaded', function() {
  UIManager.init();
  
  if (window.ethereum) {
    window.ethereum.on('accountsChanged', (accounts) => {
      if (accounts.length === 0) {
        WalletManager.disconnect();
      } else {
        account = accounts[0];
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        WalletManager.initContracts();
        WalletManager.updateUI();
        DataManager.refreshAll();
        FarmManager.refreshFarmData();
        if (!refreshInterval) {
          refreshInterval = setInterval(() => DataManager.refreshAll(), 10000);
        }
        if (!farmRefreshInterval) {
          farmRefreshInterval = setInterval(() => FarmManager.refreshFarmData(), 15000);
        }
      }
    });
    
    window.ethereum.on('chainChanged', () => {
      location.reload();
    });
    
    window.ethereum.on('disconnect', () => {
      WalletManager.disconnect();
    });
  }
});
  </script>
</body>
              </html>
