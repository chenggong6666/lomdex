<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOM农场管理</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status {
            background: #e8f4ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .status-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        
        .status-title {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }
        
        .status-value {
            font-size: 1.2em;
            color: #333;
        }
        
        .control-panel {
            margin: 30px 0;
        }
        
        .control-section {
            margin-bottom: 20px;
        }
        
        .control-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
        
        .control-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            flex: 1;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        button.danger {
            background: #f44336;
        }
        
        button.danger:hover {
            background: #d32f2f;
        }
        
        .logs {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        
        .connection-info {
            background: #fff8e1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #ff9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LOM农场管理面板</h1>
        
        <div class="connection-info">
            <strong>合约地址：</strong> 0xD1a50fB7DbDE52a180Ab6Dc83a6969869259D32a<br>
            <strong>网络：</strong> Conflux eSpace<br>
            <strong>RPC：</strong> https://evm.confluxrpc.com
        </div>
        
        <!-- 钱包连接部分 -->
        <div class="control-section">
            <div class="control-title">钱包连接</div>
            <div class="button-group">
                <button id="connectBtn">连接钱包</button>
                <button id="disconnectBtn" disabled>断开连接</button>
            </div>
            <div id="walletInfo" style="margin-top: 10px; display: none;">
                <div class="status-item">
                    <div class="status-title">已连接地址</div>
                    <div class="status-value" id="connectedAddress"></div>
                </div>
                <div class="status-item">
                    <div class="status-title">管理员状态</div>
                    <div class="status-value" id="adminStatus">检查中...</div>
                </div>
            </div>
        </div>
        
        <!-- 合约状态 -->
        <div class="control-section">
            <div class="control-title">合约状态</div>
            <div id="contractStatus">
                <div class="status-item">
                    <div class="status-title">挖矿状态</div>
                    <div class="status-value" id="miningStatus">加载中...</div>
                </div>
                <div class="status-item">
                    <div class="status-title">暂停状态</div>
                    <div class="status-value" id="pauseStatus">加载中...</div>
                </div>
                <div class="status-item">
                    <div class="status-title">剩余LOM</div>
                    <div class="status-value" id="remainingLOM">加载中...</div>
                </div>
                <div class="status-item">
                    <div class="status-title">活跃用户</div>
                    <div class="status-value" id="activeUsers">加载中...</div>
                </div>
            </div>
        </div>
        
        <!-- 控制按钮 -->
        <div class="control-section">
            <div class="control-title">合约控制</div>
            <div class="button-group">
                <button id="startMiningBtn" disabled>开始挖矿</button>
                <button id="stopMiningBtn" disabled class="danger">停止挖矿</button>
                <button id="pauseBtn" disabled>暂停合约</button>
                <button id="resumeBtn" disabled>恢复合约</button>
            </div>
        </div>
        
        <!-- 参数调整 -->
        <div class="control-section">
            <div class="control-title">参数调整</div>
            
            <div class="control-group">
                <label>同步间隔（小时）</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="syncInterval" placeholder="当前: 12" min="1" max="24" style="flex: 3;">
                    <button id="updateSyncBtn" disabled style="flex: 1;">更新</button>
                </div>
            </div>
            
            <div class="control-group">
                <label>日奖励率（0.001%-0.1%）</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="dailyRate" placeholder="当前: 100" min="10" max="1000" style="flex: 3;">
                    <button id="updateRateBtn" disabled style="flex: 1;">更新</button>
                </div>
            </div>
            
            <div class="control-group">
                <label>每日上限（LOM）</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="dailyLimit" placeholder="当前: 3000" min="100" max="10000" style="flex: 3;">
                    <button id="updateLimitBtn" disabled style="flex: 1;">更新</button>
                </div>
            </div>
        </div>
        
        <!-- LOM管理 -->
        <div class="control-section">
            <div class="control-title">LOM管理</div>
            
            <div class="control-group">
                <label>存入LOM数量</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="depositAmount" placeholder="输入数量" min="1" style="flex: 3;">
                    <button id="depositBtn" disabled style="flex: 1;">存入</button>
                </div>
            </div>
            
            <div class="control-group">
                <label>提取超额LOM数量</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="withdrawAmount" placeholder="输入数量" min="1" style="flex: 3;">
                    <button id="withdrawBtn" disabled style="flex: 1;">提取</button>
                </div>
            </div>
        </div>
        
        <!-- 操作日志 -->
        <div class="control-section">
            <div class="control-title">操作日志</div>
            <div class="logs" id="logs">
                <div class="log-item info">等待操作...</div>
            </div>
        </div>
    </div>

    <script>
        // 合约配置
        const CONTRACT_ADDRESS = '0xD1a50fB7DbDE52a180Ab6Dc83a6969869259D32a';
        const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"_lpToken","type":"address"},{"internalType":"address","name":"_rewardToken","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"streak","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"bonus","type":"uint256"}],"name":"DailyCheckIn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"admin","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdrawExecuted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"admin","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalDeposited","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"remaining","type":"uint256"}],"name":"LOMDeposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"lomAmount","type":"uint256"}],"name":"LOMRewardClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"enum LOMRewardFarm.UserLevel","name":"oldLevel","type":"uint8"},{"indexed":false,"internalType":"enum LOMRewardFarm.UserLevel","name":"newLevel","type":"uint8"}],"name":"LevelUp","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"minSyncInterval","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"dailyRewardRate","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"maxDailyLOMPerUser","type":"uint256"}],"name":"ParametersUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"by","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"baseReward","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"bonus","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalReward","type":"uint256"}],"name":"Synced","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"by","type":"address"}],"name":"Unpaused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"UserActivated","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[],"name":"DAILY_CHECKIN_BONUS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"LOM_DECIMALS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_LOM_SUPPLY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"SYNC_ACTIVITY_POINTS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"SYNC_BONUS_RATE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"activate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimLOMRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"dailyCheckIn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"dailyRewardRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"depositLOMRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"emergencyWithdrawExcessLOM","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"farmingActive","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"firstDepositTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLOMPoolStatus","outputs":[{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"uint256","name":"totalDeposited","type":"uint256"},{"internalType":"uint256","name":"totalDistributed","type":"uint256"},{"internalType":"uint256","name":"remaining","type":"uint256"},{"internalType":"uint256","name":"depositProgress","type":"uint256"},{"internalType":"uint256","name":"distributionProgress","type":"uint256"},{"internalType":"uint256","name":"estimatedDaysLeft","type":"uint256"},{"internalType":"string","name":"status","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"userAddr","type":"address"}],"name":"getPendingRewardsEstimate","outputs":[{"internalType":"uint256","name":"safeRewards","type":"uint256"},{"internalType":"uint256","name":"optimisticRewards","type":"uint256"},{"internalType":"bool","name":"estimateValid","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getPoolInfo","outputs":[{"internalType":"uint256","name":"totalUsers","type":"uint256"},{"internalType":"uint256","name":"lomDeposited","type":"uint256"},{"internalType":"uint256","name":"lomDistributed","type":"uint256"},{"internalType":"uint256","name":"lomRemaining","type":"uint256"},{"internalType":"uint256","name":"currentDailyRate","type":"uint256"},{"internalType":"uint256","name":"currentDailyLimit","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isPaused","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getSecurityStatus","outputs":[{"internalType":"bool","name":"isAdminSet","type":"bool"},{"internalType":"address","name":"currentAdmin","type":"address"},{"internalType":"uint256","name":"lomContractBalance","type":"uint256"},{"internalType":"uint256","name":"excessLOM","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"userAddr","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"currentBalance","type":"uint256"},{"internalType":"uint256","name":"pendingLOMRewards","type":"uint256"},{"internalType":"uint256","name":"activityScore","type":"uint256"},{"internalType":"string","name":"level","type":"string"},{"internalType":"uint256","name":"consecutiveDays","type":"uint256"},{"internalType":"uint256","name":"nextSyncAvailable","type":"uint256"},{"internalType":"uint256","name":"dailyLOMLeft","type":"uint256"},{"internalType":"bool","name":"canCheckInToday","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lpToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxDailyLOMPerUser","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minSyncInterval","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"remainingLOM","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rewardToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bool","name":"active","type":"bool"}],"name":"setFarmingActive","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"_paused","type":"bool"}],"name":"setPaused","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"sync","outputs":[{"internalType":"uint256","name":"totalReward","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"totalActiveUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalLOMDeposited","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalLOMDistributed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newAdmin","type":"address"}],"name":"transferAdmin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newMinSyncInterval","type":"uint256"},{"internalType":"uint256","name":"newDailyRewardRate","type":"uint256"},{"internalType":"uint256","name":"newMaxDailyLOMPerUser","type":"uint256"}],"name":"updateRewardParameters","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"userRewards","outputs":[{"internalType":"uint256","name":"accumulatedLOM","type":"uint256"},{"internalType":"uint256","name":"totalLOMEarned","type":"uint256"},{"internalType":"uint256","name":"dailyLOMEarned","type":"uint256"},{"internalType":"uint256","name":"lastRewardDay","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"uint256","name":"lastSyncTime","type":"uint256"},{"internalType":"uint256","name":"lastCheckInTime","type":"uint256"},{"internalType":"uint256","name":"firstJoinTime","type":"uint256"},{"internalType":"uint256","name":"lastRewardDay","type":"uint256"},{"internalType":"uint256","name":"activityScore","type":"uint256"},{"internalType":"uint256","name":"consecutiveDays","type":"uint256"},{"internalType":"uint256","name":"totalSyncs","type":"uint256"},{"internalType":"enum LOMRewardFarm.UserLevel","name":"level","type":"uint8"},{"internalType":"bool","name":"isActive","type":"bool"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];
        
        // 全局变量
        let web3;
        let contract;
        let userAddress;
        let isAdmin = false;
        
        // 初始化
        window.addEventListener('load', async () => {
            try {
                // 初始化web3（仅用于读取数据）
                web3 = new Web3('https://evm.confluxrpc.com');
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                
                // 加载初始数据
                await updateContractStatus();
                setInterval(updateContractStatus, 30000); // 每30秒更新一次
                
                log('系统初始化完成，可以查看合约状态', 'info');
                
            } catch (error) {
                log('初始化失败: ' + error.message, 'error');
            }
            
            setupEventListeners();
        });
        
        // 设置事件监听器
        function setupEventListeners() {
            // 钱包连接
            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            document.getElementById('disconnectBtn').addEventListener('click', disconnectWallet);
            
            // 合约控制
            document.getElementById('startMiningBtn').addEventListener('click', () => confirmAction('startMining', '确定要开始挖矿吗？'));
            document.getElementById('stopMiningBtn').addEventListener('click', () => confirmAction('stopMining', '确定要停止挖矿吗？'));
            document.getElementById('pauseBtn').addEventListener('click', () => confirmAction('pause', '确定要暂停合约吗？'));
            document.getElementById('resumeBtn').addEventListener('click', () => confirmAction('resume', '确定要恢复合约吗？'));
            
            // 参数更新
            document.getElementById('updateSyncBtn').addEventListener('click', () => updateParameter('syncInterval'));
            document.getElementById('updateRateBtn').addEventListener('click', () => updateParameter('dailyRate'));
            document.getElementById('updateLimitBtn').addEventListener('click', () => updateParameter('dailyLimit'));
            
            // LOM管理
            document.getElementById('depositBtn').addEventListener('click', depositLOM);
            document.getElementById('withdrawBtn').addEventListener('click', withdrawLOM);
        }
        
        // 连接钱包
        async function connectWallet() {
            if (!window.ethereum) {
                alert('请安装MetaMask钱包扩展！');
                return;
            }
            
            try {
                // 使用钱包扩展
                const walletWeb3 = new Web3(window.ethereum);
                
                // 请求账户连接
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                userAddress = accounts[0];
                
                // 显示钱包信息
                document.getElementById('connectedAddress').textContent = userAddress;
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                
                // 检查是否是管理员
                await checkAdminStatus();
                
                log('钱包连接成功: ' + shortenAddress(userAddress), 'success');
                
            } catch (error) {
                log('钱包连接失败: ' + error.message, 'error');
                alert('连接失败: ' + error.message);
            }
        }
        
        // 断开钱包连接
        function disconnectWallet() {
            userAddress = null;
            isAdmin = false;
            
            document.getElementById('walletInfo').style.display = 'none';
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            document.getElementById('adminStatus').textContent = '检查中...';
            
            disableAllButtons();
            
            log('已断开钱包连接', 'info');
        }
        
        // 检查管理员状态
        async function checkAdminStatus() {
            try {
                const contractAdmin = await contract.methods.admin().call();
                isAdmin = userAddress.toLowerCase() === contractAdmin.toLowerCase();
                
                const statusText = isAdmin ? '管理员' : '非管理员';
                const statusColor = isAdmin ? 'green' : 'red';
                document.getElementById('adminStatus').textContent = statusText;
                document.getElementById('adminStatus').style.color = statusColor;
                
                if (isAdmin) {
                    enableAdminButtons();
                    log('验证通过: 您是合约管理员', 'success');
                } else {
                    disableAllButtons();
                    log('验证失败: 您不是合约管理员', 'error');
                }
                
            } catch (error) {
                log('检查管理员状态失败: ' + error.message, 'error');
            }
        }
        
        // 启用管理员按钮
        function enableAdminButtons() {
            document.getElementById('startMiningBtn').disabled = false;
            document.getElementById('stopMiningBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('resumeBtn').disabled = false;
            document.getElementById('updateSyncBtn').disabled = false;
            document.getElementById('updateRateBtn').disabled = false;
            document.getElementById('updateLimitBtn').disabled = false;
            document.getElementById('depositBtn').disabled = false;
            document.getElementById('withdrawBtn').disabled = false;
        }
        
        // 禁用所有按钮
        function disableAllButtons() {
            document.getElementById('startMiningBtn').disabled = true;
            document.getElementById('stopMiningBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resumeBtn').disabled = true;
            document.getElementById('updateSyncBtn').disabled = true;
            document.getElementById('updateRateBtn').disabled = true;
            document.getElementById('updateLimitBtn').disabled = true;
            document.getElementById('depositBtn').disabled = true;
            document.getElementById('withdrawBtn').disabled = true;
        }
        
        // 更新合约状态
        async function updateContractStatus() {
            try {
                const poolInfo = await contract.methods.getPoolInfo().call();
                
                // 更新挖矿状态
                const miningActive = poolInfo[6];
                document.getElementById('miningStatus').textContent = miningActive ? '运行中' : '已停止';
                document.getElementById('miningStatus').style.color = miningActive ? 'green' : 'red';
                
                // 更新暂停状态
                const paused = poolInfo[7];
                document.getElementById('pauseStatus').textContent = paused ? '已暂停' : '运行中';
                document.getElementById('pauseStatus').style.color = paused ? 'red' : 'green';
                
                // 更新其他状态
                document.getElementById('remainingLOM').textContent = Math.round(poolInfo[3] / 1e18).toLocaleString() + ' LOM';
                document.getElementById('activeUsers').textContent = poolInfo[0];
                
                // 更新当前参数值
                const syncInterval = await contract.methods.minSyncInterval().call();
                const dailyRate = await contract.methods.dailyRewardRate().call();
                const dailyLimit = await contract.methods.maxDailyLOMPerUser().call();
                
                document.getElementById('syncInterval').placeholder = '当前: ' + (syncInterval / 3600);
                document.getElementById('dailyRate').placeholder = '当前: ' + dailyRate;
                document.getElementById('dailyLimit').placeholder = '当前: ' + Math.round(dailyLimit / 1e18);
                
            } catch (error) {
                console.error('更新状态失败:', error);
            }
        }
        
        // 确认执行操作
        async function confirmAction(action, message) {
            if (!isAdmin || !userAddress) {
                alert('请先连接钱包并验证管理员权限');
                return;
            }
            
            if (!confirm(message)) {
                return;
            }
            
            try {
                let method;
                
                switch (action) {
                    case 'startMining':
                        method = contract.methods.setFarmingActive(true);
                        break;
                    case 'stopMining':
                        method = contract.methods.setFarmingActive(false);
                        break;
                    case 'pause':
                        method = contract.methods.setPaused(true);
                        break;
                    case 'resume':
                        method = contract.methods.setPaused(false);
                        break;
                }
                
                // 创建可执行合约实例
                const walletWeb3 = new Web3(window.ethereum);
                const executableContract = new walletWeb3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                
                const gas = await method.estimateGas({ from: userAddress });
                const tx = await method.send({ from: userAddress, gas });
                
                log(`操作成功: ${action}`, 'success');
                log('交易哈希: ' + tx.transactionHash, 'info');
                
                // 更新状态
                await updateContractStatus();
                
            } catch (error) {
                log(`操作失败: ${error.message}`, 'error');
                alert('操作失败: ' + error.message);
            }
        }
        
        // 更新参数
        async function updateParameter(type) {
            if (!isAdmin || !userAddress) {
                alert('请先连接钱包并验证管理员权限');
                return;
            }
            
            const input = document.getElementById(type);
            const value = input.value.trim();
            
            if (!value) {
                alert('请输入新值');
                return;
            }
            
            try {
                // 获取当前值
                const currentSyncInterval = await contract.methods.minSyncInterval().call();
                const currentDailyRate = await contract.methods.dailyRewardRate().call();
                const currentDailyLimit = await contract.methods.maxDailyLOMPerUser().call();
                
                let newSyncInterval, newDailyRate, newDailyLimit;
                
                switch (type) {
                    case 'syncInterval':
                        newSyncInterval = value * 3600; // 转换为秒
                        newDailyRate = currentDailyRate;
                        newDailyLimit = currentDailyLimit;
                        break;
                    case 'dailyRate':
                        newSyncInterval = currentSyncInterval;
                        newDailyRate = value;
                        newDailyLimit = currentDailyLimit;
                        break;
                    case 'dailyLimit':
                        newSyncInterval = currentSyncInterval;
                        newDailyRate = currentDailyRate;
                        newDailyLimit = web3.utils.toWei(value, 'ether');
                        break;
                }
                
                if (!confirm(`确定要更新参数吗？\n\n新值: ${value}`)) {
                    return;
                }
                
                // 创建可执行合约实例
                const walletWeb3 = new Web3(window.ethereum);
                const executableContract = new walletWeb3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                
                const gas = await executableContract.methods.updateRewardParameters(
                    newSyncInterval,
                    newDailyRate,
                    newDailyLimit
                ).estimateGas({ from: userAddress });
                
                const tx = await executableContract.methods.updateRewardParameters(
                    newSyncInterval,
                    newDailyRate,
                    newDailyLimit
                ).send({ from: userAddress, gas });
                
                log(`参数更新成功: ${type} = ${value}`, 'success');
                log('交易哈希: ' + tx.transactionHash, 'info');
                
                // 清空输入框
                input.value = '';
                
                // 更新状态
                await updateContractStatus();
                
            } catch (error) {
                log(`参数更新失败: ${error.message}`, 'error');
                alert('更新失败: ' + error.message);
            }
        }
        
        // 存入LOM
        async function depositLOM() {
            if (!isAdmin || !userAddress) {
                alert('请先连接钱包并验证管理员权限');
                return;
            }
            
            const amount = document.getElementById('depositAmount').value.trim();
            
            if (!amount || amount <= 0) {
                alert('请输入有效的LOM数量');
                return;
            }
            
            if (!confirm(`确定要存入 ${amount} LOM 吗？`)) {
                return;
            }
            
            try {
                const amountWei = web3.utils.toWei(amount, 'ether');
                
                // 创建可执行合约实例
                const walletWeb3 = new Web3(window.ethereum);
                const executableContract = new walletWeb3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                
                const gas = await executableContract.methods.depositLOMRewards(amountWei)
                    .estimateGas({ from: userAddress });
                
                const tx = await executableContract.methods.depositLOMRewards(amountWei)
                    .send({ from: userAddress, gas });
                
                log(`成功存入 ${amount} LOM`, 'success');
                log('交易哈希: ' + tx.transactionHash, 'info');
                
                // 清空输入框
                document.getElementById('depositAmount').value = '';
                
                // 更新状态
                await updateContractStatus();
                
            } catch (error) {
                log(`存入失败: ${error.message}`, 'error');
                alert('存入失败: ' + error.message);
            }
        }
        
        // 提取超额LOM
        async function withdrawLOM() {
            if (!isAdmin || !userAddress) {
                alert('请先连接钱包并验证管理员权限');
                return;
            }
            
            const amount = document.getElementById('withdrawAmount').value.trim();
            
            if (!amount || amount <= 0) {
                alert('请输入有效的提取数量');
                return;
            }
            
            if (!confirm(`确定要提取 ${amount} LOM 吗？`)) {
                return;
            }
            
            try {
                const amountWei = web3.utils.toWei(amount, 'ether');
                
                // 创建可执行合约实例
                const walletWeb3 = new Web3(window.ethereum);
                const executableContract = new walletWeb3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                
                const gas = await executableContract.methods.emergencyWithdrawExcessLOM(amountWei)
                    .estimateGas({ from: userAddress });
                
                const tx = await executableContract.methods.emergencyWithdrawExcessLOM(amountWei)
                    .send({ from: userAddress, gas });
                
                log(`成功提取 ${amount} LOM`, 'success');
                log('交易哈希: ' + tx.transactionHash, 'info');
                
                // 清空输入框
                document.getElementById('withdrawAmount').value = '';
                
                // 更新状态
                await updateContractStatus();
                
            } catch (error) {
                log(`提取失败: ${error.message}`, 'error');
                alert('提取失败: ' + error.message);
            }
        }
        
        // 记录日志
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logItem = document.createElement('div');
            logItem.className = 'log-item ' + type;
            logItem.textContent = `[${timestamp}] ${message}`;
            
            const logsDiv = document.getElementById('logs');
            logsDiv.appendChild(logItem);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            // 限制日志数量
            if (logsDiv.children.length > 50) {
                logsDiv.removeChild(logsDiv.firstChild);
            }
        }
        
        // 缩短地址显示
        function shortenAddress(address) {
            if (!address) return '';
            return address.substring(0, 6) + '...' + address.substring(address.length - 4);
        }
    </script>
</body>
  </html>
