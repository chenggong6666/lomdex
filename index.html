<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOMswap</title>
  
  <!-- 收藏图标和社交媒体标签 -->
  <link rel="icon" type="image/x-icon" href="https://i.imgur.com/HddyTrv.jpeg">
  <link rel="apple-touch-icon" href="https://i.imgur.com/HddyTrv.jpeg">
  <link rel="shortcut icon" href="https://i.imgur.com/HddyTrv.jpeg">
  
  <!-- Open Graph 标签，用于社交媒体分享 -->
  <meta property="og:title" content="LOMswap - Conflux 去中心化交易所">
  <meta property="og:description" content="在 Conflux eSpace 上交易 LOM 代币">
  <meta property="og:image" content="https://i.imgur.com/HddyTrv.jpeg">
  <meta property="og:url" content="https://lom-dex.com">
  <meta name="twitter:card" content="summary_large_image">
  
  <!-- 安全策略 (优化版本) -->
  <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self' https:;
                 script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval';
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' https://i.imgur.com data:;
                 connect-src 'self' https://*.confluxrpc.com wss: blob:;
                 font-src 'self' data:;
                 frame-src 'none';
                 object-src 'none';">
  
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    /* ========== 基础样式 ========== */
    :root {
      --primary-dark: #0d1117;
      --primary-blue: #1a73e8;
      --accent-purple: #8a2be2;
      --accent-yellow: #ffd700;
      --accent-red: #ff4757;
      --accent-green: #2ea043;
      --card-bg: #161b22;
      --card-bg-light: #1c2128;
      --border-color: #30363d;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --success: #2ea043;
      --warning: #ff6b6b;
      --gradient-primary: linear-gradient(135deg, #1a73e8, #8a2be2);
      --gradient-yellow: linear-gradient(135deg, #ffd700, #ffa500);
      --gradient-red: linear-gradient(135deg, #ff4757, #ff6b81);
      --gradient-green: linear-gradient(135deg, #2ea043, #3ddc84);
      --gradient-card: linear-gradient(135deg, rgba(26, 115, 232, 0.1), rgba(138, 43, 226, 0.05));
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent !important;
    }
    
    *:focus {
      outline: none !important;
      box-shadow: none !important;
    }
    
    body {
      background: var(--primary-dark);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Segoe UI Emoji', sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(26, 115, 232, 0.05) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(138, 43, 226, 0.05) 0%, transparent 40%);
    }
    
    .app {
      width: 100%;
      max-width: 480px;
      animation: fadeIn 0.5s ease-out;
    }

    /* ========== 项目介绍弹窗 ========== */
    .project-intro-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(13, 17, 23, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease-out;
    }
    
    .project-intro-overlay.show {
      display: flex;
    }
    
    .project-intro-card {
      background: var(--card-bg);
      border-radius: 24px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      border: 2px solid var(--accent-yellow);
      box-shadow: 0 20px 50px rgba(255, 215, 0, 0.2);
      position: relative;
      animation: slideUp 0.4s ease-out;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .project-intro-header {
      text-align: center;
      margin-bottom: 25px;
    }
    
    .project-intro-logo {
      width: 100px;
      height: 100px;
      margin: 0 auto 20px;
      border-radius: 50%;
      background-image: url('https://i.imgur.com/HddyTrv.jpeg');
      background-size: cover;
      background-position: center;
      border: 3px solid var(--accent-yellow);
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
    }
    
    .project-intro-title {
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 10px;
      background: var(--gradient-yellow);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
    }
    
    .project-intro-subtitle {
      font-size: 18px;
      color: var(--accent-yellow);
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .project-intro-slogan {
      font-size: 14px;
      color: var(--text-secondary);
      font-style: italic;
    }
    
    .project-intro-content {
      margin-bottom: 25px;
    }
    
    .project-intro-section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 215, 0, 0.2);
    }
    
    .project-intro-section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: var(--accent-yellow);
      font-size: 18px;
      font-weight: 700;
    }
    
    .project-intro-section-icon {
      font-size: 24px;
    }
    
    .project-intro-section-content {
      color: var(--text-primary);
      line-height: 1.6;
      font-size: 15px;
    }
    
    .project-intro-section-content ul {
      padding-left: 20px;
      margin-top: 10px;
    }
    
    .project-intro-section-content li {
      margin-bottom: 8px;
      position: relative;
      padding-left: 20px;
    }
    
    .project-intro-section-content li:before {
      content: "✓";
      color: var(--success);
      font-weight: bold;
      position: absolute;
      left: 0;
    }
    
    .project-intro-features {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 20px 0;
    }
    
    .project-intro-feature {
      background: rgba(255, 215, 0, 0.1);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      border: 1px solid rgba(255, 215, 0, 0.3);
    }
    
    .project-intro-feature-icon {
      font-size: 20px;
      margin-bottom: 8px;
      display: block;
    }
    
    .project-intro-feature-text {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .project-intro-close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 10;
    }
    
    .project-intro-close-btn:hover {
      background: rgba(255, 215, 0, 0.2);
      color: var(--accent-yellow);
      transform: rotate(90deg);
    }
    
    .project-intro-footer {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .project-intro-footer-text {
      font-size: 13px;
      color: var(--text-secondary);
      text-align: center;
      line-height: 1.5;
    }
    
    /* ========== 头部样式优化 ========== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 0 10px;
      position: relative;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .logo-container:hover {
      transform: translateY(-2px);
    }
    
    .logo-img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-image: url('https://i.imgur.com/HddyTrv.jpeg');
      background-size: cover;
      background-position: center;
      border: 2px solid var(--accent-yellow);
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
    }
    
    .logo-text {
      font-size: 24px;
      font-weight: 900;
      background: var(--gradient-yellow);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }
    
    .wallet-section {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-shrink: 0;
      width: auto;
    }
    
    .header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      min-width: 180px;
      max-width: 220px;
    }
    
    .btn {
      background: var(--gradient-primary);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px 16px;
      font-size: 14px;
      height: 40px;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.2);
      overflow: hidden;
      text-overflow: ellipsis;
      flex-shrink: 0;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(26, 115, 232, 0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    #walletBtn {
      min-width: 110px !important;
      max-width: 110px !important;
      width: 110px !important;
    }
    
    #walletBtn.connected {
      background: rgba(46, 160, 67, 0.15);
      border: 1px solid var(--success);
      color: var(--success);
      font-size: 13px;
      min-width: 140px;
      max-width: 160px;
      padding: 10px 12px;
    }
    
    #walletBtn.connecting {
      background: rgba(255, 215, 0, 0.15);
      border: 1px solid var(--accent-yellow);
      color: var(--accent-yellow);
      min-width: 140px;
      max-width: 160px;
    }
    
    #langBtn {
      width: 40px;
      height: 40px;
      min-width: 40px;
      min-height: 40px;
      max-width: 40px;
      max-height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    /* ========== 标签页样式 ========== */
    .tab-container {
      margin-bottom: 20px;
    }
    
    .tabs {
      display: flex;
      background: var(--card-bg);
      border-radius: 16px;
      padding: 4px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .tab-btn {
      flex: 1;
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 16px;
      white-space: nowrap;
    }
    
    .tab-btn.active {
      background: var(--gradient-primary);
      color: white;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* ========== 卡片样式 ========== */
    .card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }
    
    .card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-yellow), transparent);
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card-title-icon {
      color: var(--accent-yellow);
      font-size: 20px;
    }
    
    /* ========== 交易界面样式 ========== */
    .swap-container {
      position: relative;
      padding: 2px 0;
    }
    
    .token-input-wrapper {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 12px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      position: relative;
      margin-bottom: 6px;
    }
    
    .token-input-wrapper.focused {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }
    
    .token-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      position: relative;
    }
    
    .balance-info {
      font-size: 12px;
      color: var(--text-secondary);
      transform: translateY(-4px);
    }
    
    .balance-amount {
      color: var(--accent-yellow);
      font-weight: 600;
      cursor: pointer;
    }
    
    .balance-amount:hover {
      text-decoration: underline;
    }
    
    .token-selector {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(26, 115, 232, 0.15);
      border: 1px solid rgba(26, 115, 232, 0.3);
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 100px;
      margin-bottom: -4px;
    }
    
    .token-selector:hover {
      background: rgba(26, 115, 232, 0.25);
      transform: translateY(-1px);
    }
    
    .token-logo {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 10px;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .token-symbol {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 14px;
    }
    
    .token-dropdown-arrow {
      color: var(--text-secondary);
      font-size: 10px;
    }
    
    .percentage-buttons {
      display: flex;
      gap: 4px;
      margin-top: 8px;
      margin-bottom: 12px;
      justify-content: flex-end;
    }
    
    .percent-btn {
      flex: none;
      width: 40px;
      padding: 6px;
      background: rgba(26, 115, 232, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .percent-btn:hover {
      background: rgba(26, 115, 232, 0.2);
      border-color: var(--primary-blue);
    }
    
    .percent-btn.active {
      background: var(--accent-yellow);
      color: #0f172a;
      border-color: var(--accent-yellow);
      font-weight: 700;
    }
    
    .amount-input-area {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    
    .amount-input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 24px;
      font-weight: 700;
      text-align: right;
      width: 100%;
      outline: none;
      font-family: 'SF Mono', Monaco, monospace;
      padding: 0;
    }
    
    .amount-input::placeholder {
      color: var(--text-muted);
    }

    .swap-center {
      position: relative;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: -6px 0;
      z-index: 10;
    }
    
    .swap-arrow-btn {
      background: transparent;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      color: var(--text-secondary);
      z-index: 2;
    }
    
    .swap-arrow-btn:hover {
      transform: rotate(180deg) scale(1.1);
      box-shadow: 0 6px 16px rgba(26, 115, 232, 0.4);
    }
    
    .swap-arrow-btn:active {
      transform: rotate(180deg) scale(0.95);
    }
    
    /* ========== 交易详情 ========== */
    .swap-details {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 12px 16px;
      margin: 16px 0;
      border: 1px solid var(--border-color);
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0;
      font-size: 12px;
    }
    
    .detail-row:not(:last-child) {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .detail-label {
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .detail-value {
      color: var(--text-primary);
      font-weight: 600;
      text-align: right;
      font-family: 'SF Mono', Monaco, monospace;
    }
    
    .detail-value.positive {
      color: var(--success);
    }
    
    .detail-value.negative {
      color: var(--warning);
    }
    
    /* ========== 滑点控制 ========== */
    .slippage-control {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }
    
    .slippage-options {
      display: flex;
      gap: 4px;
    }
    
    .slippage-btn {
      padding: 4px 8px;
      background: rgba(26, 115, 232, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-secondary);
      min-width: 35px;
      text-align: center;
    }
    
    .slippage-btn:hover {
      border-color: var(--primary-blue);
    }
    
    .slippage-btn.active {
      background: var(--accent-yellow);
      color: #0f172a;
      border-color: var(--accent-yellow);
      font-weight: 600;
    }
    
    /* ========== 主操作按钮 ========== */
    .main-action-btn {
      background: var(--gradient-primary);
      color: white;
      font-weight: 700;
      padding: 16px;
      border: none;
      border-radius: 16px;
      width: 100%;
      font-size: 16px;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(26, 115, 232, 0.3);
    }
    
    .main-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(26, 115, 232, 0.4);
    }
    
    .main-action-btn:active {
      transform: translateY(0);
    }
    
    .main-action-btn:disabled {
      background: #475569;
      color: var(--text-secondary);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* ========== 流动性页面样式 ========== */
    .liquidity-summary {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    
    .liquidity-pair {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .pair-logo {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .pair-logo.cfx {
      background-image: url('https://i.imgur.com/70cXbUI.jpeg');
    }
    
    .pair-logo.lom {
      background-image: url('https://i.imgur.com/HddyTrv.jpeg');
    }
    
    .pair-symbol {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .liquidity-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-label-small {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .stat-value-large {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .stat-value-large.positive {
      color: var(--accent-yellow);
    }
    
    .user-position {
      background: var(--gradient-card);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      border: 1px solid var(--border-color);
    }
    
    .position-actions {
      display: flex;
      gap: 8px;
    }
    
    .position-btn {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .add-btn {
      background: var(--gradient-primary);
      color: white;
    }
    
    .remove-btn {
      background: rgba(255, 71, 87, 0.15);
      color: var(--accent-red);
      border: 1px solid rgba(255, 71, 87, 0.3);
    }
    
    .remove-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .add-btn:hover, .remove-btn:hover:not(:disabled) {
      transform: translateY(-1px);
    }
    
    /* ========== LP奖励页面样式 ========== */
    .lp-reward-panel {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .lp-reward-card {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(138, 43, 226, 0.1));
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .lp-reward-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(255, 215, 0, 0.2);
    }
    
    .lp-reward-card-title {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .lp-reward-card-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.2;
    }
    
    .lp-reward-card-value.positive {
      color: var(--accent-yellow);
    }
    
    .lp-reward-card-value.warning {
      color: var(--accent-red);
    }
    
    .lp-reward-card-value.success {
      color: var(--success);
    }
    
    .lp-reward-stats {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    
    .lp-reward-stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .lp-reward-stat-row:last-child {
      border-bottom: none;
    }
    
    .lp-reward-stat-label {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .lp-reward-stat-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      font-family: 'SF Mono', Monaco, monospace;
    }
    
    .lp-reward-multiplier {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .lp-reward-multiplier-item {
      background: rgba(26, 115, 232, 0.1);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      border: 1px solid rgba(26, 115, 232, 0.2);
      transition: all 0.3s ease;
    }
    
    .lp-reward-multiplier-item.active {
      background: rgba(255, 215, 0, 0.2);
      border-color: var(--accent-yellow);
      transform: scale(1.05);
    }
    
    .lp-reward-multiplier-days {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .lp-reward-multiplier-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .lp-reward-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .lp-reward-action-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .lp-reward-action-btn.activate {
      background: var(--gradient-yellow);
      color: #0f172a;
    }
    
    .lp-reward-action-btn.claim {
      background: var(--gradient-primary);
      color: white;
    }
    
    .lp-reward-action-btn.referral {
      background: var(--gradient-green);
      color: white;
    }
    
    .lp-reward-action-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .lp-reward-action-btn:disabled {
      background: #475569;
      color: var(--text-secondary);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .lp-reward-referral {
      background: rgba(46, 160, 67, 0.1);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
      border: 1px solid rgba(46, 160, 67, 0.3);
    }
    
    .lp-reward-referral-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .lp-reward-referral-icon {
      color: var(--success);
      font-size: 18px;
    }
    
    .lp-reward-referral-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .lp-reward-referral-input {
      width: 100%;
      padding: 10px 14px;
      background: rgba(46, 160, 67, 0.05);
      border: 1px solid rgba(46, 160, 67, 0.3);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
      outline: none;
      transition: all 0.3s ease;
      margin-bottom: 12px;
    }
    
    .lp-reward-referral-input:focus {
      border-color: var(--success);
      box-shadow: 0 0 0 2px rgba(46, 160, 67, 0.1);
    }
    
    .lp-reward-referral-info {
      font-size: 11px;
      color: var(--text-secondary);
      text-align: center;
      line-height: 1.4;
    }
    
    .lp-reward-help {
      background: rgba(26, 115, 232, 0.1);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
      border: 1px solid rgba(26, 115, 232, 0.3);
    }
    
    .lp-reward-help-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .lp-reward-help-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .lp-reward-help-item {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      line-height: 1.4;
    }
    
    .lp-reward-help-item:last-child {
      margin-bottom: 0;
    }
    
    .lp-reward-help-icon {
      color: var(--primary-blue);
      font-size: 12px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    /* ========== 警告和计时器样式 ========== */
    .lp-reward-warning {
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), rgba(255, 107, 129, 0.05));
      border: 1px solid var(--accent-red);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    
    .lp-reward-warning-icon {
      color: var(--accent-red);
      font-size: 16px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    .lp-reward-warning-text {
      font-size: 12px;
      color: var(--text-primary);
      line-height: 1.4;
    }
    
    .lp-reward-timer {
      background: linear-gradient(135deg, rgba(26, 115, 232, 0.1), rgba(138, 43, 226, 0.05));
      border: 1px solid rgba(26, 115, 232, 0.3);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .lp-reward-timer-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    
    .lp-reward-timer-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary-blue);
      font-family: 'SF Mono', Monaco, monospace;
    }
    
    /* ========== 质押卡片 ========== */
    .stake-card {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(138, 43, 226, 0.1));
      border-radius: 16px;
      padding: 16px;
      margin: 16px 0;
      border: 1px solid var(--border-color);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .stake-title {
      font-size: 18px;
      font-weight: bold;
      color: var(--accent-yellow);
      margin-bottom: 8px;
    }
    
    .stake-description {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .stake-apr {
      font-size: 28px;
      font-weight: bold;
      color: var(--text-primary);
      margin-bottom: 16px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    /* ========== 邀请系统 ========== */
    .invite-section {
      background: rgba(255, 215, 0, 0.1);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      margin: 12px 0;
    }
    
    .invite-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .invite-icon {
      color: var(--accent-yellow);
      font-size: 20px;
    }
    
    .invite-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .invite-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 16px;
      line-height: 1.4;
      text-align: center;
    }
    
    .invite-input-container {
      position: relative;
      margin-bottom: 12px;
    }
    
    .invite-input {
      width: 100%;
      padding: 12px 14px;
      background: rgba(26, 115, 232, 0.05);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 13px;
      outline: none;
      transition: all 0.3s ease;
    }
    
    .invite-input:focus {
      border-color: var(--accent-yellow);
      box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.1);
    }
    
    .invite-input::placeholder {
      color: var(--text-muted);
    }
    
    .invite-input-error {
      border-color: var(--accent-red) !important;
      background: rgba(255, 71, 87, 0.05) !important;
    }
    
    .invite-error-text {
      color: var(--accent-red);
      font-size: 11px;
      margin-top: 4px;
      display: none;
    }
    
    .invite-error-text.show {
      display: block;
    }
    
    .invite-benefits {
      background: rgba(46, 160, 67, 0.1);
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
      border: 1px solid rgba(46, 160, 67, 0.3);
    }
    
    .benefit-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--success);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .benefit-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .benefit-item {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
      display: flex;
      align-items: flex-start;
      gap: 6px;
    }
    
    .benefit-item:last-child {
      margin-bottom: 0;
    }
    
    .benefit-icon {
      color: var(--success);
      font-size: 10px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    .invite-note {
      font-size: 11px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 10px;
      line-height: 1.4;
      padding: 8px;
      background: rgba(255, 215, 0, 0.05);
      border-radius: 6px;
      border: 1px dashed rgba(255, 215, 0, 0.3);
    }
    
    .invite-note-icon {
      color: var(--accent-yellow);
      font-size: 12px;
      margin-right: 4px;
    }
    
    .invite-locked {
      background: rgba(46, 160, 67, 0.1);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--success);
      margin: 12px 0;
      animation: fadeIn 0.5s ease;
    }
    
    .invite-locked-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .invite-locked-text {
      font-size: 14px;
      color: var(--success);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .locked-icon {
      font-size: 16px;
    }
    
    .invite-address-container {
      background: rgba(46, 160, 67, 0.15);
      border-radius: 10px;
      padding: 12px;
      margin: 12px 0;
      text-align: center;
      border: 1px solid rgba(46, 160, 67, 0.3);
    }
    
    .invite-address-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    
    .invite-address {
      font-size: 13px;
      color: var(--text-primary);
      font-weight: 600;
      word-break: break-all;
      padding: 8px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      font-family: 'SF Mono', Monaco, monospace;
    }
    
    .invite-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    
    .invite-action-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .unlock-btn {
      background: rgba(255, 215, 0, 0.1);
      color: var(--accent-yellow);
      border: 1px solid rgba(255, 215, 0, 0.3);
    }
    
    .stake-btn {
      background: var(--gradient-yellow);
      color: #0f172a;
    }
    
    .invite-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    /* ========== 模态框样式 ========== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(13, 17, 23, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease-out;
    }
    
    .modal-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      border: 1px solid var(--border-color);
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease-out;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .modal-input-group {
      margin-bottom: 12px;
    }
    
    .modal-input-label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    
    .modal-input {
      width: 100%;
      padding: 12px 14px;
      background: rgba(26, 115, 232, 0.05);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
      transition: all 0.2s ease;
    }
    
    .modal-input:focus {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .modal-btn.cancel {
      background: var(--card-bg);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }
    
    .modal-btn.confirm {
      background: var(--gradient-primary);
      color: white;
    }
    
    /* ========== 代币选择器 ========== */
    .token-selector-modal {
      position: fixed;
      inset: 0;
      background: rgba(13, 17, 23, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease-out;
    }
    
    .token-selector-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      border: 1px solid var(--border-color);
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease-out;
    }
    
    .token-search {
      width: 100%;
      padding: 10px 14px;
      background: rgba(26, 115, 232, 0.05);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 14px;
      margin-bottom: 12px;
      outline: none;
      transition: all 0.2s ease;
    }
    
    .token-search:focus {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }
    
    .token-search:hover {
      border-color: var(--accent-yellow);
    }
    
    .token-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .token-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .token-item:hover {
      background: rgba(26, 115, 232, 0.1);
      transform: translateX(4px);
    }
    
    .token-item-logo {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 2px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.2s ease;
    }
    
    .token-item:hover .token-item-logo {
      transform: scale(1.1);
    }
    
    .token-item-info {
      flex: 1;
      min-width: 0;
    }
    
    .token-item-symbol {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: color 0.2s ease;
    }
    
    .token-item:hover .token-item-symbol {
      color: var(--accent-yellow);
    }
    
    .token-item-name {
      font-size: 11px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .token-item-balance {
      font-size: 13px;
      color: var(--text-primary);
      font-weight: 600;
      min-width: 60px;
      text-align: right;
    }
    
    /* ========== 交易状态提示 ========== */
    .transaction-status {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--gradient-primary);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 8px 24px rgba(26, 115, 232, 0.4);
      z-index: 3000;
      transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      max-width: 90%;
      text-align: center;
    }
    
    .transaction-status.show {
      transform: translateX(-50%) translateY(0);
    }
    
    .transaction-status.success {
      background: var(--gradient-green);
    }
    
    .transaction-status.error {
      background: var(--gradient-red);
    }
    
    /* ========== 交易状态弹窗 ========== */
    .tx-status-overlay {
      position: fixed;
      inset: 0;
      background: rgba(13, 17, 23, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease-out;
    }
    
    .tx-status-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      max-width: 350px;
      text-align: center;
      border: 1px solid var(--border-color);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease-out;
    }
    
    .tx-status-icon {
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .tx-status-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .tx-status-message {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .tx-status-done-btn {
      background: var(--gradient-primary);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
    }
    
    .tx-status-done-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }
    
    /* ========== 风险提示和页脚 ========== */
    .risk-warning {
      background: var(--gradient-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 16px;
      margin: 16px 0;
      text-align: center;
      font-size: 11px;
      color: var(--text-primary);
      line-height: 1.5;
      position: relative;
      overflow: hidden;
    }
    
    .risk-title {
      font-weight: 700;
      margin-bottom: 6px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      color: var(--accent-yellow);
    }
    
    .footer {
      text-align: center;
      padding: 16px 0;
      color: var(--text-secondary);
      font-size: 12px;
      opacity: 0.7;
    }
    
    /* ========== 动画 ========== */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ========== 加载动画 ========== */
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid rgba(26, 115, 232, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-blue);
      animation: spin 1s linear infinite;
    }
    
    .loading-spinner.small {
      width: 20px;
      height: 20px;
      border-width: 2px;
    }
    
    .loading-spinner.white {
      border-color: rgba(255, 255, 255, 0.3);
      border-top-color: white;
    }
    
    /* ========== 错误提示框 ========== */
    .error-box {
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), rgba(255, 71, 87, 0.05));
      border: 1px solid var(--accent-red);
      border-radius: 10px;
      padding: 10px 14px;
      margin: 10px 0;
      font-size: 12px;
      color: var(--accent-red);
      display: none;
    }
    
    .error-box.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    .error-icon {
      display: inline-block;
      margin-right: 6px;
    }
    
    /* ========== 移除流动性弹窗 ========== */
    .remove-percentage {
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      color: var(--text-primary);
      margin: 8px 0;
    }
    
    .percentage-slider {
      width: 100%;
      margin: 16px 0;
      -webkit-appearance: none;
      height: 6px;
      background: rgba(26, 115, 232, 0.1);
      border-radius: 3px;
      outline: none;
    }
    
    .percentage-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--gradient-primary);
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(26, 115, 232, 0.3);
    }
    
    .percentage-options {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }
    
    .percentage-option {
      padding: 8px;
      text-align: center;
      background: rgba(26, 115, 232, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-secondary);
      font-size: 12px;
    }
    
    .percentage-option:hover {
      border-color: var(--primary-blue);
    }
    
    .percentage-option.active {
      background: var(--accent-yellow);
      color: #0f172a;
      border-color: var(--accent-yellow);
      font-weight: 600;
    }
    
    .remove-estimate {
      background: rgba(26, 115, 232, 0.1);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      border: 1px solid var(--border-color);
    }
    
    .remove-estimate-title {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }
    
    .remove-estimate-amounts {
      font-size: 16px;
      font-weight: bold;
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .remove-estimate-amount {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    
    .token-amount-display {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 15px;
    }
    
    /* ========== 简单确认对话框 ========== */
    .simple-confirm-modal .modal-card {
      max-width: 350px;
    }
    
    .confirm-summary {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
      border: 1px solid var(--border-color);
    }
    
    .confirm-icon {
      font-size: 48px;
      margin-bottom: 12px;
      display: block;
    }
    
    .confirm-action {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .confirm-amounts {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 16px 0;
    }
    
    .confirm-amount-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    
    .confirm-amount-logo {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .confirm-amount-text {
      font-size: 20px;
      font-weight: bold;
      color: var(--text-primary);
      font-family: 'SF Mono', Monaco, monospace;
    }
    
    .confirm-details-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 16px;
    }
    
    .confirm-detail-item {
      text-align: left;
      padding: 8px;
      background: rgba(26, 115, 232, 0.05);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }
    
    .confirm-detail-label {
      font-size: 10px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .confirm-detail-value {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .confirm-actions-simple {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .confirm-action-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
    }
    
    .confirm-action-btn.cancel {
      background: var(--card-bg);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }
    
    .confirm-action-btn.confirm {
      background: var(--gradient-primary);
      color: white;
    }
    
    .confirm-action-btn.confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }
    
    .confirm-action-btn.cancel:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    /* ========== 邀请确认对话框 ========== */
    .invite-confirm-modal .modal-card {
      max-width: 380px;
      text-align: center;
    }
    
    .invite-confirm-icon {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--accent-yellow);
    }
    
    .invite-confirm-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 12px;
      color: var(--text-primary);
    }
    
    .invite-confirm-message {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .invite-confirm-details {
      background: rgba(255, 215, 0, 0.1);
      border-radius: 12px;
      padding: 16px;
      margin: 20px 0;
      border: 1px solid rgba(255, 215, 0, 0.3);
      text-align: left;
    }
    
    .invite-confirm-detail {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .invite-confirm-detail:last-child {
      border-bottom: none;
    }
    
    .invite-confirm-label {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .invite-confirm-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      font-family: 'SF Mono', Monaco, monospace;
    }
    
    .invite-confirm-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .invite-confirm-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
    }
    
    .invite-confirm-btn.cancel {
      background: var(--card-bg);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }
    
    .invite-confirm-btn.confirm {
      background: var(--gradient-yellow);
      color: #0f172a;
    }
    
    .invite-confirm-btn.confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    }
    
    /* ========== LP奖励激活弹窗 ========== */
    .lp-reward-activate-modal .modal-card {
      max-width: 380px;
      text-align: center;
    }
    
    .lp-reward-activate-icon {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--accent-yellow);
    }
    
    .lp-reward-activate-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 12px;
      color: var(--text-primary);
    }
    
    .lp-reward-activate-message {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .lp-reward-activate-requirements {
      background: rgba(255, 215, 0, 0.1);
      border-radius: 12px;
      padding: 16px;
      margin: 20px 0;
      border: 1px solid rgba(255, 215, 0, 0.3);
      text-align: left;
    }
    
    .lp-reward-activate-requirement {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .lp-reward-activate-requirement:last-child {
      border-bottom: none;
    }
    
    .lp-reward-activate-requirement-icon {
      font-size: 14px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .lp-reward-activate-requirement-icon.valid {
      background: rgba(46, 160, 67, 0.2);
      color: var(--success);
    }
    
    .lp-reward-activate-requirement-icon.invalid {
      background: rgba(255, 71, 87, 0.2);
      color: var(--accent-red);
    }
    
    .lp-reward-activate-requirement-text {
      font-size: 13px;
      color: var(--text-primary);
      flex: 1;
    }
    
    .lp-reward-activate-details {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .lp-reward-activate-detail {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .lp-reward-activate-detail:last-child {
      border-bottom: none;
    }
    
    .lp-reward-activate-detail-label {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .lp-reward-activate-detail-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      font-family: 'SF Mono', Monaco, monospace;
      text-align: right;
    }
    
    .lp-reward-activate-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .lp-reward-activate-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
    }
    
    .lp-reward-activate-btn.cancel {
      background: var(--card-bg);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }
    
    .lp-reward-activate-btn.confirm {
      background: var(--gradient-yellow);
      color: #0f172a;
    }
    
    .lp-reward-activate-btn.confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
    }
    
    .lp-reward-activate-btn:disabled {
      background: #475569;
      color: var(--text-secondary);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* ========== 响应式调整 ========== */
    @media (max-width: 480px) {
      .app {
        padding: 0;
      }
      
      .card {
        margin: 10px;
        padding: 14px;
      }
      
      .header {
        padding: 10px;
        margin-bottom: 16px;
      }
      
      .logo-img {
        width: 44px;
        height: 44px;
      }
      
      .logo-text {
        font-size: 18px;
      }
      
      .header-buttons {
        min-width: 150px;
        max-width: 180px;
      }
      
      #walletBtn {
        min-width: 120px;
        max-width: 140px;
        padding: 8px 12px;
        font-size: 12px;
        height: 36px;
      }
      
      #langBtn {
        width: 36px;
        height: 36px;
        min-width: 36px;
        min-height: 36px;
        max-width: 36px;
        max-height: 36px;
        font-size: 12px;
      }
      
      .tab-btn {
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .modal-card {
        padding: 16px;
      }
      
      .transaction-status {
        bottom: 60px;
      }
      
      .invite-actions {
        flex-direction: column;
      }
      
      .invite-action-btn {
        width: 100%;
      }
      
      .project-intro-card {
        padding: 20px;
      }
      
      .project-intro-title {
        font-size: 24px;
      }
      
      .project-intro-features {
        grid-template-columns: 1fr;
      }
      
      .lp-reward-actions {
        flex-direction: column;
      }
    }
    
    @media (max-width: 380px) {
      .logo-text {
        font-size: 16px;
      }
      
      .logo-img {
        width: 36px;
        height: 36px;
      }
      
      .header-buttons {
        min-width: 130px;
        max-width: 150px;
      }
      
      #walletBtn {
        min-width: 100px;
        max-width: 120px;
        font-size: 11px;
        padding: 6px 10px;
      }
      
      #langBtn {
        width: 32px;
        height: 32px;
        min-width: 32px;
        min-height: 32px;
        max-width: 32px;
        max-height: 32px;
      }
      
      .lp-reward-multiplier {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- 项目介绍弹窗 -->
  <div class="project-intro-overlay" id="projectIntroOverlay">
    <div class="project-intro-card">
      <button class="project-intro-close-btn" id="projectIntroCloseBtn">×</button>
      
      <div class="project-intro-header">
        <div class="project-intro-logo"></div>
        <h1 class="project-intro-title">龙脉 LOM</h1>
        <div class="project-intro-subtitle">Conflux.生态核心资产</div>
        <div class="project-intro-slogan">共识创造价值</div>
      </div>
      
      <div class="project-intro-content">
        <div class="project-intro-section">
          <div class="project-intro-section-title">
            <span class="project-intro-section-icon">🐉</span>
            <span>关于龙脉LOM</span>
          </div>
          <div class="project-intro-section-content">
            <p>龙脉LOM灵感源自中国传统文化中的"龙脉"概念，象征着财富、繁荣和能量的流动。是深度赋能中国唯一合规公链——树图（Conflux）的生态核心资产，更是链接公链价值、用户收益与生态繁荣的关键纽带，依托公链优势构建专属价值闭环，为参与者带来确定性回报。</p>
            <p>作为树图公链的赋能载体，LOM深度绑定公链核心优势：这条由清华团队打造的"conflux数字龙脉"，以合规为根，串联40国节点与"一带一路"跨境场景，更兼容以太坊生态。从RWA资产上链到稳定币结算，它正以自主可控的技术底气，承接全球Web3.0爆发浪潮，让中国公链力量贯通数字未来。15000TPS超高性能、26秒极速确认的技术底座，以及5000+全球节点、2500万用户的成熟生态，让每一份LOM质押都能依托公链合规资质与真实应用场景，实现价值锚定与稳步增长。</p>
            <p>其核心价值聚焦锁定质押+二代奖励的生态激励机制，精准匹配树图公链发展需求：用户通过锁定LOM参与质押，不仅能深度享受树图公链生态扩张、技术升级带来的长期质押收益，更能依托"赋能公链"的核心定位，通过邀请分享解锁丰厚二代奖励，让收益随生态辐射持续放大。这种模式既为树图公链注入稳定的生态动力，也让用户成为公链发展的直接受益者，实现"质押享红利，分享赚奖励"的双重价值。</p>
            
            <ul>
              <li><strong>总供应量</strong>：88888888枚（永不增发）</li>
              <li><strong>底层技术</strong>：基于Conflux eSpace智能合约</li>
              <li><strong>治理模式</strong>：完全去中心化，社区驱动</li>
              <li><strong>经济模型</strong>：通缩机制 + 流动性激励</li>
            </ul>
          </div>
        </div>
        
        <div class="project-intro-features">
          <div class="project-intro-feature">
            <span class="project-intro-feature-icon">⚡</span>
            <div class="project-intro-feature-text">总量稀缺</div>
          </div>
          <div class="project-intro-feature">
            <span class="project-intro-feature-icon">🛡️</span>
            <div class="project-intro-feature-text">去中心化</div>
          </div>
          <div class="project-intro-feature">
            <span class="project-intro-feature-icon">📈</span>
            <div class="project-intro-feature-text">高收益率</div>
          </div>
          <div class="project-intro-feature">
            <span class="project-intro-feature-icon">🌐</span>
            <div class="project-intro-feature-text">全球交易</div>
          </div>
        </div>
        
        <div class="project-intro-section">
          <div class="project-intro-section-title">
            <span class="project-intro-section-icon">🎯</span>
            <span>核心价值</span>
          </div>
          <div class="project-intro-section-content">
            <ul>
              <li><strong>价值存储</strong>：深度绑定公链价值确保价值增长</li>
              <li><strong>流动性核心</strong>：作为DEX交易对的基准资产</li>
              <li><strong>治理权益</strong>：持有者共同参与生态治理决策</li>
              <li><strong>收益生成</strong>：通过质押和流动性挖矿获得收益</li>
            </ul>
          </div>
        </div>
        
        <div class="project-intro-section">
          <div class="project-intro-section-title">
            <span class="project-intro-section-icon">🚀</span>
            <span>LOMswap功能</span>
          </div>
          <div class="project-intro-section-content">
            <p>在LOMswap上，您可以：</p>
            <ul>
              <li><strong>兑换交易</strong>：在CFX-LOM-USDC-USDT0-AxCNH之间快速兑换</li>
              <li><strong>提供流动性</strong>：添加CFX-LOM流动性赚取手续费</li>
              <li><strong>质押挖矿</strong>：质押锁仓LP代币获得高达45.8%年化收益</li>
              <li><strong>邀请奖励</strong>：邀请好友参与质押获得二级额外收益加成</li>
            </ul>
          </div>
        </div>
      </div>
      
      <div class="project-intro-footer">
        <div class="project-intro-footer-text">
          💡 提示：请确保已安装TP或web3钱包，并切换到Conflux eSpace网络（ChainID: 1030）
        </div>
      </div>
    </div>
  </div>

  <!-- 原有应用界面 -->
  <div class="app">
    <!-- 头部 -->
    <div class="header">
      <div class="logo-container" id="logoContainer">
        <div class="logo-img"></div>
        <div class="logo-text">LOMswap</div>
      </div>
      <div class="header-buttons">
        <button class="btn" id="langBtn">EN</button>
        <button class="btn" id="walletBtn">连接钱包</button>
      </div>
    </div>

    <!-- 标签页 -->
    <div class="tab-container">
      <div class="tabs">
        <button class="tab-btn active" data-tab="swap">兑换</button>
        <button class="tab-btn" data-tab="liquidity">流动性</button>
        <button class="tab-btn" data-tab="lpReward">LP奖励</button>
      </div>
    </div>

    <!-- 兑换页面 -->
    <div class="tab-content active" id="swapTab">
      <div class="card">
        <div class="swap-container">
          <!-- 输入代币 -->
          <div class="token-input-wrapper" id="fromTokenWrapper">
            <div class="token-header">
              <div class="balance-info">
                余额: <span class="balance-amount" id="fromBal">0</span>
              </div>
              <div class="token-selector" id="fromTokenSelector">
                <div class="token-logo" id="fromTokenLogo" style="background-image: url('https://i.imgur.com/70cXbUI.jpeg');"></div>
                <div class="token-symbol" id="fromTokenSymbol">CFX</div>
                <div class="token-dropdown-arrow">▼</div>
              </div>
            </div>
            
            <div class="percentage-buttons">
              <button class="percent-btn" data-percent="0.25">25%</button>
              <button class="percent-btn" data-percent="0.5">50%</button>
              <button class="percent-btn" data-percent="1">MAX</button>
            </div>
            
            <div class="amount-input-area">
              <input class="amount-input" id="fromAmount" placeholder="0" type="number" min="0" step="any">
            </div>
          </div>

          <!-- 交换箭头 -->
          <div class="swap-center">
            <button class="swap-arrow-btn" id="reverse">🔃</button>
          </div>

          <!-- 输出代币 -->
          <div class="token-input-wrapper" id="toTokenWrapper">
            <div class="token-header">
              <div class="balance-info">
                余额: <span class="balance-amount" id="toBal">0</span>
              </div>
              <div class="token-selector" id="toTokenSelector">
                <div class="token-logo" id="toTokenLogo" style="background-image: url('https://i.imgur.com/HddyTrv.jpeg');"></div>
                <div class="token-symbol" id="toTokenSymbol">LOM</div>
                <div class="token-dropdown-arrow">▼</div>
              </div>
            </div>
            
            <div class="amount-input-area">
              <input class="amount-input" id="toAmount" placeholder="0" type="number" min="0" step="any" readonly>
            </div>
          </div>

          <!-- 错误提示框 -->
          <div class="error-box" id="swapErrorBox">
            <span class="error-icon">⚠️</span>
            <span id="swapErrorText"></span>
          </div>

          <!-- 交易详情 -->
          <div class="swap-details">
            <div class="detail-row">
              <span class="detail-label">滑点容差</span>
              <div class="slippage-options">
                <button class="slippage-btn active" data-slip="0.1">0.1%</button>
                <button class="slippage-btn" data-slip="0.5">0.5%</button>
                <button class="slippage-btn" data-slip="5">5%</button>
                <button class="slippage-btn" data-slip="10">10%</button>
              </div>
            </div>
            <div class="detail-row">
              <span class="detail-label">价格</span>
              <span class="detail-value" id="price">1 CFX = 0 LOM</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">最低收到</span>
              <span class="detail-value" id="minReceived">0 LOM</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">路由</span>
              <span class="detail-value" id="routeInfo">CFX → LOM</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">价格影响</span>
              <span class="detail-value positive" id="priceImpact">< 0.01%</span>
            </div>
          </div>

          <!-- 交易按钮 -->
          <button class="main-action-btn" id="swapBtn">连接钱包</button>
        </div>
      </div>
    </div>
    
    <!-- 流动性页面 -->
    <div class="tab-content" id="liquidityTab">
      <div class="card">
        <div class="card-title">
          <span class="card-title-icon">💧</span>
          <span id="poolInfoTitle">CFX-LOM 池</span>
        </div>

        <div class="liquidity-summary">
          <!-- 池子统计信息 -->
          <div class="liquidity-pair">
            <div class="pair-logo cfx"></div>
            <div class="pair-symbol">+</div>
            <div class="pair-logo lom"></div>
            <div class="pair-symbol">CFX-LOM</div>
          </div>
          
          <div class="liquidity-stats">
            <div class="stat-item">
              <div class="stat-label-small" id="cfxReserveLabel">CFX 储备</div>
              <div class="stat-value-large" id="cfxReserve">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label-small" id="lomReserveLabel">LOM 储备</div>
              <div class="stat-value-large" id="lomReserve">0</div>
            </div>
          </div>
          
          <!-- 我的流动池详情 -->
          <div class="user-position">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);" id="myPositionTitle">我的流动池</div>
              <div style="font-size: 12px; color: var(--text-secondary);" id="positionValue">$0.00</div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <div style="text-align: center;">
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;" id="myCfxLabel">我的CFX</div>
                <div style="font-size: 16px; font-weight: 700; color: var(--accent-yellow);" id="userCfx">0</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;" id="myLomLabel">我的LOM</div>
                <div style="font-size: 16px; font-weight: 700; color: var(--accent-yellow);" id="userLom">0</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;" id="myLpLabel">我的LP代币</div>
                <div style="font-size: 16px; font-weight: 700; color: var(--text-primary);" id="userLp">0</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;" id="myShareLabel">池子份额</div>
                <div style="font-size: 16px; font-weight: 700; color: var(--success);" id="userPoolShare">0%</div>
              </div>
            </div>
          </div>

          <div class="position-actions">
            <button class="position-btn add-btn" id="addBtn">添加流动性</button>
            <button class="position-btn remove-btn" id="removeBtn" disabled>移除流动性</button>
          </div>
        </div>
      </div>
    </div>

    <!-- LP奖励页面 -->
    <div class="tab-content" id="lpRewardTab">
      <div class="card">
        <div class="card-title">
          <span class="card-title-icon">🏆</span>
          <span>LP持币奖励</span>
        </div>

        <!-- 激活状态面板 -->
        <div id="activationStatusPanel">
          <div class="lp-reward-panel">
            <div class="lp-reward-card">
              <div class="lp-reward-card-title">
                <span>📊</span>
                <span>激活状态</span>
              </div>
              <div class="lp-reward-card-value" id="activationStatus">未激活</div>
            </div>
            
            <div class="lp-reward-card">
              <div class="lp-reward-card-title">
                <span>💰</span>
                <span>LP持仓</span>
              </div>
              <div class="lp-reward-card-value" id="lpBalance">0 LPT</div>
            </div>
            
            <div class="lp-reward-card">
              <div class="lp-reward-card-title">
                <span>⏱️</span>
                <span>持有时长</span>
              </div>
              <div class="lp-reward-card-value" id="daysHeld">0 天</div>
            </div>
            
            <div class="lp-reward-card">
              <div class="lp-reward-card-title">
                <span>🚀</span>
                <span>奖励倍率</span>
              </div>
              <div class="lp-reward-card-value success" id="rewardMultiplier">1.0x</div>
            </div>
          </div>
        </div>

        <!-- 奖励信息面板 -->
        <div class="lp-reward-stats">
          <div class="lp-reward-stat-row">
            <div class="lp-reward-stat-label">
              <span>💎</span>
              <span>待领取奖励</span>
            </div>
            <div class="lp-reward-stat-value" id="pendingReward">0 LOM</div>
          </div>
          
          <div class="lp-reward-stat-row">
            <div class="lp-reward-stat-label">
              <span>📈</span>
              <span>每日预估收益</span>
            </div>
            <div class="lp-reward-stat-value" id="dailyReward">0 LOM</div>
          </div>
          
          <div class="lp-reward-stat-row">
            <div class="lp-reward-stat-label">
              <span>⏰</span>
              <span>下次领取时间</span>
            </div>
            <div class="lp-reward-stat-value" id="nextClaimTime">--</div>
          </div>
          
          <div class="lp-reward-stat-row">
            <div class="lp-reward-stat-label">
              <span>⚡</span>
              <span>推荐奖励</span>
            </div>
            <div class="lp-reward-stat-value success" id="pendingReferral">0 LOM</div>
          </div>
        </div>

        <!-- 时间倍率系统 -->
        <div class="lp-reward-multiplier">
          <div class="lp-reward-multiplier-item" id="multiplier30d">
            <div class="lp-reward-multiplier-days">30天</div>
            <div class="lp-reward-multiplier-value">1.0x</div>
          </div>
          
          <div class="lp-reward-multiplier-item" id="multiplier90d">
            <div class="lp-reward-multiplier-days">90天</div>
            <div class="lp-reward-multiplier-value">1.5x</div>
          </div>
          
          <div class="lp-reward-multiplier-item" id="multiplier180d">
            <div class="lp-reward-multiplier-days">180天</div>
            <div class="lp-reward-multiplier-value">2.0x</div>
          </div>
          
          <div class="lp-reward-multiplier-item" id="multiplier360d">
            <div class="lp-reward-multiplier-days">360天</div>
            <div class="lp-reward-multiplier-value">3.0x</div>
          </div>
        </div>

        <!-- LP持仓监控 -->
        <div id="lpMonitorPanel">
          <div class="lp-reward-warning" id="lpWarning" style="display: none;">
            <div class="lp-reward-warning-icon">⚠️</div>
            <div class="lp-reward-warning-text" id="lpWarningText"></div>
          </div>
          
          <div class="lp-reward-timer" id="cooldownTimer" style="display: none;">
            <div class="lp-reward-timer-label">减持冷却剩余</div>
            <div class="lp-reward-timer-value" id="cooldownTime">00:00:00</div>
          </div>
        </div>

        <!-- 主操作按钮 -->
        <div class="lp-reward-actions">
          <button class="lp-reward-action-btn activate" id="activateBtn" disabled>
            <span>🚀</span>
            <span>激活奖励</span>
          </button>
          
          <button class="lp-reward-action-btn claim" id="claimBtn" disabled>
            <span>💰</span>
            <span>领取奖励</span>
          </button>
          
          <button class="lp-reward-action-btn referral" id="claimReferralBtn" disabled>
            <span>🎁</span>
            <span>领取推荐</span>
          </button>
        </div>

        <!-- 推荐系统 -->
        <div class="lp-reward-referral" id="referralSection">
          <div class="lp-reward-referral-header">
            <span class="lp-reward-referral-icon">👥</span>
            <span class="lp-reward-referral-title">推荐系统</span>
          </div>
          
          <input type="text" class="lp-reward-referral-input" id="referrerAddress" 
                 placeholder="输入推荐人地址 (可选)">
          
          <div class="lp-reward-referral-info">
            绑定推荐人可享受额外5%奖励加成，推荐奖励锁定30天
          </div>
        </div>

        <!-- 帮助信息 -->
        <div class="lp-reward-help">
          <div class="lp-reward-help-title">
            <span>❓</span>
            <span>重要提示</span>
          </div>
          <ul class="lp-reward-help-list">
            <li class="lp-reward-help-item">
              <span class="lp-reward-help-icon">✓</span>
              <span>持有时长越长，奖励倍率越高（最高3倍）</span>
            </li>
            <li class="lp-reward-help-item">
              <span class="lp-reward-help-icon">✓</span>
              <span>30天内减持LP将失去推荐资格</span>
            </li>
            <li class="lp-reward-help-item">
              <span class="lp-reward-help-icon">✓</span>
              <span>减持有50%惩罚，单次最多减持30%</span>
            </li>
            <li class="lp-reward-help-item">
              <span class="lp-reward-help-icon">✓</span>
              <span>减持后需等待24小时冷却</span>
            </li>
            <li class="lp-reward-help-item">
              <span class="lp-reward-help-icon">✓</span>
              <span>每7天可领取一次奖励</span>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- 风险提示 -->
    <div class="risk-warning" id="riskWarning">
      <div class="risk-title">
        <span>⚠️</span>
        <span id="riskTitle">风险提示</span>
      </div>
      <div id="riskText">
        本应用仅作为技术演示，不构成任何投资建议。加密货币市场波动巨大，投资需谨慎，请理性对待数字资产交易。
      </div>
    </div>

    <!-- 页脚 -->
    <div class="footer" id="footerText">LOMswap · Conflux eSpace</div>
  </div>

  <!-- 代币选择器模态框 -->
  <div class="token-selector-modal" id="tokenSelectorModal">
    <div class="token-selector-card">
      <h3 class="modal-title" id="tokenSelectorTitle">选择代币</h3>
      <input type="text" class="token-search" id="tokenSearch" placeholder="搜索代币名称或地址">
      <div class="token-list" id="tokenList">
        <!-- 代币列表将通过JS动态生成 -->
      </div>
    </div>
  </div>

  <!-- 添加流动性模态框 -->
  <div class="modal-overlay" id="addModal">
    <div class="modal-card">
      <h3 class="modal-title" id="addTitle">添加流动性</h3>
      
      <div class="modal-input-group">
        <label class="modal-input-label">CFX 数量</label>
        <div style="display: flex; gap: 8px;">
          <input type="number" class="modal-input" id="addCfx" placeholder="0" step="any" min="0">
          <button class="btn" id="cfxMaxBtn" style="height: auto; padding: 8px 12px; min-width: 50px; font-size: 12px;">MAX</button>
        </div>
        <div style="text-align: right; margin-top: 4px; font-size: 11px; color: var(--text-secondary);">
          余额: <span id="addCfxBal">0</span> CFX
        </div>
      </div>
      
      <div style="text-align: center; font-size: 20px; color: var(--text-primary); margin: 12px 0;">+</div>
      
      <div class="modal-input-group">
        <label class="modal-input-label">LOM 数量</label>
        <div style="display: flex; gap: 8px;">
          <input type="number" class="modal-input" id="addLom" placeholder="0" step="any" min="0">
          <button class="btn" id="lomMaxBtn" style="height: auto; padding: 8px 12px; min-width: 50px; font-size: 12px;">MAX</button>
        </div>
        <div style="text-align: right; margin-top: 4px; font-size: 11px; color: var(--text-secondary);">
          余额: <span id="addLomBal">0</span> LOM
        </div>
      </div>
      
      <div style="background: rgba(26, 115, 232, 0.1); border-radius: 10px; padding: 10px; margin: 12px 0; text-align: center;">
        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">比例</div>
        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); word-break: break-all;" id="addRatio">1 CFX = 0 LOM</div>
      </div>
      
      <div class="modal-actions">
        <button class="modal-btn cancel" id="cancelAddBtn">取消</button>
        <button class="modal-btn confirm" id="confirmAddBtn" disabled>确认添加</button>
      </div>
    </div>
  </div>

  <!-- 移除流动性模态框 -->
  <div class="modal-overlay" id="removeModal">
    <div class="modal-card">
      <h3 class="modal-title" id="removeTitle">移除流动性</h3>
      
      <div>
        <div class="remove-percentage">
          <span id="removePercent">100%</span>
        </div>
        
        <input type="range" min="0" max="100" value="100" step="1" class="percentage-slider" id="removeSlider">
        
        <div class="percentage-options">
          <div class="percentage-option" data-percent="25">25%</div>
          <div class="percentage-option" data-percent="50">50%</div>
          <div class="percentage-option" data-percent="75">75%</div>
          <div class="percentage-option active" data-percent="100">100%</div>
        </div>
        
        <div class="remove-estimate">
          <div class="remove-estimate-title">预计获得</div>
          <div class="remove-estimate-amounts">
            <div class="remove-estimate-amount">
              <span class="token-amount-display" id="removeEstCfx">0</span> CFX
            </div>
            <div class="remove-estimate-amount">
              <span class="token-amount-display" id="removeEstLom">0</span> LOM
            </div>
          </div>
        </div>
        
        <div class="modal-actions">
          <button class="modal-btn cancel" id="cancelRemoveBtn">取消</button>
          <button class="modal-btn confirm" id="confirmRemoveBtn" style="background: var(--gradient-red);">确认移除</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LP奖励激活确认弹窗 -->
  <div class="modal-overlay lp-reward-activate-modal" id="lpRewardActivateModal">
    <div class="modal-card">
      <div class="lp-reward-activate-icon">🚀</div>
      <div class="lp-reward-activate-title" id="lpRewardActivateTitle">激活LP奖励</div>
      <div class="lp-reward-activate-message" id="lpRewardActivateMessage">
        请确认激活信息，激活后即可开始赚取LP持币奖励
      </div>
      
      <div class="lp-reward-activate-requirements" id="lpRewardRequirements">
        <!-- 激活要求将由JS动态生成 -->
      </div>
      
      <div class="lp-reward-activate-details">
        <div class="lp-reward-activate-detail">
          <span class="lp-reward-activate-detail-label">您的LP余额</span>
          <span class="lp-reward-activate-detail-value" id="activateLpBalance">0 LPT</span>
        </div>
        <div class="lp-reward-activate-detail">
          <span class="lp-reward-activate-detail-label">最小激活要求</span>
          <span class="lp-reward-activate-detail-value" id="minActivationRequired">100 LPT</span>
        </div>
        <div class="lp-reward-activate-detail">
          <span class="lp-reward-activate-detail-label">推荐人地址</span>
          <span class="lp-reward-activate-detail-value" id="activateReferrerAddress">无</span>
        </div>
        <div class="lp-reward-activate-detail">
          <span class="lp-reward-activate-detail-label">初始倍率</span>
          <span class="lp-reward-activate-detail-value success">1.0x</span>
        </div>
      </div>
      
      <div class="lp-reward-activate-actions">
        <button class="lp-reward-activate-btn cancel" id="lpRewardActivateCancelBtn">取消</button>
        <button class="lp-reward-activate-btn confirm" id="lpRewardActivateConfirmBtn" disabled>确认激活</button>
      </div>
    </div>
  </div>

  <!-- 简单交易确认模态框 -->
  <div class="modal-overlay simple-confirm-modal" id="simpleConfirmModal">
    <div class="modal-card">
      <div class="confirm-summary">
        <div class="confirm-icon" id="simpleConfirmIcon">🔄</div>
        <div class="confirm-action" id="simpleConfirmAction">兑换确认</div>
        <div class="confirm-amounts" id="simpleConfirmAmounts">
          <!-- 金额信息由JS动态生成 -->
        </div>
        <div class="confirm-details-grid" id="simpleConfirmDetails">
          <!-- 详细信息由JS动态生成 -->
        </div>
      </div>
      <div class="confirm-actions-simple">
        <button class="confirm-action-btn cancel" id="simpleCancelBtn">取消</button>
        <button class="confirm-action-btn confirm" id="simpleConfirmBtn">确认交易</button>
      </div>
    </div>
  </div>

  <!-- 交易状态提示 -->
  <div class="tx-status-overlay" id="txStatusOverlay">
    <div class="tx-status-card">
      <div class="tx-status-icon" id="txStatusIcon">
        <div class="loading-spinner white"></div>
      </div>
      <div class="tx-status-title" id="txStatusTitle">交易处理中</div>
      <div class="tx-status-message" id="txStatusMessage">请等待区块链确认...</div>
      <button class="tx-status-done-btn" id="txStatusDoneBtn" style="display:none;">完成</button>
    </div>
  </div>

  <!-- 邀请确认对话框 -->
  <div class="modal-overlay invite-confirm-modal" id="inviteConfirmModal">
    <div class="modal-card">
      <div class="invite-confirm-icon" id="inviteConfirmIcon">🔗</div>
      <div class="invite-confirm-title" id="inviteConfirmTitle">确认绑定邀请地址</div>
      <div class="invite-confirm-message" id="inviteConfirmMessage">
        请确认以下信息，绑定后邀请地址将无法更改。
      </div>
      
      <div class="invite-confirm-details">
        <div class="invite-confirm-detail">
          <span class="invite-confirm-label">您的钱包地址</span>
          <span class="invite-confirm-value" id="confirmMyAddress"></span>
        </div>
        <div class="invite-confirm-detail">
          <span class="invite-confirm-label">邀请人地址</span>
          <span class="invite-confirm-value" id="confirmInviteAddress"></span>
        </div>
        <div class="invite-confirm-detail">
          <span class="invite-confirm-label">预计年化收益</span>
          <span class="invite-confirm-value">45.8% APY</span>
        </div>
        <div class="invite-confirm-detail">
          <span class="invite-confirm-label">质押奖励</span>
          <span class="invite-confirm-value">额外奖励代币</span>
        </div>
      </div>
      
      <div class="invite-confirm-actions">
        <button class="invite-confirm-btn cancel" id="inviteConfirmCancelBtn">取消</button>
        <button class="invite-confirm-btn confirm" id="inviteConfirmBtn">确认绑定</button>
      </div>
    </div>
  </div>

  <script>
    'use strict';

    // ==================== 统一配置 ====================
    const APP_CONFIG = {
      CONTRACTS: {
        ROUTER: "0x62b0873055bf896dd869e172119871ac24aea305",
        LOM: "0xb4ca1cb2651a822bf65c614c880a26fd124932a3",
        WCFX: "0x14b2d3bc65e74dae1030eafd8ac30c533c976a9b",
        PAIR: "0x063128f4e6BDFBC693d03649000B6E4dA00Bec85",
        USDC: "0x6963efed0ab40f6c3d7bda44a05dcf1437c44372",
        AXCNH: "0x70BFD7F7eADF9b9827541272589A6B2Bb760aE2E",
        USDT0: "0xaf37e8b6c9ed7f6318979f56fc287d76c30847ff",
        CNHT0: "0xDEd1660192d4d82e7c0B628ba556861EdBB5CAda",
        AXCNH_USDT0_PAIR: "0x50b095DF7a8f856C6fA07fF89bcBC2dF8491A8df",
        LP_REWARD: "0x233f9C12514A29d860e482eB29f1EE1f8fcC59aa"
      },
      TOKEN_LOGOS: {
        CFX: "https://i.imgur.com/70cXbUI.jpeg",
        LOM: "https://i.imgur.com/HddyTrv.jpeg",
        USDC: "https://i.imgur.com/9UDXcUF.jpeg",
        AXCNH: "https://i.imgur.com/x8317um.jpeg",
        USDT0: "https://i.imgur.com/KgnTsn1.jpeg",
        CNHT0: "https://i.imgur.com/zObg9RY.jpeg"
      },
      CHAIN_ID: 1030
    };

    // ==================== 应用状态 ====================
    let provider, signer, account;
    let router, pair, lom, usdc, axcnh, usdt0, cnht0, axcnhUsdt0Pair, lpRewardContract;
    let slippage = 0.1;
    let isChinese = true;
    let currentRatio = 0;
    let fromToken = "CFX";
    let toToken = "LOM";
    let refreshInterval;
    let currentTokenSelector = null;
    let transactionLock = false;
    let currentReserves = { cfx: 0, lom: 0 };
    let lastInputWasFrom = true;
    let inviteAddress = localStorage.getItem('lomswap_invite_address') || '';
    let walletInviteMap = JSON.parse(localStorage.getItem('lomswap_wallet_invite_map') || '{}');
    let lpRewardUserInfo = null;
    let lpRewardContractInfo = null;
    let lpBalance = 0;
    let cooldownInterval = null;

    // ==================== 核心代币列表 ====================
    const TOKEN_LIST = [
      {
        symbol: "CFX",
        name: "Conflux",
        address: APP_CONFIG.CONTRACTS.WCFX,
        logo: APP_CONFIG.TOKEN_LOGOS.CFX,
        decimals: 18,
        isNative: true
      },
      {
        symbol: "LOM",
        name: "Longmai",
        address: APP_CONFIG.CONTRACTS.LOM,
        logo: APP_CONFIG.TOKEN_LOGOS.LOM,
        decimals: 18
      },
      {
        symbol: "USDC",
        name: "USD Coin",
        address: APP_CONFIG.CONTRACTS.USDC,
        logo: APP_CONFIG.TOKEN_LOGOS.USDC,
        decimals: 18
      },
      {
        symbol: "AXCNH",
        name: "AxCNH",
        address: APP_CONFIG.CONTRACTS.AXCNH,
        logo: APP_CONFIG.TOKEN_LOGOS.AXCNH,
        decimals: 6
      },
      {
        symbol: "USDT0",
        name: "Tether USD (Test)",
        address: APP_CONFIG.CONTRACTS.USDT0,
        logo: APP_CONFIG.TOKEN_LOGOS.USDT0,
        decimals: 6
      },
      {
        symbol: "CNHT0",
        name: "CNH Token (Test)",
        address: APP_CONFIG.CONTRACTS.CNHT0,
        logo: APP_CONFIG.TOKEN_LOGOS.CNHT0,
        decimals: 6
      }
    ];

    // ==================== 工具模块 ====================
    const Utils = {
      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },

      simpleFormat(value) {
        if (!value && value !== 0) return '0.000000';
        const num = parseFloat(value);
        if (isNaN(num)) return '0.000000';
        const truncated = Math.floor(num * 1000000) / 1000000;
        const parts = truncated.toString().split('.');
        let integerPart = parts[0];
        let decimalPart = parts[1] || '';
        if (decimalPart.length < 6) {
          decimalPart = decimalPart.padEnd(6, '0');
        } else if (decimalPart.length > 6) {
          decimalPart = decimalPart.substring(0, 6);
        }
        return integerPart + '.' + decimalPart;
      },

      removeTrailingZeros(str) {
        if (!str.includes('.')) return str;
        let result = str.replace(/0+$/, '');
        if (result.endsWith('.')) {
          result = result.slice(0, -1);
        }
        return result;
      },

      formatDisplay(value) {
        const formatted = this.simpleFormat(value);
        return this.removeTrailingZeros(formatted);
      },

      formatAddress(address) {
        if (!address) return '';
        return address.slice(0, 4) + '...' + address.slice(-6);
      },

      isValidAddress(address) {
        return /^0x[a-fA-F0-9]{40}$/.test(address);
      },

      showError(message) {
        const errorBox = document.getElementById('swapErrorBox');
        const errorText = document.getElementById('swapErrorText');
        errorText.textContent = message;
        errorBox.classList.add('show');
        setTimeout(() => {
          errorBox.classList.remove('show');
        }, 5000);
      },

      showNotification(message, type = 'info') {
        const status = document.getElementById('txStatusOverlay');
        const icon = document.getElementById('txStatusIcon');
        const title = document.getElementById('txStatusTitle');
        const msg = document.getElementById('txStatusMessage');
        const doneBtn = document.getElementById('txStatusDoneBtn');
        
        const statusConfig = {
          info: { 
            icon: '<div class="loading-spinner white"></div>', 
            title: isChinese ? '处理中' : 'Processing' 
          },
          success: { 
            icon: '✅', 
            title: isChinese ? '操作成功' : 'Success' 
          },
          error: { 
            icon: '❌', 
            title: isChinese ? '操作失败' : 'Failed' 
          }
        };
        
        const config = statusConfig[type] || statusConfig.info;
        icon.innerHTML = config.icon;
        title.textContent = config.title;
        msg.textContent = message;
        
        if (type === 'success' || type === 'error') {
          doneBtn.style.display = 'block';
        } else {
          doneBtn.style.display = 'none';
        }
        
        status.style.display = 'flex';
      },

      hideNotification() {
        document.getElementById('txStatusOverlay').style.display = 'none';
        document.querySelectorAll('button').forEach(btn => {
          btn.disabled = false;
        });
      },

      getErrorMessage(error) {
        const message = error.message || error.toString();
        const errorMap = {
          'user rejected': isChinese ? '用户取消了交易' : 'Transaction rejected by user',
          'INSUFFICIENT_OUTPUT_AMOUNT': isChinese ? '输出数量不足，请提高滑点容差' : 'Insufficient output amount, increase slippage',
          'INSUFFICIENT_INPUT_AMOUNT': isChinese ? '输入数量不足' : 'Insufficient input amount',
          'insufficient funds': isChinese ? '余额不足' : 'Insufficient balance',
          'allowance': isChinese ? '请先授权代币' : 'Please approve token first',
          'deadline': isChinese ? '交易超时，请重试' : 'Transaction expired, please try again',
          'Not enough liquidity': isChinese ? '流动性不足' : 'Insufficient liquidity',
          'execution reverted': isChinese ? '交易执行失败' : 'Transaction execution failed',
          'reverted': isChinese ? '交易失败' : 'Transaction failed'
        };
        
        for (const [key, value] of Object.entries(errorMap)) {
          if (message.toLowerCase().includes(key.toLowerCase())) {
            return value;
          }
        }
        return isChinese ? '交易失败，请重试' : 'Transaction failed, please try again';
      },

      formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
    };

    // ==================== 代币工具模块 ====================
    const TokenUtils = {
      getToken(symbol) {
        return TOKEN_LIST.find(t => t.symbol === symbol);
      },

      getTokenDecimals(symbol) {
        const token = this.getToken(symbol);
        return token ? token.decimals : 18;
      },

      getTokenContract(symbol) {
        const tokenContracts = {
          "LOM": lom,
          "USDC": usdc,
          "AXCNH": axcnh,
          "USDT0": usdt0,
          "CNHT0": cnht0
        };
        return tokenContracts[symbol] || null;
      },

      formatTokenAmount(amount, symbol) {
        const decimals = this.getTokenDecimals(symbol);
        try {
          const formatted = ethers.utils.formatUnits(amount, decimals);
          return Utils.formatDisplay(formatted);
        } catch {
          return '0.000000';
        }
      },

      parseTokenAmount(amount, symbol) {
        const decimals = this.getTokenDecimals(symbol);
        try {
          return ethers.utils.parseUnits(amount.toString(), decimals);
        } catch {
          return ethers.BigNumber.from(0);
        }
      }
    };

    // ==================== 项目介绍弹窗功能 ====================
    (function initProjectIntro() {
      const logoContainer = document.getElementById('logoContainer');
      const projectIntroOverlay = document.getElementById('projectIntroOverlay');
      const projectIntroCloseBtn = document.getElementById('projectIntroCloseBtn');
      
      logoContainer.addEventListener('click', function() {
        projectIntroOverlay.classList.add('show');
      });
      
      projectIntroCloseBtn.addEventListener('click', function() {
        projectIntroOverlay.classList.remove('show');
      });
      
      projectIntroOverlay.addEventListener('click', function(e) {
        if (e.target === projectIntroOverlay) {
          projectIntroOverlay.classList.remove('show');
        }
      });
      
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && projectIntroOverlay.classList.contains('show')) {
          projectIntroOverlay.classList.remove('show');
        }
      });
    })();

    // ==================== 合约ABI定义 ====================
    const ROUTER_ABI = [
      "function getAmountsOut(uint amountIn, address[] path) view returns (uint[] memory amounts)",
      "function swapExactETHForTokensSupportingFeeOnTransferTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) payable",
      "function swapExactTokensForETHSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline)",
      "function swapExactTokensForTokensSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline)",
      "function addLiquidityETH(address token, uint amountTokenDesired, uint amountTokenMin, uint amountETHMin, address to, uint deadline) payable returns (uint amountToken, uint amountETH, uint liquidity)",
      "function removeLiquidityETHSupportingFeeOnTransferTokens(address token, uint liquidity, uint amountTokenMin, uint amountETHMin, address to, uint deadline) returns (uint amountETH)",
      "function removeLiquidityETH(address token, uint liquidity, uint amountTokenMin, uint amountETHMin, address to, uint deadline) returns (uint amountToken, uint amountETH)"
    ];

    const ERC20_ABI = [
      "function approve(address spender, uint256 amount) returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function balanceOf(address owner) view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function name() view returns (string)",
      "function symbol() view returns (string)",
      "function totalSupply() view returns (uint256)"
    ];

    const PAIR_ABI = [
      "function getReserves() view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)",
      "function totalSupply() view returns (uint256)",
      "function balanceOf(address owner) view returns (uint256)",
      "function token0() view returns (address)",
      "function token1() view returns (address)",
      "function approve(address spender, uint256 amount) returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)"
    ];

    // 更新后的LP奖励ABI，包含完整的链上监控功能
    const LP_REWARD_ABI = [
      "function lpToken() view returns (address)",
      "function rewardToken() view returns (address)",
      "function admin() view returns (address)",
      "function paused() view returns (bool)",
      "function minActivation() view returns (uint256)",
      "function totalShares() view returns (uint256)",
      "function accRewardPerShare() view returns (uint256)",
      "function lastRewardTime() view returns (uint256)",
      "function rewardPerSecond() view returns (uint256)",
      "function totalRewards() view returns (uint256)",
      "function totalReferralRewards() view returns (uint256)",
      "function totalActiveUsers() view returns (uint256)",
      "function users(address) view returns (uint256 shares, uint256 rewardDebt, uint256 pendingReferral, uint256 lastClaimTime, uint256 activeTime, uint256 lastReduceTime, uint256 referralUnlockTime, address referrer, bool cleanInFirst30Days)",
      "function pendingReward(address user) view returns (uint256)",
      "function activate(address referrer) external",
      "function claimAll() external",
      "function claimReferral() external",
      "function emergencyWithdraw() external",
      "function updatePool() external",
      "event Activated(address indexed user, address indexed referrer, uint256 shares)",
      "event Claimed(address indexed user, uint256 amount)",
      "event ReferralClaimed(address indexed user, uint256 amount)"
    ];

    // ==================== 核心功能模块 ====================
    class AppCore {
      static async connectWallet() {
        try {
          if (!window.ethereum) {
            Utils.showError(isChinese ? "请安装TP或web3钱包" : "Please install TP or WEB3 wallet");
            return false;
          }
          
          const walletBtn = document.getElementById('walletBtn');
          walletBtn.textContent = isChinese ? '连接中...' : 'Connecting...';
          walletBtn.classList.add('connecting');
          
          const accounts = await window.ethereum.request({
            method: 'eth_requestAccounts'
          });
          
          if (!accounts || accounts.length === 0) {
            throw new Error(isChinese ? '用户拒绝连接' : 'User rejected connection');
          }
          
          account = accounts[0];
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          
          await this.checkNetwork();
          this.initContracts();
          this.restoreInviteAddress();
          this.updateUI();
          
          if (refreshInterval) clearInterval(refreshInterval);
          refreshInterval = setInterval(() => {
            DataManager.refreshAll();
            LPRewardManager.refreshUserInfo();
          }, 10000);
          
          Utils.showNotification(
            isChinese ? '钱包连接成功' : 'Wallet connected successfully',
            'success'
          );
          
          return true;
        } catch (error) {
          console.error("钱包连接失败:", error);
          Utils.showError(
            isChinese ? `连接失败: ${error.message}` : `Connection failed: ${error.message}`
          );
          return false;
        } finally {
          this.updateUI();
        }
      }

      static async checkNetwork() {
        const network = await provider.getNetwork();
        if (network.chainId !== APP_CONFIG.CHAIN_ID) {
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0x' + APP_CONFIG.CHAIN_ID.toString(16) }]
            });
          } catch (error) {
            if (error.code === 4902) {
              Utils.showError(isChinese ? '请添加Conflux eSpace网络' : 'Please add Conflux eSpace network');
            } else {
              Utils.showError(isChinese ? '请切换到Conflux eSpace网络' : 'Please switch to Conflux eSpace network');
            }
            throw error;
          }
        }
      }

      static initContracts() {
        router = new ethers.Contract(APP_CONFIG.CONTRACTS.ROUTER, ROUTER_ABI, signer);
        pair = new ethers.Contract(APP_CONFIG.CONTRACTS.PAIR, PAIR_ABI, signer);
        lom = new ethers.Contract(APP_CONFIG.CONTRACTS.LOM, ERC20_ABI, signer);
        usdc = new ethers.Contract(APP_CONFIG.CONTRACTS.USDC, ERC20_ABI, signer);
        axcnh = new ethers.Contract(APP_CONFIG.CONTRACTS.AXCNH, ERC20_ABI, signer);
        usdt0 = new ethers.Contract(APP_CONFIG.CONTRACTS.USDT0, ERC20_ABI, signer);
        cnht0 = new ethers.Contract(APP_CONFIG.CONTRACTS.CNHT0, ERC20_ABI, signer);
        axcnhUsdt0Pair = new ethers.Contract(APP_CONFIG.CONTRACTS.AXCNH_USDT0_PAIR, PAIR_ABI, signer);
        
        // 初始化LP奖励合约 - 修复：使用只读provider来监控数据
        if (APP_CONFIG.CONTRACTS.LP_REWARD) {
          const contractProvider = signer || provider;
          lpRewardContract = new ethers.Contract(
            APP_CONFIG.CONTRACTS.LP_REWARD,
            LP_REWARD_ABI,
            contractProvider
          );
        }
      }

      static restoreInviteAddress() {
        if (account && walletInviteMap[account.toLowerCase()]) {
          inviteAddress = walletInviteMap[account.toLowerCase()];
        } else {
          inviteAddress = '';
        }
      }

      static updateUI() {
        const walletBtn = document.getElementById("walletBtn");
        const swapBtn = document.getElementById("swapBtn");
        
        walletBtn.classList.remove('connecting');
        
        if (account) {
          const displayAddress = Utils.formatAddress(account);
          walletBtn.textContent = displayAddress;
          walletBtn.classList.add('connected');
          swapBtn.textContent = isChinese ? "请输入数量" : "Enter Amount";
          swapBtn.disabled = false;
        } else {
          walletBtn.textContent = isChinese ? "连接钱包" : "Connect Wallet";
          walletBtn.classList.remove('connected');
          swapBtn.textContent = isChinese ? "连接钱包" : "Connect Wallet";
          swapBtn.disabled = false;
        }
      }

      static disconnect() {
        account = null;
        provider = null;
        signer = null;
        router = null;
        pair = null;
        lom = null;
        usdc = null;
        axcnh = null;
        usdt0 = null;
        cnht0 = null;
        axcnhUsdt0Pair = null;
        lpRewardContract = null;
        
        if (refreshInterval) {
          clearInterval(refreshInterval);
          refreshInterval = null;
        }
        
        if (cooldownInterval) {
          clearInterval(cooldownInterval);
          cooldownInterval = null;
        }
        
        this.updateUI();
        DataManager.resetAllData();
        LPRewardManager.resetUserInfo();
        
        Utils.showNotification(
          isChinese ? "钱包已断开连接" : "Wallet disconnected",
          'success'
        );
      }
    }

    // ==================== 数据管理器 ====================
    const DataManager = {
      async refreshAll() {
        if (!account) return;
        try {
          await this.updateAllBalances();
          await this.updatePoolInfo();
          this.updateSwapButtonState();
        } catch (error) {
          console.error('刷新数据失败:', error);
        }
      },

      async updateAllBalances() {
        if (!account) return;
        
        try {
          const balancePromises = TOKEN_LIST.map(async (token) => {
            try {
              let balance = 0;
              
              if (token.symbol === 'CFX' && provider) {
                const cfxBal = await provider.getBalance(account);
                balance = parseFloat(ethers.utils.formatEther(cfxBal));
              } else {
                const contract = TokenUtils.getTokenContract(token.symbol);
                if (contract) {
                  const tokenBal = await contract.balanceOf(account);
                  balance = parseFloat(ethers.utils.formatUnits(tokenBal, token.decimals));
                }
              }
              
              return { symbol: token.symbol, balance };
            } catch (error) {
              console.error(`获取 ${token.symbol} 余额失败:`, error);
              return { symbol: token.symbol, balance: 0 };
            }
          });
          
          const balances = await Promise.all(balancePromises);
          
          balances.forEach(({ symbol, balance }) => {
            this.updateBalanceUI(symbol, balance);
          });
          
          // 更新流动性页面的余额显示
          const cfxBal = balances.find(b => b.symbol === 'CFX')?.balance || 0;
          const lomBal = balances.find(b => b.symbol === 'LOM')?.balance || 0;
          
          document.getElementById("addCfxBal").textContent = Utils.formatDisplay(cfxBal);
          document.getElementById("addLomBal").textContent = Utils.formatDisplay(lomBal);
          
          // 检查LP代币 - 修复：实时监控LP余额变化
          if (pair && account) {
            try {
              const lpBal = await pair.balanceOf(account);
              const lpAmt = parseFloat(ethers.utils.formatUnits(lpBal, 18));
              
              // 监控LP余额变化，如果有变化则刷新奖励信息
              const oldLpBalance = lpBalance;
              lpBalance = lpAmt;
              
              document.getElementById("removeBtn").disabled = lpBal.isZero();
              
              // 如果LP余额有变化且用户已激活奖励，刷新奖励信息
              if (Math.abs(oldLpBalance - lpBalance) > 0.001 && lpRewardUserInfo) {
                LPRewardManager.refreshUserInfo();
              }
              
              // 如果当前在LP奖励页面，强制刷新
              if (document.getElementById('lpRewardTab').classList.contains('active')) {
                LPRewardManager.refreshUserInfo();
              }
            } catch (error) {
              console.error("获取LP余额失败:", error);
            }
          }
          
        } catch (error) {
          console.error("更新余额失败:", error);
        }
      },

      updateBalanceUI(symbol, balance) {
        const formattedBalance = Utils.formatDisplay(balance);
        
        if (symbol === fromToken) {
          const fromBalEl = document.getElementById('fromBal');
          if (fromBalEl) fromBalEl.textContent = formattedBalance;
        }
        
        if (symbol === toToken) {
          const toBalEl = document.getElementById('toBal');
          if (toBalEl) toBalEl.textContent = formattedBalance;
        }
        
        const selectorBalanceEl = document.getElementById(`selectorBalance-${symbol}`);
        if (selectorBalanceEl) {
          selectorBalanceEl.textContent = formattedBalance;
        }
      },

      async updatePoolInfo() {
        try {
          if (!pair || !account) return;
          
          const [r0, r1] = await pair.getReserves();
          const t0 = await pair.token0();
          const totalSupply = await pair.totalSupply();
          
          const reserveCfx = t0.toLowerCase() === APP_CONFIG.CONTRACTS.WCFX.toLowerCase() ? r0 : r1;
          const reserveLom = t0.toLowerCase() === APP_CONFIG.CONTRACTS.WCFX.toLowerCase() ? r1 : r0;
          
          const cfxReserve = parseFloat(ethers.utils.formatEther(reserveCfx));
          const lomReserve = parseFloat(ethers.utils.formatUnits(reserveLom, 18));
          
          currentReserves.cfx = cfxReserve;
          currentReserves.lom = lomReserve;
          
          const price = lomReserve / cfxReserve;
          currentRatio = price;
          
          const priceFormatted = Utils.formatDisplay(price);
          const priceText = isChinese ? 
            `${priceFormatted} LOM` : 
            `${priceFormatted} LOM`;
          document.getElementById("price").textContent = `1 CFX = ${priceText}`;
          document.getElementById("addRatio").textContent = `1 CFX = ${priceFormatted} LOM`;

          const totalSupplyNum = parseFloat(ethers.utils.formatUnits(totalSupply, 18));
          
          let lpAmt = 0;
          let share = 0;
          let userCfx = 0;
          let userLom = 0;
          
          const lpBal = await pair.balanceOf(account);
          lpAmt = parseFloat(ethers.utils.formatUnits(lpBal, 18));
          
          if (totalSupplyNum > 0 && lpAmt > 0) {
            share = (lpAmt / totalSupplyNum) * 100;
            userCfx = cfxReserve * (share / 100);
            userLom = lomReserve * (share / 100);
          }
          
          const cfxReserveEl = document.getElementById("cfxReserve");
          const lomReserveEl = document.getElementById("lomReserve");
          
          if (cfxReserveEl) cfxReserveEl.textContent = cfxReserve.toFixed(2);
          if (lomReserveEl) lomReserveEl.textContent = lomReserve.toFixed(2);
          
          const userCfxEl = document.getElementById("userCfx");
          const userLomEl = document.getElementById("userLom");
          const userLpEl = document.getElementById("userLp");
          const userPoolShareEl = document.getElementById("userPoolShare");
          
          if (userCfxEl) userCfxEl.textContent = userCfx.toFixed(2);
          if (userLomEl) userLomEl.textContent = userLom.toFixed(2);
          if (userLpEl) userLpEl.textContent = lpAmt.toFixed(2);
          if (userPoolShareEl) userPoolShareEl.textContent = share.toFixed(4) + "%";
          
          const poolTitle = isChinese ? 
            `CFX-LOM流动池` :
            `CFX-LOM Pool`;
          
          const poolInfoTitleEl = document.getElementById("poolInfoTitle");
          if (poolInfoTitleEl) poolInfoTitleEl.textContent = poolTitle;
          
          const removeBtn = document.getElementById("removeBtn");
          if (removeBtn) {
            removeBtn.disabled = lpAmt <= 0;
          }
          
        } catch (error) {
          console.error("更新池子信息失败:", error);
        }
      },

      updateSwapButtonState() {
        const swapBtn = document.getElementById("swapBtn");
        const fromAmount = document.getElementById("fromAmount").value;
        
        if (!account) {
          swapBtn.textContent = isChinese ? "连接钱包" : "Connect Wallet";
          swapBtn.disabled = false;
          return;
        }
        
        if (!fromAmount || fromAmount === "0" || fromAmount === "") {
          swapBtn.textContent = isChinese ? "请输入数量" : "Enter Amount";
          swapBtn.disabled = true;
          return;
        }
        
        swapBtn.textContent = isChinese ? "立即兑换" : "Swap Now";
        swapBtn.disabled = false;
      },

      resetAllData() {
        const elements = {
          'fromBal': '0.000000',
          'toBal': '0.000000',
          'addCfxBal': '0.000000',
          'addLomBal': '0.000000',
          'price': '1 CFX = 0.000000 LOM',
          'minReceived': '0.000000 LOM'
        };
        
        Object.keys(elements).forEach(id => {
          const element = document.getElementById(id);
          if (element) element.textContent = elements[id];
        });
        
        document.getElementById("fromAmount").value = "";
        document.getElementById("toAmount").value = "";
        document.getElementById("removeBtn").disabled = true;
      }
    };

    // ==================== LP奖励管理器 - 修复版 ====================
    const LPRewardManager = {
      async refreshUserInfo() {
        if (!account || !lpRewardContract) {
          this.resetUserInfo();
          return;
        }
        
        try {
          // 并行获取所有链上数据，提高效率
          const [
            userInfo,
            minActivation,
            totalShares,
            rewardPerSecond,
            pendingReward,
            totalRewards,
            totalReferralRewards,
            totalActiveUsers
          ] = await Promise.all([
            lpRewardContract.users(account).catch(() => null),
            lpRewardContract.minActivation().catch(() => ethers.BigNumber.from(0)),
            lpRewardContract.totalShares().catch(() => ethers.BigNumber.from(0)),
            lpRewardContract.rewardPerSecond().catch(() => ethers.BigNumber.from(0)),
            lpRewardContract.pendingReward(account).catch(() => ethers.BigNumber.from(0)),
            lpRewardContract.totalRewards().catch(() => ethers.BigNumber.from(0)),
            lpRewardContract.totalReferralRewards().catch(() => ethers.BigNumber.from(0)),
            lpRewardContract.totalActiveUsers().catch(() => ethers.BigNumber.from(0))
          ]);
          
          if (!userInfo) {
            this.resetUserInfo();
            return;
          }
          
          // 解析用户信息
          lpRewardUserInfo = {
            shares: parseFloat(ethers.utils.formatUnits(userInfo.shares, 18)),
            rewardDebt: parseFloat(ethers.utils.formatUnits(userInfo.rewardDebt, 18)),
            pendingReferral: parseFloat(ethers.utils.formatUnits(userInfo.pendingReferral, 18)),
            lastClaimTime: userInfo.lastClaimTime.toNumber(),
            activeTime: userInfo.activeTime.toNumber(),
            lastReduceTime: userInfo.lastReduceTime.toNumber(),
            referralUnlockTime: userInfo.referralUnlockTime.toNumber(),
            referrer: userInfo.referrer,
            cleanInFirst30Days: userInfo.cleanInFirst30Days
          };
          
          // 解析合约信息
          lpRewardContractInfo = {
            minActivation: parseFloat(ethers.utils.formatUnits(minActivation, 18)),
            totalShares: parseFloat(ethers.utils.formatUnits(totalShares, 18)),
            rewardPerSecond: parseFloat(ethers.utils.formatUnits(rewardPerSecond, 18)),
            pendingReward: parseFloat(ethers.utils.formatUnits(pendingReward, 18)),
            totalRewards: parseFloat(ethers.utils.formatUnits(totalRewards, 18)),
            totalReferralRewards: parseFloat(ethers.utils.formatUnits(totalReferralRewards, 18)),
            totalActiveUsers: totalActiveUsers.toNumber()
          };
          
          // 获取LP余额 - 直接从pair合约获取
          if (pair) {
            try {
              const lpBal = await pair.balanceOf(account);
              lpBalance = parseFloat(ethers.utils.formatUnits(lpBal, 18));
            } catch (error) {
              console.error("获取LP余额失败:", error);
              lpBalance = 0;
            }
          }
          
          this.updateUI();
          this.updateTimer();
          
        } catch (error) {
          console.error('刷新LP奖励信息失败:', error);
          this.resetUserInfo();
        }
      },

      resetUserInfo() {
        lpRewardUserInfo = null;
        lpRewardContractInfo = null;
        lpBalance = 0;
        this.updateUI();
      },

      updateUI() {
        const isActivated = lpRewardUserInfo && lpRewardUserInfo.shares > 0;
        
        document.getElementById('activationStatus').textContent = isActivated ? '已激活' : '未激活';
        document.getElementById('activationStatus').className = isActivated ? 
          'lp-reward-card-value success' : 'lp-reward-card-value warning';
        
        document.getElementById('lpBalance').textContent = `${Utils.formatDisplay(lpBalance)} LPT`;
        
        if (isActivated) {
          const daysHeld = Math.floor((Date.now() / 1000 - lpRewardUserInfo.activeTime) / 86400);
          document.getElementById('daysHeld').textContent = `${daysHeld} 天`;
          
          const multiplier = this.calculateMultiplier(daysHeld);
          document.getElementById('rewardMultiplier').textContent = `${multiplier.toFixed(1)}x`;
          
          this.highlightMultiplier(daysHeld);
          this.updateRewardInfo();
          
          document.getElementById('activateBtn').disabled = true;
          document.getElementById('activateBtn').innerHTML = '<span>✅</span><span>已激活</span>';
          
          const canClaim = this.canClaimReward();
          document.getElementById('claimBtn').disabled = !canClaim;
          document.getElementById('claimBtn').innerHTML = canClaim ? 
            '<span>💰</span><span>领取奖励</span>' : 
            '<span>⏳</span><span>等待中</span>';
          
          const canClaimReferral = this.canClaimReferral();
          document.getElementById('claimReferralBtn').disabled = !canClaimReferral;
          document.getElementById('claimReferralBtn').innerHTML = canClaimReferral ? 
            '<span>🎁</span><span>领取推荐</span>' : 
            '<span>🔒</span><span>锁定中</span>';
          
          this.checkLPWarning();
          
        } else {
          document.getElementById('daysHeld').textContent = '0 天';
          document.getElementById('rewardMultiplier').textContent = '1.0x';
          
          this.resetMultiplierHighlight();
          
          const canActivate = this.canActivate();
          document.getElementById('activateBtn').disabled = !canActivate;
          document.getElementById('activateBtn').innerHTML = canActivate ? 
            '<span>🚀</span><span>激活奖励</span>' : 
            '<span>⏳</span><span>条件不符</span>';
          
          document.getElementById('claimBtn').disabled = true;
          document.getElementById('claimReferralBtn').disabled = true;
          document.getElementById('claimBtn').innerHTML = '<span>💰</span><span>领取奖励</span>';
          document.getElementById('claimReferralBtn').innerHTML = '<span>🎁</span><span>领取推荐</span>';
          
          document.getElementById('lpWarning').style.display = 'none';
          document.getElementById('cooldownTimer').style.display = 'none';
          
          // 更新推荐输入框
          const referrerInput = document.getElementById('referrerAddress');
          if (referrerInput && inviteAddress) {
            referrerInput.value = inviteAddress;
            referrerInput.disabled = true;
          }
        }
        
        // 显示全局统计信息
        if (lpRewardContractInfo) {
          this.displayGlobalStats();
        }
      },

      displayGlobalStats() {
        const statsElement = document.createElement('div');
        statsElement.className = 'lp-reward-stats';
        statsElement.style.marginTop = '15px';
        statsElement.style.padding = '12px';
        statsElement.style.background = 'rgba(255, 215, 0, 0.05)';
        statsElement.style.borderRadius = '10px';
        statsElement.style.border = '1px solid rgba(255, 215, 0, 0.2)';
        
        statsElement.innerHTML = `
          <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; text-align: center;">
            📊 全局统计
          </div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 11px;">
            <div style="text-align: center;">
              <div style="color: var(--text-secondary);">总奖励</div>
              <div style="color: var(--accent-yellow); font-weight: 600;">${Utils.formatDisplay(lpRewardContractInfo.totalRewards)} LOM</div>
            </div>
            <div style="text-align: center;">
              <div style="color: var(--text-secondary);">推荐奖励</div>
              <div style="color: var(--success); font-weight: 600;">${Utils.formatDisplay(lpRewardContractInfo.totalReferralRewards)} LOM</div>
            </div>
            <div style="text-align: center;">
              <div style="color: var(--text-secondary);">活跃用户</div>
              <div style="color: var(--primary-blue); font-weight: 600;">${lpRewardContractInfo.totalActiveUsers}</div>
            </div>
            <div style="text-align: center;">
              <div style="color: var(--text-secondary);">总质押</div>
              <div style="color: var(--text-primary); font-weight: 600;">${Utils.formatDisplay(lpRewardContractInfo.totalShares)} LPT</div>
            </div>
          </div>
        `;
        
        // 添加到奖励信息面板后
        const rewardStats = document.querySelector('.lp-reward-stats');
        const existingStats = rewardStats.parentNode.querySelector('.global-stats');
        if (existingStats) {
          existingStats.remove();
        }
        
        statsElement.className = 'global-stats';
        rewardStats.parentNode.insertBefore(statsElement, rewardStats.nextSibling);
      },

      calculateMultiplier(daysHeld) {
        if (daysHeld >= 360) return 3.0;
        if (daysHeld >= 180) return 2.0;
        if (daysHeld >= 90) return 1.5;
        return 1.0;
      },

      highlightMultiplier(daysHeld) {
        this.resetMultiplierHighlight();
        if (daysHeld >= 360) {
          document.getElementById('multiplier360d').classList.add('active');
        } else if (daysHeld >= 180) {
          document.getElementById('multiplier180d').classList.add('active');
        } else if (daysHeld >= 90) {
          document.getElementById('multiplier90d').classList.add('active');
        } else {
          document.getElementById('multiplier30d').classList.add('active');
        }
      },

      resetMultiplierHighlight() {
        const items = document.querySelectorAll('.lp-reward-multiplier-item');
        items.forEach(item => item.classList.remove('active'));
      },

      async updateRewardInfo() {
        if (!lpRewardContract || !lpRewardUserInfo) return;
        
        try {
          // 获取最新的待领取奖励
          const pendingReward = await lpRewardContract.pendingReward(account);
          const pendingRewardAmount = parseFloat(ethers.utils.formatUnits(pendingReward, 18));
          
          document.getElementById('pendingReward').textContent = `${Utils.formatDisplay(pendingRewardAmount)} LOM`;
          
          // 计算每日预估收益
          const daysHeld = Math.floor((Date.now() / 1000 - lpRewardUserInfo.activeTime) / 86400);
          const multiplier = this.calculateMultiplier(daysHeld);
          
          let dailyReward = 0;
          if (lpRewardUserInfo.shares > 0 && lpRewardContractInfo.totalShares > 0) {
            dailyReward = lpRewardContractInfo.rewardPerSecond * 
                         lpRewardUserInfo.shares / 
                         lpRewardContractInfo.totalShares * 
                         86400 * 
                         multiplier;
          }
          
          document.getElementById('dailyReward').textContent = `${Utils.formatDisplay(dailyReward)} LOM`;
          
          // 计算下次领取时间
          const nextClaimTime = lpRewardUserInfo.lastClaimTime + 7 * 86400;
          const now = Math.floor(Date.now() / 1000);
          
          if (now >= nextClaimTime) {
            document.getElementById('nextClaimTime').textContent = '现在可以领取';
          } else {
            const timeLeft = nextClaimTime - now;
            const daysLeft = Math.floor(timeLeft / 86400);
            const hoursLeft = Math.floor((timeLeft % 86400) / 3600);
            document.getElementById('nextClaimTime').textContent = `${daysLeft}天${hoursLeft}小时后`;
          }
          
          // 显示推荐奖励
          document.getElementById('pendingReferral').textContent = `${Utils.formatDisplay(lpRewardUserInfo.pendingReferral)} LOM`;
          
        } catch (error) {
          console.error('更新奖励信息失败:', error);
        }
      },

      canActivate() {
        if (!account || !pair || !lpRewardContractInfo) return false;
        if (lpRewardUserInfo && lpRewardUserInfo.shares > 0) return false;
        if (lpBalance < lpRewardContractInfo.minActivation) return false;
        return true;
      },

      canClaimReward() {
        if (!lpRewardUserInfo || !lpRewardContract) return false;
        const now = Math.floor(Date.now() / 1000);
        const timeSinceLastClaim = now - lpRewardUserInfo.lastClaimTime;
        return timeSinceLastClaim >= 7 * 86400;
      },

      canClaimReferral() {
        if (!lpRewardUserInfo || lpRewardUserInfo.pendingReferral <= 0) return false;
        const now = Math.floor(Date.now() / 1000);
        return now >= lpRewardUserInfo.referralUnlockTime;
      },

      checkLPWarning() {
        if (!lpRewardUserInfo || !pair || !account) return;
        
        const warningPanel = document.getElementById('lpWarning');
        const timerPanel = document.getElementById('cooldownTimer');
        
        // 监控LP持仓变化
        const currentLP = lpBalance;
        const userShares = lpRewardUserInfo.shares;
        
        if (currentLP < userShares) {
          const reduction = userShares - currentLP;
          const reductionPercent = (reduction / userShares * 100).toFixed(2);
          
          const now = Math.floor(Date.now() / 1000);
          const timeSinceActivation = now - lpRewardUserInfo.activeTime;
          const isInFirst30Days = timeSinceActivation < 30 * 86400;
          
          let warningText = `检测到LP减持 ${reductionPercent}%，下次领取将有50%惩罚`;
          
          if (isInFirst30Days && lpRewardUserInfo.cleanInFirst30Days) {
            warningText += '，且会失去推荐资格';
          }
          
          document.getElementById('lpWarningText').textContent = warningText;
          warningPanel.style.display = 'flex';
          
          // 检查减持冷却时间
          const timeSinceLastReduce = now - lpRewardUserInfo.lastReduceTime;
          const cooldownRemaining = 86400 - timeSinceLastReduce;
          
          if (cooldownRemaining > 0) {
            document.getElementById('cooldownTime').textContent = Utils.formatTime(cooldownRemaining);
            timerPanel.style.display = 'block';
          } else {
            timerPanel.style.display = 'none';
          }
          
        } else {
          warningPanel.style.display = 'none';
          timerPanel.style.display = 'none';
        }
      },

      updateTimer() {
        if (cooldownInterval) clearInterval(cooldownInterval);
        
        cooldownInterval = setInterval(() => {
          if (!lpRewardUserInfo) return;
          
          const now = Math.floor(Date.now() / 1000);
          const timeSinceLastReduce = now - lpRewardUserInfo.lastReduceTime;
          
          // 更新冷却时间显示
          if (timeSinceLastReduce < 86400) {
            const cooldownRemaining = 86400 - timeSinceLastReduce;
            document.getElementById('cooldownTime').textContent = Utils.formatTime(cooldownRemaining);
            document.getElementById('cooldownTimer').style.display = 'block';
          } else {
            document.getElementById('cooldownTimer').style.display = 'none';
          }
          
          // 每30秒刷新一次奖励信息
          if (now % 30 === 0) {
            this.updateRewardInfo();
          }
          
          // 每5分钟刷新一次用户信息
          if (now % 300 === 0) {
            this.refreshUserInfo();
          }
          
        }, 1000);
      },

      // 激活奖励功能
      async showActivateConfirmation() {
        if (!account || !lpRewardContract || !pair) {
          Utils.showError(isChinese ? '请先连接钱包' : 'Please connect wallet first');
          return;
        }
        
        try {
          // 获取最新的链上数据
          const minActivation = await lpRewardContract.minActivation();
          const minActivationAmount = parseFloat(ethers.utils.formatUnits(minActivation, 18));
          
          // 获取LP余额
          const lpBal = await pair.balanceOf(account);
          const lpBalanceAmount = parseFloat(ethers.utils.formatUnits(lpBal, 18));
          
          // 获取推荐人地址
          const referrerAddress = document.getElementById('referrerAddress').value.trim();
          const isValidReferrer = referrerAddress && Utils.isValidAddress(referrerAddress) && 
                                 referrerAddress.toLowerCase() !== account.toLowerCase();
          
          // 检查激活条件
          const canActivate = lpBalanceAmount >= minActivationAmount;
          
          // 更新弹窗内容
          document.getElementById('activateLpBalance').textContent = `${Utils.formatDisplay(lpBalanceAmount)} LPT`;
          document.getElementById('minActivationRequired').textContent = `${Utils.formatDisplay(minActivationAmount)} LPT`;
          document.getElementById('activateReferrerAddress').textContent = isValidReferrer ? 
            Utils.formatAddress(referrerAddress) : '无';
          
          // 更新激活要求显示
          const requirementsEl = document.getElementById('lpRewardRequirements');
          requirementsEl.innerHTML = `
            <div class="lp-reward-activate-requirement">
              <div class="lp-reward-activate-requirement-icon ${lpBalanceAmount >= minActivationAmount ? 'valid' : 'invalid'}">
                ${lpBalanceAmount >= minActivationAmount ? '✓' : '✗'}
              </div>
              <div class="lp-reward-activate-requirement-text">
                LP余额 ≥ ${Utils.formatDisplay(minActivationAmount)} LPT
                (当前: ${Utils.formatDisplay(lpBalanceAmount)} LPT)
              </div>
            </div>
            <div class="lp-reward-activate-requirement">
              <div class="lp-reward-activate-requirement-icon valid">
                ✓
              </div>
              <div class="lp-reward-activate-requirement-text">
                钱包已连接
              </div>
            </div>
            <div class="lp-reward-activate-requirement">
              <div class="lp-reward-activate-requirement-icon ${!lpRewardUserInfo || lpRewardUserInfo.shares === 0 ? 'valid' : 'invalid'}">
                ${!lpRewardUserInfo || lpRewardUserInfo.shares === 0 ? '✓' : '✗'}
              </div>
              <div class="lp-reward-activate-requirement-text">
                未激活奖励
              </div>
            </div>
          `;
          
          // 更新确认按钮状态
          const confirmBtn = document.getElementById('lpRewardActivateConfirmBtn');
          confirmBtn.disabled = !canActivate;
          
          // 显示弹窗
          document.getElementById('lpRewardActivateModal').style.display = 'flex';
          
        } catch (error) {
          console.error('显示激活确认失败:', error);
          Utils.showError(isChinese ? '获取激活信息失败' : 'Failed to get activation info');
        }
      },

      async activateReward() {
        try {
          const referrerAddress = document.getElementById('referrerAddress').value.trim();
          let referrer = ethers.constants.AddressZero;
          
          if (referrerAddress && Utils.isValidAddress(referrerAddress) && 
              referrerAddress.toLowerCase() !== account.toLowerCase()) {
            referrer = referrerAddress;
            
            // 保存邀请地址
            walletInviteMap[account.toLowerCase()] = referrerAddress;
            localStorage.setItem('lomswap_wallet_invite_map', JSON.stringify(walletInviteMap));
          }
          
          Utils.showNotification(isChinese ? '激活奖励中...' : 'Activating reward...', 'info');
          
          const tx = await lpRewardContract.activate(referrer);
          await tx.wait();
          
          document.getElementById('lpRewardActivateModal').style.display = 'none';
          
          Utils.showNotification(isChinese ? '激活成功！' : 'Activation successful!', 'success');
          
          // 刷新数据
          await this.refreshUserInfo();
          await DataManager.refreshAll();
          
        } catch (error) {
          console.error('激活奖励失败:', error);
          Utils.showNotification(Utils.getErrorMessage(error), 'error');
        }
      },

      async claimReward() {
        try {
          if (!this.canClaimReward()) {
            Utils.showError(isChinese ? '还未到领取时间' : 'Not time to claim yet');
            return;
          }
          
          Utils.showNotification(isChinese ? '领取奖励中...' : 'Claiming reward...', 'info');
          
          const tx = await lpRewardContract.claimAll();
          await tx.wait();
          
          Utils.showNotification(isChinese ? '领取成功！' : 'Claim successful!', 'success');
          
          // 刷新数据
          await this.refreshUserInfo();
          await DataManager.refreshAll();
          
        } catch (error) {
          console.error('领取奖励失败:', error);
          Utils.showNotification(Utils.getErrorMessage(error), 'error');
        }
      },

      async claimReferralReward() {
        try {
          if (!this.canClaimReferral()) {
            Utils.showError(isChinese ? '推荐奖励还未解锁' : 'Referral reward not unlocked yet');
            return;
          }
          
          Utils.showNotification(isChinese ? '领取推荐奖励中...' : 'Claiming referral reward...', 'info');
          
          const tx = await lpRewardContract.claimReferral();
          await tx.wait();
          
          Utils.showNotification(isChinese ? '推荐奖励领取成功！' : 'Referral claim successful!', 'success');
          
          // 刷新数据
          await this.refreshUserInfo();
          await DataManager.refreshAll();
          
        } catch (error) {
          console.error('领取推荐奖励失败:', error);
          Utils.showNotification(Utils.getErrorMessage(error), 'error');
        }
      }
    };

    // ==================== UI事件处理器 ====================
    const EventHandlers = {
      init() {
        this.setupWalletEvents();
        this.setupSwapEvents();
        this.setupLiquidityEvents();
        this.setupLPRewardEvents();
        this.setupModalEvents();
        this.setupTabEvents();
        this.setupLanguageToggle();
      },

      setupWalletEvents() {
        document.getElementById("walletBtn").addEventListener("click", async () => {
          if (account) {
            if (confirm(isChinese ? "确定要断开钱包连接吗？" : "Are you sure you want to disconnect wallet?")) {
              AppCore.disconnect();
            }
            return;
          }
          
          document.getElementById("walletBtn").disabled = true;
          try {
            const success = await AppCore.connectWallet();
            if (success) {
              DataManager.refreshAll();
              LPRewardManager.refreshUserInfo();
            }
          } finally {
            document.getElementById("walletBtn").disabled = false;
          }
        });
      },

      setupSwapEvents() {
        const debouncedFromInput = Utils.debounce(() => {
          const amount = document.getElementById("fromAmount").value;
          if (amount && amount !== "0") {
            lastInputWasFrom = true;
            SwapModule.updateOutputFromInput();
          } else {
            document.getElementById("toAmount").value = "";
            DataManager.updateSwapButtonState();
            document.getElementById("minReceived").textContent = `0.000000 ${toToken}`;
          }
        }, 300);
        
        document.getElementById("fromAmount").addEventListener("input", debouncedFromInput);
        
        document.getElementById("reverse").addEventListener("click", () => {
          const tempToken = fromToken;
          fromToken = toToken;
          toToken = tempToken;
          
          document.getElementById("fromTokenSymbol").textContent = fromToken;
          document.getElementById("toTokenSymbol").textContent = toToken;
          
          const fromTokenData = TokenUtils.getToken(fromToken);
          const toTokenData = TokenUtils.getToken(toToken);
          
          if (fromTokenData) {
            document.getElementById("fromTokenLogo").style.backgroundImage = `url('${fromTokenData.logo}')`;
          }
          
          if (toTokenData) {
            document.getElementById("toTokenLogo").style.backgroundImage = `url('${toTokenData.logo}')`;
          }
          
          document.getElementById("fromAmount").value = "";
          document.getElementById("toAmount").value = "";
          
          DataManager.updateAllBalances();
          DataManager.updateSwapButtonState();
          document.getElementById("price").textContent = `1 ${fromToken} = 0.000000 ${toToken}`;
          document.getElementById("minReceived").textContent = `0.000000 ${toToken}`;
          
          lastInputWasFrom = true;
        });
        
        document.getElementById("swapBtn").addEventListener("click", async () => {
          if (!account) {
            await AppCore.connectWallet();
          } else {
            await SwapModule.executeSwap();
          }
        });
        
        // 百分比按钮
        document.querySelectorAll('.percent-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const percent = parseFloat(e.target.dataset.percent);
            document.querySelectorAll('.percent-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            
            if (!account) {
              Utils.showError(isChinese ? "请先连接钱包" : "Please connect wallet first");
              return;
            }
            
            let balance = parseFloat(document.getElementById("fromBal").textContent);
            if (balance > 0) {
              let amount;
              if (percent === 1) {
                amount = fromToken === 'CFX' ? Math.max(0, balance - 0.1) : balance * 0.9;
              } else {
                amount = balance * percent;
              }
              
              if (amount > 0) {
                document.getElementById("fromAmount").value = Utils.formatDisplay(amount);
                lastInputWasFrom = true;
                SwapModule.updateOutputFromInput();
              }
            }
          });
        });
        
        // 滑点按钮
        document.querySelectorAll('.slippage-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const newSlippage = parseFloat(e.target.dataset.slip);
            if (fromToken === 'LOM' && newSlippage < 5) {
              Utils.showNotification(
                isChinese ? 'LOM交易需要5%以上滑点以避免交易失败' : 
                          'LOM transactions require 5%+ slippage to avoid failure',
                'warning'
              );
            }
            
            slippage = newSlippage;
            document.querySelectorAll('.slippage-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            
            if (lastInputWasFrom && document.getElementById("fromAmount").value) {
              SwapModule.updateOutputFromInput();
            }
          });
        });
        
        // 代币选择器
        document.getElementById("fromTokenSelector").addEventListener("click", () => this.openTokenSelector('from'));
        document.getElementById("toTokenSelector").addEventListener("click", () => this.openTokenSelector('to'));
      },

      setupLiquidityEvents() {
        document.getElementById("addBtn").addEventListener("click", () => {
          if (!account) {
            Utils.showError(isChinese ? "请先连接钱包" : "Please connect wallet first");
            return;
          }
          
          document.getElementById("addModal").style.display = "flex";
          document.getElementById("addCfx").value = "";
          document.getElementById("addLom").value = "";
          document.getElementById("confirmAddBtn").disabled = true;
          
          if (currentRatio > 0) {
            const ratioFormatted = Utils.formatDisplay(currentRatio);
            document.getElementById("addRatio").textContent = `1 CFX = ${ratioFormatted} LOM`;
          }
        });
        
        document.getElementById("removeBtn").addEventListener("click", () => {
          if (!account) {
            Utils.showError(isChinese ? "请先连接钱包" : "Please connect wallet first");
            return;
          }
          
          document.getElementById("removeModal").style.display = "flex";
          LiquidityModule.updateRemoveEstimate(100);
        });
        
        // 添加流动性输入处理
        const debouncedCfxInput = Utils.debounce(() => {
          const cfxAmount = document.getElementById("addCfx").value;
          if (!cfxAmount || cfxAmount === "" || parseFloat(cfxAmount) <= 0) {
            document.getElementById("addLom").value = "";
            document.getElementById("confirmAddBtn").disabled = true;
            return;
          }
          
          if (currentRatio > 0) {
            const cfxNum = parseFloat(cfxAmount);
            const lomAmount = cfxNum * currentRatio;
            document.getElementById("addLom").value = Utils.formatDisplay(lomAmount);
          }
          
          LiquidityModule.updateAddButtonState();
        }, 300);
        
        const debouncedLomInput = Utils.debounce(() => {
          const lomAmount = document.getElementById("addLom").value;
          if (!lomAmount || lomAmount === "" || parseFloat(lomAmount) <= 0) {
            document.getElementById("addCfx").value = "";
            document.getElementById("confirmAddBtn").disabled = true;
            return;
          }
          
          if (currentRatio > 0) {
            const lomNum = parseFloat(lomAmount);
            const cfxAmount = lomNum / currentRatio;
            document.getElementById("addCfx").value = Utils.formatDisplay(cfxAmount);
          }
          
          LiquidityModule.updateAddButtonState();
        }, 300);
        
        document.getElementById("addCfx").addEventListener("input", debouncedCfxInput);
        document.getElementById("addLom").addEventListener("input", debouncedLomInput);
        
        document.getElementById("cfxMaxBtn").addEventListener("click", () => LiquidityModule.setMaxCfx());
        document.getElementById("lomMaxBtn").addEventListener("click", () => LiquidityModule.setMaxLom());
        
        document.getElementById("cancelAddBtn").addEventListener("click", () => {
          document.getElementById("addModal").style.display = "none";
        });
        
        document.getElementById("confirmAddBtn").addEventListener("click", async () => {
          await LiquidityModule.addLiquidity();
        });
        
        // 移除流动性处理
        document.getElementById("removeSlider").addEventListener("input", (e) => {
          LiquidityModule.updateRemoveEstimate(e.target.value);
        });
        
        document.querySelectorAll('.percentage-option').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const percent = e.target.dataset.percent;
            document.querySelectorAll('.percentage-option').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            document.getElementById("removeSlider").value = percent;
            document.getElementById("removePercent").textContent = percent + "%";
            LiquidityModule.updateRemoveEstimate(percent);
          });
        });
        
        document.getElementById("cancelRemoveBtn").addEventListener("click", () => {
          document.getElementById("removeModal").style.display = "none";
        });
        
        document.getElementById("confirmRemoveBtn").addEventListener("click", async () => {
          await LiquidityModule.removeLiquidity();
        });
      },

      setupLPRewardEvents() {
        // 修复：绑定正确的激活确认事件
        document.getElementById("activateBtn").addEventListener("click", () => {
          LPRewardManager.showActivationConfirmation();
        });
        
        // 绑定激活确认按钮
        document.getElementById("lpRewardActivateConfirmBtn").addEventListener("click", async () => {
          await LPRewardManager.activateReward();
        });
        
        // 绑定激活取消按钮
        document.getElementById("lpRewardActivateCancelBtn").addEventListener("click", () => {
          document.getElementById("lpRewardActivateModal").style.display = "none";
        });
        
        // 绑定领取奖励按钮
        document.getElementById("claimBtn").addEventListener("click", async () => {
          await LPRewardManager.claimReward();
        });
        
        // 绑定领取推荐奖励按钮
        document.getElementById("claimReferralBtn").addEventListener("click", async () => {
          await LPRewardManager.claimReferralReward();
        });
        
        // 推荐地址输入验证
        const referrerInput = document.getElementById("referrerAddress");
        referrerInput.addEventListener("input", (e) => {
          const address = e.target.value.trim();
          if (address && !Utils.isValidAddress(address)) {
            referrerInput.style.borderColor = "var(--accent-red)";
          } else {
            referrerInput.style.borderColor = "";
          }
        });
        
        // 当推荐地址被设置时禁用输入
        if (inviteAddress) {
          referrerInput.value = inviteAddress;
          referrerInput.disabled = true;
        }
      },

      setupModalEvents() {
        document.addEventListener("click", (e) => {
          if (e.target.classList.contains("modal-overlay") || 
              e.target.classList.contains("token-selector-modal") ||
              e.target.classList.contains("lp-reward-activate-modal")) {
            e.target.style.display = "none";
          }
        });
        
        document.getElementById('txStatusDoneBtn').addEventListener('click', () => {
          Utils.hideNotification();
        });
      },

      setupTabEvents() {
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const tabId = btn.dataset.tab;
            
            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(tabId + 'Tab').classList.add('active');
            
            if (account) {
              DataManager.refreshAll();
              if (tabId === 'lpReward') {
                // 切换到LP奖励页面时强制刷新
                LPRewardManager.refreshUserInfo();
              }
            }
          });
        });
      },

      setupLanguageToggle() {
        document.getElementById("langBtn").addEventListener("click", () => {
          isChinese = !isChinese;
          document.getElementById("langBtn").innerText = isChinese ? "EN" : "ZN";
          this.updateAllTexts();
        });
      },

      updateAllTexts() {
        const walletBtn = document.getElementById("walletBtn");
        if (account) {
          const displayAddress = Utils.formatAddress(account);
          walletBtn.textContent = displayAddress;
          walletBtn.classList.add('connected');
        } else {
          walletBtn.textContent = isChinese ? "连接钱包" : "Connect Wallet";
          walletBtn.classList.remove('connected');
        }
        
        document.querySelector('[data-tab="swap"]').textContent = isChinese ? "兑换" : "Swap";
        document.querySelector('[data-tab="liquidity"]').textContent = isChinese ? "流动性" : "Liquidity";
        document.querySelector('[data-tab="lpReward"]').textContent = isChinese ? "LP奖励" : "LP Reward";
        
        const swapBtn = document.getElementById("swapBtn");
        if (!account) {
          swapBtn.textContent = isChinese ? "连接钱包" : "Connect Wallet";
          swapBtn.disabled = false;
        } else if (document.getElementById("fromAmount").value && document.getElementById("fromAmount").value !== "0") {
          swapBtn.textContent = isChinese ? "立即兑换" : "Swap Now";
          swapBtn.disabled = false;
        } else {
          swapBtn.textContent = isChinese ? "请输入数量" : "Enter Amount";
          swapBtn.disabled = true;
        }
        
        document.getElementById("addBtn").textContent = isChinese ? "添加流动性" : "Add Liquidity";
        document.getElementById("removeBtn").textContent = isChinese ? "移除流动性" : "Remove Liquidity";
        
        document.getElementById("tokenSelectorTitle").textContent = isChinese ? "选择代币" : "Select Token";
        document.getElementById("addTitle").textContent = isChinese ? "添加流动性" : "Add Liquidity";
        document.getElementById("removeTitle").textContent = isChinese ? "移除流动性" : "Remove Liquidity";
        document.getElementById("confirmAddBtn").textContent = isChinese ? "确认添加" : "Confirm Add";
        document.getElementById("confirmRemoveBtn").textContent = isChinese ? "确认移除" : "Confirm Remove";
        document.getElementById("cancelAddBtn").textContent = isChinese ? "取消" : "Cancel";
        document.getElementById("cancelRemoveBtn").textContent = isChinese ? "取消" : "Cancel";
        
        document.getElementById("riskTitle").textContent = isChinese ? "风险提示" : "Risk Warning";
        document.getElementById("riskText").textContent = isChinese ? 
          "本应用仅作为技术演示，不构成任何投资建议。加密货币市场波动巨大，投资需谨慎，请理性对待数字资产交易。" :
          "This application is for technical demonstration only and does not constitute investment advice. The cryptocurrency market is highly volatile. Please invest cautiously and treat digital asset trading rationally.";
        
        document.getElementById("footerText").textContent = isChinese ? "LOMswap · Conflux eSpace" : "LOMswap · Conflux eSpace";
      },

      openTokenSelector(type) {
        currentTokenSelector = type;
        const modal = document.getElementById("tokenSelectorModal");
        modal.style.display = "flex";
        document.getElementById("tokenSearch").value = "";
        this.populateTokenList();
      },

      async populateTokenList(searchTerm = "") {
        const tokenList = document.getElementById("tokenList");
        tokenList.innerHTML = "";
        
        const filteredTokens = TOKEN_LIST.filter(token => {
          if (searchTerm) {
            const term = searchTerm.toLowerCase();
            return token.symbol.toLowerCase().includes(term) || 
                   token.name.toLowerCase().includes(term);
          }
          return true;
        });
        
        const fragment = document.createDocumentFragment();
        
        filteredTokens.forEach(token => {
          if ((currentTokenSelector === 'from' && token.symbol === toToken) ||
              (currentTokenSelector === 'to' && token.symbol === fromToken)) {
            return;
          }
          
          const tokenItem = document.createElement("div");
          tokenItem.className = "token-item";
          tokenItem.innerHTML = `
            <div class="token-item-logo" style="background-image: url('${token.logo}')"></div>
            <div class="token-item-info">
              <div class="token-item-symbol">${token.symbol}</div>
              <div class="token-item-name">${token.name}</div>
            </div>
            <div class="token-item-balance" id="selectorBalance-${token.symbol}">0.000000</div>
          `;
          
          tokenItem.addEventListener("click", () => {
            this.selectToken(token);
          });
          
          fragment.appendChild(tokenItem);
        });
        
        tokenList.appendChild(fragment);
        
        setTimeout(() => {
          if (account) {
            filteredTokens.forEach(token => {
              this.updateTokenBalanceInSelector(token.symbol);
            });
          }
        }, 50);
        
        const searchInput = document.getElementById("tokenSearch");
        const debouncedSearch = Utils.debounce((e) => {
          this.populateTokenList(e.target.value);
        }, 300);
        
        searchInput.removeEventListener('input', this.handleSearchInput);
        this.handleSearchInput = debouncedSearch;
        searchInput.addEventListener('input', this.handleSearchInput);
        
        setTimeout(() => searchInput.focus(), 100);
      },

      handleSearchInput: null,

      async updateTokenBalanceInSelector(symbol) {
        try {
          const token = TokenUtils.getToken(symbol);
          if (!token) return;
          
          let amount = 0;
          
          if (symbol === 'CFX' && provider && account) {
            const cfxBal = await provider.getBalance(account);
            amount = parseFloat(ethers.utils.formatEther(cfxBal));
          } else {
            const contract = TokenUtils.getTokenContract(symbol);
            if (contract && account) {
              const tokenBal = await contract.balanceOf(account);
              amount = parseFloat(ethers.utils.formatUnits(tokenBal, token.decimals));
            }
          }
          
          const formattedBalance = Utils.formatDisplay(amount);
          const balanceElement = document.getElementById(`selectorBalance-${symbol}`);
          if (balanceElement) {
            balanceElement.textContent = formattedBalance;
          }
        } catch (error) {
          console.error(`更新${symbol}余额失败:`, error);
        }
      },

      selectToken(token) {
        if (currentTokenSelector === 'from') {
          fromToken = token.symbol;
          document.getElementById("fromTokenSymbol").textContent = token.symbol;
          document.getElementById("fromTokenLogo").style.backgroundImage = `url('${token.logo}')`;
        } else if (currentTokenSelector === 'to') {
          toToken = token.symbol;
          document.getElementById("toTokenSymbol").textContent = token.symbol;
          document.getElementById("toTokenLogo").style.backgroundImage = `url('${token.logo}')`;
        }
        
        document.getElementById("tokenSelectorModal").style.display = "none";
        DataManager.updateAllBalances();
        
        document.getElementById("fromAmount").value = "";
        document.getElementById("toAmount").value = "";
        
        DataManager.updateSwapButtonState();
        document.getElementById("price").textContent = `1 ${fromToken} = 0.000000 ${toToken}`;
        document.getElementById("minReceived").textContent = `0.000000 ${toToken}`;
      }
    };

    // ==================== 交换模块 ====================
    const SwapModule = {
      async executeSwap() {
        const fromAmount = document.getElementById('fromAmount').value;
        const toAmount = document.getElementById('toAmount').value;
        
        if (!fromAmount || fromAmount === '0') {
          Utils.showError(isChinese ? "请输入兑换数量" : "Please enter swap amount");
          return;
        }
        
        try {
          Utils.showNotification(isChinese ? '处理兑换中...' : 'Processing swap...', 'info');
          
          const fromDecimals = TokenUtils.getTokenDecimals(fromToken);
          const toDecimals = TokenUtils.getTokenDecimals(toToken);
          
          const amountIn = TokenUtils.parseTokenAmount(fromAmount, fromToken);
          const path = this.getSwapPath();
          
          const amounts = await router.getAmountsOut(amountIn, path);
          const minOut = amounts[amounts.length - 1].mul(1000 - slippage * 10).div(1000);
          
          const deadline = Math.floor(Date.now() / 1000) + 1200;
          
          let tx;
          
          if (fromToken === "CFX") {
            tx = await router.swapExactETHForTokensSupportingFeeOnTransferTokens(
              minOut, path, account, deadline, 
              { value: amountIn }
            );
          } else if (toToken === "CFX") {
            const tokenContract = TokenUtils.getTokenContract(fromToken);
            if (!tokenContract) throw new Error('代币合约未找到');
            
            const allowance = await tokenContract.allowance(account, APP_CONFIG.CONTRACTS.ROUTER);
            if (allowance.lt(amountIn)) {
              Utils.showNotification(isChinese ? '授权代币中...' : 'Approving token...', 'info');
              const approveTx = await tokenContract.approve(APP_CONFIG.CONTRACTS.ROUTER, ethers.constants.MaxUint256);
              await approveTx.wait();
            }
            
            tx = await router.swapExactTokensForETHSupportingFeeOnTransferTokens(
              amountIn, minOut, path, account, deadline
            );
          } else {
            const tokenContract = TokenUtils.getTokenContract(fromToken);
            if (!tokenContract) throw new Error('代币合约未找到');
            
            const allowance = await tokenContract.allowance(account, APP_CONFIG.CONTRACTS.ROUTER);
            if (allowance.lt(amountIn)) {
              Utils.showNotification(isChinese ? '授权代币中...' : 'Approving token...', 'info');
              const approveTx = await tokenContract.approve(APP_CONFIG.CONTRACTS.ROUTER, ethers.constants.MaxUint256);
              await approveTx.wait();
            }
            
            tx = await router.swapExactTokensForTokensSupportingFeeOnTransferTokens(
              amountIn, minOut, path, account, deadline
            );
          }
          
          await tx.wait();
          
          document.getElementById('fromAmount').value = '';
          document.getElementById('toAmount').value = '';
          
          Utils.showNotification(
            isChinese ? `兑换成功！获得 ${Utils.formatDisplay(toAmount)} ${toToken}` : 
                       `Swap successful! Received ${Utils.formatDisplay(toAmount)} ${toToken}`,
            'success'
          );
          
          await DataManager.refreshAll();
          
        } catch (error) {
          console.error('兑换失败:', error);
          Utils.showNotification(Utils.getErrorMessage(error), 'error');
        }
      },

      getSwapPath() {
        let path = [];
        
        if ((fromToken === 'AXCNH' && toToken === 'USDT0') || 
            (fromToken === 'USDT0' && toToken === 'AXCNH')) {
          
          if (fromToken === 'AXCNH') {
            path.push(APP_CONFIG.CONTRACTS.AXCNH);
            path.push(APP_CONFIG.CONTRACTS.USDT0);
          } else {
            path.push(APP_CONFIG.CONTRACTS.USDT0);
            path.push(APP_CONFIG.CONTRACTS.AXCNH);
          }
          return path;
        }
        
        if (fromToken === 'CFX') {
          path.push(APP_CONFIG.CONTRACTS.WCFX);
          if (toToken === 'LOM') path.push(APP_CONFIG.CONTRACTS.LOM);
          else if (toToken === 'USDC') path.push(APP_CONFIG.CONTRACTS.USDC);
          else if (toToken === 'AXCNH') path.push(APP_CONFIG.CONTRACTS.AXCNH);
          else if (toToken === 'USDT0') path.push(APP_CONFIG.CONTRACTS.USDT0);
          else if (toToken === 'CNHT0') path.push(APP_CONFIG.CONTRACTS.CNHT0);
        } else if (toToken === 'CFX') {
          if (fromToken === 'LOM') path.push(APP_CONFIG.CONTRACTS.LOM);
          else if (fromToken === 'USDC') path.push(APP_CONFIG.CONTRACTS.USDC);
          else if (fromToken === 'AXCNH') path.push(APP_CONFIG.CONTRACTS.AXCNH);
          else if (fromToken === 'USDT0') path.push(APP_CONFIG.CONTRACTS.USDT0);
          else if (fromToken === 'CNHT0') path.push(APP_CONFIG.CONTRACTS.CNHT0);
          path.push(APP_CONFIG.CONTRACTS.WCFX);
        } else {
          if (fromToken === 'LOM') path.push(APP_CONFIG.CONTRACTS.LOM);
          else if (fromToken === 'USDC') path.push(APP_CONFIG.CONTRACTS.USDC);
          else if (fromToken === 'AXCNH') path.push(APP_CONFIG.CONTRACTS.AXCNH);
          else if (fromToken === 'USDT0') path.push(APP_CONFIG.CONTRACTS.USDT0);
          else if (fromToken === 'CNHT0') path.push(APP_CONFIG.CONTRACTS.CNHT0);
          
          path.push(APP_CONFIG.CONTRACTS.WCFX);
          
          if (toToken === 'LOM') path.push(APP_CONFIG.CONTRACTS.LOM);
          else if (toToken === 'USDC') path.push(APP_CONFIG.CONTRACTS.USDC);
          else if (toToken === 'AXCNH') path.push(APP_CONFIG.CONTRACTS.AXCNH);
          else if (toToken === 'USDT0') path.push(APP_CONFIG.CONTRACTS.USDT0);
          else if (toToken === 'CNHT0') path.push(APP_CONFIG.CONTRACTS.CNHT0);
        }
        
        return path;
      },

      async updateOutputFromInput() {
        const amount = document.getElementById('fromAmount').value;
        
        if (!amount || amount === '0' || amount === '' || !router) {
          document.getElementById('toAmount').value = "";
          document.getElementById('minReceived').textContent = `0 ${toToken}`;
          DataManager.updateSwapButtonState();
          return;
        }
        
        try {
          const fromDecimals = TokenUtils.getTokenDecimals(fromToken);
          const toDecimals = TokenUtils.getTokenDecimals(toToken);
          
          const amountIn = TokenUtils.parseTokenAmount(amount, fromToken);
          const path = this.getSwapPath();
          
          const amounts = await router.getAmountsOut(amountIn, path);
          const out = TokenUtils.formatTokenAmount(amounts[amounts.length - 1], toToken);
          
          document.getElementById('toAmount').value = out;
          
          const minOut = amounts[amounts.length - 1].mul(1000 - slippage * 10).div(1000);
          const minOutFormatted = TokenUtils.formatTokenAmount(minOut, toToken);
          document.getElementById('minReceived').textContent = 
            `${minOutFormatted} ${toToken}`;
          
          const price = parseFloat(out) / parseFloat(amount);
          const priceFormatted = Utils.formatDisplay(price);
          document.getElementById('price').textContent = 
            `1 ${fromToken} = ${priceFormatted} ${toToken}`;
          
          DataManager.updateSwapButtonState();
          
        } catch (error) {
          console.error('计算输出失败:', error);
          document.getElementById('toAmount').value = "";
          document.getElementById('swapBtn').textContent = isChinese ? '计算失败' : 'Calculation Failed';
          document.getElementById('swapBtn').disabled = true;
        }
      }
    };

    // ==================== 流动性模块 ====================
    const LiquidityModule = {
      async addLiquidity() {
        const cfxAmount = document.getElementById("addCfx").value;
        const lomAmount = document.getElementById("addLom").value;
        
        if (!cfxAmount || !lomAmount || parseFloat(cfxAmount) <= 0 || parseFloat(lomAmount) <= 0) {
          Utils.showError(isChinese ? "请输入有效数量" : "Please enter valid amounts");
          return;
        }
        
        try {
          Utils.showNotification(isChinese ? '添加流动性中...' : 'Adding liquidity...', 'info');
          
          const amountCfx = TokenUtils.parseTokenAmount(cfxAmount, 'CFX');
          const amountLom = TokenUtils.parseTokenAmount(lomAmount, 'LOM');
          
          const allowance = await lom.allowance(account, APP_CONFIG.CONTRACTS.ROUTER);
          if (allowance.lt(amountLom)) {
            Utils.showNotification(isChinese ? '授权LOM中...' : 'Approving LOM...', 'info');
            const approveTx = await lom.approve(APP_CONFIG.CONTRACTS.ROUTER, ethers.constants.MaxUint256);
            await approveTx.wait();
          }
          
          const minCfx = amountCfx.mul(1000 - slippage * 10).div(1000);
          const minLom = amountLom.mul(1000 - slippage * 10).div(1000);
          const deadline = Math.floor(Date.now() / 1000) + 1800;
          
          const tx = await router.addLiquidityETH(
            APP_CONFIG.CONTRACTS.LOM,
            amountLom,
            minLom,
            minCfx,
            account,
            deadline,
            { value: amountCfx }
          );
          
          await tx.wait();
          
          document.getElementById("addModal").style.display = "none";
          document.getElementById("addCfx").value = "";
          document.getElementById("addLom").value = "";
          
          Utils.showNotification(isChinese ? '添加流动性成功！' : 'Liquidity added successfully!', 'success');
          
          // 刷新所有数据，包括LP奖励信息
          await DataManager.refreshAll();
          if (document.getElementById('lpRewardTab').classList.contains('active')) {
            await LPRewardManager.refreshUserInfo();
          }
          
        } catch (error) {
          console.error('添加流动性失败:', error);
          Utils.showNotification(Utils.getErrorMessage(error), 'error');
        }
      },

      async removeLiquidity() {
        const percent = document.getElementById("removeSlider").value;
        
        try {
          Utils.showNotification(isChinese ? '移除流动性中...' : 'Removing liquidity...', 'info');
          
          const lpBal = await pair.balanceOf(account);
          const liquidity = lpBal.mul(percent).div(100);
          
          if (liquidity.isZero()) {
            throw new Error(isChinese ? '没有流动性可移除' : 'No liquidity to remove');
          }
          
          const allowance = await pair.allowance(account, APP_CONFIG.CONTRACTS.ROUTER);
          if (allowance.lt(liquidity)) {
            Utils.showNotification(isChinese ? '授权LP代币中...' : 'Approving LP token...', 'info');
            const approveTx = await pair.approve(APP_CONFIG.CONTRACTS.ROUTER, ethers.constants.MaxUint256);
            await approveTx.wait();
          }
          
          const deadline = Math.floor(Date.now() / 1000) + 1800;
          
          const tx = await router.removeLiquidityETH(
            APP_CONFIG.CONTRACTS.LOM, 
            liquidity, 
            0,
            0,
            account, 
            deadline
          );
          
          await tx.wait();
          
          document.getElementById("removeModal").style.display = "none";
          
          const cfxEst = document.getElementById("removeEstCfx").textContent;
          const lomEst = document.getElementById("removeEstLom").textContent;
          
          Utils.showNotification(
            isChinese ? `移除流动性成功！获得 ${cfxEst} CFX 和 ${lomEst} LOM` : 
                       `Success! Received ${cfxEst} CFX and ${lomEst} LOM`,
            'success'
          );
          
          // 刷新所有数据，包括LP奖励信息
          await DataManager.refreshAll();
          if (document.getElementById('lpRewardTab').classList.contains('active')) {
            await LPRewardManager.refreshUserInfo();
          }
          
        } catch (error) {
          console.error('移除流动性失败:', error);
          Utils.showNotification(Utils.getErrorMessage(error), 'error');
        }
      },

      async updateRemoveEstimate(percent) {
        try {
          if (!account || !pair) return;
          
          document.getElementById("removePercent").textContent = percent + "%";
          
          const lpBal = await pair.balanceOf(account);
          const liquidity = lpBal.mul(percent).div(100);
          
          if (liquidity.isZero()) {
            document.getElementById("removeEstCfx").textContent = "0.000000";
            document.getElementById("removeEstLom").textContent = "0.000000";
            return;
          }
          
          const total = await pair.totalSupply();
          const { cfx: rCfx, lom: rLom } = currentReserves;
          
          const cfxReserve = TokenUtils.parseTokenAmount(rCfx.toString(), 'CFX');
          const lomReserve = TokenUtils.parseTokenAmount(rLom.toString(), 'LOM');
          
          const cfxOut = cfxReserve.mul(liquidity).div(total);
          const lomOut = lomReserve.mul(liquidity).div(total);
          
          const cfxOutFormatted = TokenUtils.formatTokenAmount(cfxOut, 'CFX');
          const lomOutFormatted = TokenUtils.formatTokenAmount(lomOut, 'LOM');
          
          document.getElementById("removeEstCfx").textContent = cfxOutFormatted;
          document.getElementById("removeEstLom").textContent = lomOutFormatted;
          
        } catch (error) {
          console.error("更新移除估算失败:", error);
          document.getElementById("removeEstCfx").textContent = "0.000000";
          document.getElementById("removeEstLom").textContent = "0.000000";
        }
      },

      updateAddButtonState() {
        const cfxAmount = document.getElementById("addCfx").value;
        const lomAmount = document.getElementById("addLom").value;
        const cfxBalance = parseFloat(document.getElementById("addCfxBal").textContent);
        const lomBalance = parseFloat(document.getElementById("addLomBal").textContent);
        const confirmButton = document.getElementById("confirmAddBtn");
        
        if (!cfxAmount || !lomAmount || cfxAmount === "" || lomAmount === "") {
          confirmButton.disabled = true;
          return;
        }
        
        const cfxNum = parseFloat(cfxAmount);
        const lomNum = parseFloat(lomAmount);
        
        if (isNaN(cfxNum) || isNaN(lomNum) || cfxNum <= 0 || lomNum <= 0) {
          confirmButton.disabled = true;
          return;
        }
        
        if (cfxNum > cfxBalance) {
          confirmButton.disabled = true;
          return;
        }
        
        if (lomNum > lomBalance) {
          confirmButton.disabled = true;
          return;
        }
        
        const remainingCfx = cfxBalance - cfxNum;
        if (remainingCfx < 0.01) {
          confirmButton.disabled = true;
          return;
        }
        
        confirmButton.disabled = false;
      },

      async setMaxCfx() {
        const cfxBal = parseFloat(document.getElementById("addCfxBal").textContent);
        if (cfxBal <= 0) {
          Utils.showError(isChinese ? "CFX余额不足" : "Insufficient CFX balance");
          return;
        }
        
        const maxCfx = Math.max(0, cfxBal - 0.1);
        document.getElementById("addCfx").value = Utils.formatDisplay(maxCfx);
        
        if (currentRatio > 0) {
          const requiredLom = maxCfx * currentRatio;
          const lomBal = parseFloat(document.getElementById("addLomBal").textContent);
          
          if (requiredLom <= lomBal) {
            document.getElementById("addLom").value = Utils.formatDisplay(requiredLom);
          } else {
            const adjustedCfx = lomBal / currentRatio;
            document.getElementById("addCfx").value = Utils.formatDisplay(Math.min(adjustedCfx, maxCfx));
            document.getElementById("addLom").value = Utils.formatDisplay(lomBal);
          }
        }
        
        this.updateAddButtonState();
      },

      async setMaxLom() {
        const lomBal = parseFloat(document.getElementById("addLomBal").textContent);
        if (lomBal <= 0) {
          Utils.showError(isChinese ? "LOM余额不足" : "Insufficient LOM balance");
          return;
        }
        
        document.getElementById("addLom").value = Utils.formatDisplay(lomBal);
        
        if (currentRatio > 0) {
          const requiredCfx = lomBal / currentRatio;
          const cfxBal = parseFloat(document.getElementById("addCfxBal").textContent);
          const availableCfx = Math.max(0, cfxBal - 0.1);
          
          if (requiredCfx <= availableCfx) {
            document.getElementById("addCfx").value = Utils.formatDisplay(requiredCfx);
          } else {
            const adjustedLom = availableCfx * currentRatio;
            document.getElementById("addLom").value = Utils.formatDisplay(Math.min(adjustedLom, lomBal));
            document.getElementById("addCfx").value = Utils.formatDisplay(availableCfx);
          }
        }
        
        this.updateAddButtonState();
      }
    };

    // ==================== 初始化应用 ====================
    document.addEventListener('DOMContentLoaded', function() {
      EventHandlers.init();
      
      if (window.ethereum) {
        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            AppCore.disconnect();
          } else {
            account = accounts[0];
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            AppCore.initContracts();
            AppCore.restoreInviteAddress();
            AppCore.updateUI();
            DataManager.refreshAll();
            LPRewardManager.refreshUserInfo();
            if (!refreshInterval) {
              refreshInterval = setInterval(() => {
                DataManager.refreshAll();
                if (document.getElementById('lpRewardTab').classList.contains('active')) {
                  LPRewardManager.refreshUserInfo();
                }
              }, 10000);
            }
          }
        });
        
        window.ethereum.on('chainChanged', () => {
          location.reload();
        });
        
        window.ethereum.on('disconnect', () => {
          AppCore.disconnect();
        });
      }
    });
  </script>
</body>
</html>
