<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOMswap</title>
  
  <!-- æ”¶è—å›¾æ ‡å’Œç¤¾äº¤åª’ä½“æ ‡ç­¾ -->
  <link rel="icon" type="image/x-icon" href="https://i.imgur.com/HddyTrv.jpeg">
  <link rel="apple-touch-icon" href="https://i.imgur.com/HddyTrv.jpeg">
  <link rel="shortcut icon" href="https://i.imgur.com/HddyTrv.jpeg">
  
  <!-- Open Graph æ ‡ç­¾ï¼Œç”¨äºç¤¾äº¤åª’ä½“åˆ†äº« -->
  <meta property="og:title" content="LOMswap - Conflux å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€">
  <meta property="og:description" content="åœ¨ Conflux eSpace ä¸Šäº¤æ˜“ LOM ä»£å¸">
  <meta property="og:image" content="https://i.imgur.com/HddyTrv.jpeg">
  <meta property="og:url" content="https://lom-dex.com">
  <meta name="twitter:card" content="summary_large_image">
  
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    /* ========== åŸºç¡€æ ·å¼ ========== */
    :root {
      --primary-dark: #0d1117;
      --primary-blue: #1a73e8;
      --accent-purple: #8a2be2;
      --accent-yellow: #ffd700;
      --accent-red: #ff4757;
      --accent-green: #2ea043;
      --card-bg: #161b22;
      --card-bg-light: #1c2128;
      --border-color: #30363d;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --success: #2ea043;
      --warning: #ff6b6b;
      --gradient-primary: linear-gradient(135deg, #1a73e8, #8a2be2);
      --gradient-yellow: linear-gradient(135deg, #ffd700, #ffa500);
      --gradient-red: linear-gradient(135deg, #ff4757, #ff6b81);
      --gradient-green: linear-gradient(135deg, #2ea043, #3ddc84);
      --gradient-card: linear-gradient(135deg, rgba(26, 115, 232, 0.1), rgba(138, 43, 226, 0.05));
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: var(--primary-dark);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(26, 115, 232, 0.05) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(138, 43, 226, 0.05) 0%, transparent 40%);
    }
    
    .app {
      width: 100%;
      max-width: 480px;
    }

    /* ========== å¤´éƒ¨æ ·å¼ ========== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 0 10px;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-image: url('https://i.imgur.com/HddyTrv.jpeg');
      background-size: cover;
      background-position: center;
      border: 2px solid var(--accent-yellow);
    }
    
    .logo-text {
      font-size: 24px;
      font-weight: 900;
      background: var(--gradient-yellow);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .wallet-section {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .btn {
      background: var(--gradient-primary);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      padding: 10px 16px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    #walletBtn.connected {
      background: rgba(46, 160, 67, 0.15);
      border: 1px solid var(--success);
      color: var(--success);
    }
    
    #langBtn {
      width: 40px;
      height: 40px;
      padding: 0;
    }
    
    /* ========== æ ‡ç­¾é¡µæ ·å¼ ========== */
    .tab-container {
      margin-bottom: 20px;
    }
    
    .tabs {
      display: flex;
      background: var(--card-bg);
      border-radius: 16px;
      padding: 4px;
      border: 1px solid var(--border-color);
    }
    
    .tab-btn {
      flex: 1;
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .tab-btn.active {
      background: var(--gradient-primary);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* ========== å¡ç‰‡æ ·å¼ ========== */
    .card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* ========== äº¤æ˜“ç•Œé¢æ ·å¼ ========== */
    .swap-container {
      position: relative;
    }
    
    .token-input-wrapper {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 12px;
      border: 1px solid var(--border-color);
      margin-bottom: 6px;
    }
    
    .token-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .balance-info {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .balance-amount {
      color: var(--accent-yellow);
      font-weight: 600;
      cursor: pointer;
    }
    
    .token-selector {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(26, 115, 232, 0.15);
      border: 1px solid rgba(26, 115, 232, 0.3);
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
    }
    
    .token-logo {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
    }
    
    .token-symbol {
      font-weight: 700;
    }
    
    .percentage-buttons {
      display: flex;
      gap: 4px;
      margin: 8px 0 12px;
      justify-content: flex-end;
    }
    
    .percent-btn {
      padding: 6px;
      background: rgba(26, 115, 232, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
    }
    
    .percent-btn.active {
      background: var(--accent-yellow);
      color: #0f172a;
      border-color: var(--accent-yellow);
    }
    
    .amount-input {
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 24px;
      font-weight: 700;
      text-align: right;
      width: 100%;
      outline: none;
    }
    
    .swap-center {
      position: relative;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: -6px 0;
    }
    
    .swap-arrow-btn {
      background: transparent;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      border: none;
      color: var(--text-secondary);
    }
    
    .swap-details {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 12px 16px;
      margin: 16px 0;
      border: 1px solid var(--border-color);
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0;
      font-size: 12px;
    }
    
    .detail-label {
      color: var(--text-secondary);
    }
    
    .detail-value {
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .slippage-options {
      display: flex;
      gap: 4px;
    }
    
    .slippage-btn {
      padding: 4px 8px;
      background: rgba(26, 115, 232, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
    }
    
    .slippage-btn.active {
      background: var(--accent-yellow);
      color: #0f172a;
      border-color: var(--accent-yellow);
    }
    
    .main-action-btn {
      background: var(--gradient-primary);
      color: white;
      font-weight: 700;
      padding: 16px;
      border: none;
      border-radius: 16px;
      width: 100%;
      font-size: 16px;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.3s ease;
    }
    
    .main-action-btn:hover {
      transform: translateY(-2px);
    }
    
    .main-action-btn:disabled {
      background: #475569;
      color: var(--text-secondary);
      cursor: not-allowed;
      transform: none;
    }
    
    /* ========== æµåŠ¨æ€§é¡µé¢æ ·å¼ ========== */
    .liquidity-summary {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    
    .liquidity-pair {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .pair-logo {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
    }
    
    .pair-logo.cfx {
      background-image: url('https://i.imgur.com/70cXbUI.jpeg');
    }
    
    .pair-logo.lom {
      background-image: url('https://i.imgur.com/HddyTrv.jpeg');
    }
    
    .liquidity-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-label-small {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .stat-value-large {
      font-size: 16px;
      font-weight: 700;
    }
    
    .user-position {
      background: var(--gradient-card);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      border: 1px solid var(--border-color);
    }
    
    .position-actions {
      display: flex;
      gap: 8px;
    }
    
    .position-btn {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    
    .add-btn {
      background: var(--gradient-primary);
      color: white;
    }
    
    .remove-btn {
      background: rgba(255, 71, 87, 0.15);
      color: var(--accent-red);
      border: 1px solid rgba(255, 71, 87, 0.3);
    }
    
    .remove-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ========== LPå¥–åŠ±é¡µé¢æ ·å¼ ========== */
    .lp-reward-panel {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .lp-reward-card {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(138, 43, 226, 0.1));
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      text-align: center;
    }
    
    .lp-reward-card-title {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .lp-reward-card-value {
      font-size: 18px;
      font-weight: 700;
    }
    
    .lp-reward-stats {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    
    .lp-reward-stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .lp-reward-stat-row:last-child {
      border-bottom: none;
    }
    
    .lp-reward-stat-label {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .lp-reward-stat-value {
      font-size: 14px;
      font-weight: 600;
    }
    
    .lp-reward-multiplier {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .lp-reward-multiplier-item {
      background: rgba(26, 115, 232, 0.1);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      border: 1px solid rgba(26, 115, 232, 0.2);
    }
    
    .lp-reward-multiplier-item.active {
      background: rgba(255, 215, 0, 0.2);
      border-color: var(--accent-yellow);
    }
    
    .lp-reward-multiplier-days {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .lp-reward-multiplier-value {
      font-size: 14px;
      font-weight: 700;
    }
    
    .lp-reward-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .lp-reward-action-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .lp-reward-action-btn.activate {
      background: var(--gradient-yellow);
      color: #0f172a;
    }
    
    .lp-reward-action-btn.claim {
      background: var(--gradient-primary);
      color: white;
    }
    
    .lp-reward-action-btn.referral {
      background: var(--gradient-green);
      color: white;
    }
    
    .lp-reward-action-btn:disabled {
      background: #475569;
      color: var(--text-secondary);
      cursor: not-allowed;
    }
    
    /* ========== æ¨¡æ€æ¡†æ ·å¼ ========== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(13, 17, 23, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      border: 1px solid var(--border-color);
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .modal-input-group {
      margin-bottom: 12px;
    }
    
    .modal-input-label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    
    .modal-input {
      width: 100%;
      padding: 12px 14px;
      background: rgba(26, 115, 232, 0.05);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    
    .modal-btn.cancel {
      background: var(--card-bg);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }
    
    .modal-btn.confirm {
      background: var(--gradient-primary);
      color: white;
    }
    
    /* ========== ç§»é™¤æµåŠ¨æ€§æ ·å¼ ========== */
    .remove-percentage {
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      margin: 8px 0;
    }
    
    .percentage-slider {
      width: 100%;
      margin: 16px 0;
      height: 6px;
      background: rgba(26, 115, 232, 0.1);
      border-radius: 3px;
      outline: none;
    }
    
    .percentage-options {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }
    
    .percentage-option {
      padding: 8px;
      text-align: center;
      background: rgba(26, 115, 232, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 12px;
    }
    
    .percentage-option.active {
      background: var(--accent-yellow);
      color: #0f172a;
      border-color: var(--accent-yellow);
    }
    
    .remove-estimate {
      background: rgba(26, 115, 232, 0.1);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      border: 1px solid var(--border-color);
      margin-top: 16px;
    }
    
    /* ========== é£é™©æç¤ºå’Œé¡µè„š ========== */
    .risk-warning {
      background: var(--gradient-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 16px;
      margin: 16px 0;
      text-align: center;
      font-size: 11px;
      line-height: 1.5;
    }
    
    .risk-title {
      font-weight: 700;
      margin-bottom: 6px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      color: var(--accent-yellow);
    }
    
    .footer {
      text-align: center;
      padding: 16px 0;
      color: var(--text-secondary);
      font-size: 12px;
    }
    
    /* ========== å“åº”å¼è°ƒæ•´ ========== */
    @media (max-width: 480px) {
      .app {
        padding: 0;
      }
      
      .card {
        margin: 10px;
        padding: 14px;
      }
      
      .header {
        padding: 10px;
      }
      
      .logo-img {
        width: 44px;
        height: 44px;
      }
      
      .logo-text {
        font-size: 18px;
      }
      
      #walletBtn {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      #langBtn {
        width: 36px;
        height: 36px;
      }
      
      .tab-btn {
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .lp-reward-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- åº”ç”¨ç•Œé¢ -->
  <div class="app">
    <!-- å¤´éƒ¨ -->
    <div class="header">
      <div class="logo-container">
        <div class="logo-img"></div>
        <div class="logo-text">LOMswap</div>
      </div>
      <div class="wallet-section">
        <button class="btn" id="langBtn">EN</button>
        <button class="btn" id="walletBtn">è¿æ¥é’±åŒ…</button>
      </div>
    </div>

    <!-- æ ‡ç­¾é¡µ -->
    <div class="tab-container">
      <div class="tabs">
        <button class="tab-btn active" data-tab="swap">å…‘æ¢</button>
        <button class="tab-btn" data-tab="liquidity">æµåŠ¨æ€§</button>
        <button class="tab-btn" data-tab="lpReward">LPå¥–åŠ±</button>
      </div>
    </div>

    <!-- å…‘æ¢é¡µé¢ -->
    <div class="tab-content active" id="swapTab">
      <div class="card">
        <div class="swap-container">
          <!-- è¾“å…¥ä»£å¸ -->
          <div class="token-input-wrapper">
            <div class="token-header">
              <div class="balance-info">
                ä½™é¢: <span class="balance-amount" id="fromBal">0</span>
              </div>
              <div class="token-selector" id="fromTokenSelector">
                <div class="token-logo" id="fromTokenLogo" style="background-image: url('https://i.imgur.com/70cXbUI.jpeg');"></div>
                <div class="token-symbol" id="fromTokenSymbol">CFX</div>
              </div>
            </div>
            
            <div class="percentage-buttons">
              <button class="percent-btn" data-percent="0.25">25%</button>
              <button class="percent-btn" data-percent="0.5">50%</button>
              <button class="percent-btn" data-percent="1">MAX</button>
            </div>
            
            <div class="amount-input-area">
              <input class="amount-input" id="fromAmount" placeholder="0" type="number" min="0" step="any">
            </div>
          </div>

          <!-- äº¤æ¢ç®­å¤´ -->
          <div class="swap-center">
            <button class="swap-arrow-btn" id="reverse">ğŸ”ƒ</button>
          </div>

          <!-- è¾“å‡ºä»£å¸ -->
          <div class="token-input-wrapper">
            <div class="token-header">
              <div class="balance-info">
                ä½™é¢: <span class="balance-amount" id="toBal">0</span>
              </div>
              <div class="token-selector" id="toTokenSelector">
                <div class="token-logo" id="toTokenLogo" style="background-image: url('https://i.imgur.com/HddyTrv.jpeg');"></div>
                <div class="token-symbol" id="toTokenSymbol">LOM</div>
              </div>
            </div>
            
            <div class="amount-input-area">
              <input class="amount-input" id="toAmount" placeholder="0" type="number" min="0" step="any" readonly>
            </div>
          </div>

          <!-- äº¤æ˜“è¯¦æƒ… -->
          <div class="swap-details">
            <div class="detail-row">
              <span class="detail-label">æ»‘ç‚¹å®¹å·®</span>
              <div class="slippage-options">
                <button class="slippage-btn active" data-slip="0.1">0.1%</button>
                <button class="slippage-btn" data-slip="0.5">0.5%</button>
                <button class="slippage-btn" data-slip="5">5%</button>
              </div>
            </div>
            <div class="detail-row">
              <span class="detail-label">ä»·æ ¼</span>
              <span class="detail-value" id="price">1 CFX = 0 LOM</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">æœ€ä½æ”¶åˆ°</span>
              <span class="detail-value" id="minReceived">0 LOM</span>
            </div>
          </div>

          <!-- äº¤æ˜“æŒ‰é’® -->
          <button class="main-action-btn" id="swapBtn">è¿æ¥é’±åŒ…</button>
        </div>
      </div>
    </div>
    
    <!-- æµåŠ¨æ€§é¡µé¢ -->
    <div class="tab-content" id="liquidityTab">
      <div class="card">
        <div class="card-title">
          <span>ğŸ’§</span>
          <span>CFX-LOM æ± </span>
        </div>

        <div class="liquidity-summary">
          <div class="liquidity-pair">
            <div class="pair-logo cfx"></div>
            <div style="margin: 0 8px;">+</div>
            <div class="pair-logo lom"></div>
          </div>
          
          <div class="liquidity-stats">
            <div class="stat-item">
              <div class="stat-label-small">CFX å‚¨å¤‡</div>
              <div class="stat-value-large" id="cfxReserve">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label-small">LOM å‚¨å¤‡</div>
              <div class="stat-value-large" id="lomReserve">0</div>
            </div>
          </div>
          
          <!-- æˆ‘çš„æµåŠ¨æ±  -->
          <div class="user-position">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 14px; font-weight: 600;">æˆ‘çš„æµåŠ¨æ± </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <div style="text-align: center;">
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">æˆ‘çš„CFX</div>
                <div style="font-size: 16px; font-weight: 700; color: var(--accent-yellow);" id="userCfx">0</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">æˆ‘çš„LOM</div>
                <div style="font-size: 16px; font-weight: 700; color: var(--accent-yellow);" id="userLom">0</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">æˆ‘çš„LPä»£å¸</div>
                <div style="font-size: 16px; font-weight: 700;" id="userLp">0</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">æ± å­ä»½é¢</div>
                <div style="font-size: 16px; font-weight: 700; color: var(--accent-green);" id="userPoolShare">0%</div>
              </div>
            </div>
          </div>

          <div class="position-actions">
            <button class="position-btn add-btn" id="addBtn">æ·»åŠ æµåŠ¨æ€§</button>
            <button class="position-btn remove-btn" id="removeBtn" disabled>ç§»é™¤æµåŠ¨æ€§</button>
          </div>
        </div>
      </div>
    </div>

    <!-- LPå¥–åŠ±é¡µé¢ -->
    <div class="tab-content" id="lpRewardTab">
      <div class="card">
        <div class="card-title">
          <span>ğŸ†</span>
          <span>LPæŒå¸å¥–åŠ±</span>
        </div>

        <!-- æ¿€æ´»çŠ¶æ€é¢æ¿ -->
        <div class="lp-reward-panel">
          <div class="lp-reward-card">
            <div class="lp-reward-card-title">
              <span>ğŸ“Š</span>
              <span>æ¿€æ´»çŠ¶æ€</span>
            </div>
            <div class="lp-reward-card-value" id="activationStatus">æœªæ¿€æ´»</div>
          </div>
          
          <div class="lp-reward-card">
            <div class="lp-reward-card-title">
              <span>ğŸ’°</span>
              <span>LPæŒä»“</span>
            </div>
            <div class="lp-reward-card-value" id="lpBalance">0 LPT</div>
          </div>
          
          <div class="lp-reward-card">
            <div class="lp-reward-card-title">
              <span>â±ï¸</span>
              <span>æŒæœ‰æ—¶é•¿</span>
            </div>
            <div class="lp-reward-card-value" id="daysHeld">0 å¤©</div>
          </div>
          
          <div class="lp-reward-card">
            <div class="lp-reward-card-title">
              <span>ğŸš€</span>
              <span>å¥–åŠ±å€ç‡</span>
            </div>
            <div class="lp-reward-card-value" style="color: var(--accent-green);" id="rewardMultiplier">1.0x</div>
          </div>
        </div>

        <!-- å¥–åŠ±ä¿¡æ¯ -->
        <div class="lp-reward-stats">
          <div class="lp-reward-stat-row">
            <div class="lp-reward-stat-label">
              <span>ğŸ’</span>
              <span>å¾…é¢†å–å¥–åŠ±</span>
            </div>
            <div class="lp-reward-stat-value" id="pendingReward">0 LOM</div>
          </div>
          
          <div class="lp-reward-stat-row">
            <div class="lp-reward-stat-label">
              <span>ğŸ“ˆ</span>
              <span>æ¯æ—¥é¢„ä¼°æ”¶ç›Š</span>
            </div>
            <div class="lp-reward-stat-value" id="dailyReward">0 LOM</div>
          </div>
          
          <div class="lp-reward-stat-row">
            <div class="lp-reward-stat-label">
              <span>âš¡</span>
              <span>ä¸‹æ¬¡é¢†å–æ—¶é—´</span>
            </div>
            <div class="lp-reward-stat-value" id="nextClaimTime">--</div>
          </div>
          
          <div class="lp-reward-stat-row">
            <div class="lp-reward-stat-label">
              <span>ğŸ</span>
              <span>æ¨èå¥–åŠ±</span>
            </div>
            <div class="lp-reward-stat-value" style="color: var(--accent-green);" id="pendingReferral">0 LOM</div>
          </div>
        </div>

        <!-- æ—¶é—´å€ç‡ -->
        <div class="lp-reward-multiplier">
          <div class="lp-reward-multiplier-item" id="multiplier30d">
            <div class="lp-reward-multiplier-days">30å¤©</div>
            <div class="lp-reward-multiplier-value">1.0x</div>
          </div>
          
          <div class="lp-reward-multiplier-item" id="multiplier90d">
            <div class="lp-reward-multiplier-days">90å¤©</div>
            <div class="lp-reward-multiplier-value">1.5x</div>
          </div>
          
          <div class="lp-reward-multiplier-item" id="multiplier180d">
            <div class="lp-reward-multiplier-days">180å¤©</div>
            <div class="lp-reward-multiplier-value">2.0x</div>
          </div>
          
          <div class="lp-reward-multiplier-item" id="multiplier360d">
            <div class="lp-reward-multiplier-days">360å¤©</div>
            <div class="lp-reward-multiplier-value">3.0x</div>
          </div>
        </div>

        <!-- æ¨èç³»ç»Ÿï¼ˆåªåœ¨æœªæ¿€æ´»ä¸”æœªç»‘å®šæ¨èäººæ—¶æ˜¾ç¤ºï¼‰ -->
        <div id="referralSection" style="display: none; margin-bottom: 20px;">
          <div style="background: rgba(255, 215, 0, 0.1); border-radius: 12px; padding: 16px; border: 1px solid rgba(255, 215, 0, 0.3);">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <span>ğŸ‘¥</span>
              <span style="font-size: 14px; font-weight: 600;">æ¨èç³»ç»Ÿ</span>
            </div>
            
            <input type="text" class="modal-input" id="referrerAddress" 
                   placeholder="è¾“å…¥æ¨èäººåœ°å€ (å¯é€‰)" style="margin-bottom: 12px;">
            
            <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.4;">
              ç»‘å®šæ¨èäººå¯äº«å—é¢å¤–å¥–åŠ±åŠ æˆï¼Œæ¨èå¥–åŠ±é”å®š30å¤©
            </div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="lp-reward-actions">
          <button class="lp-reward-action-btn activate" id="activateBtn" disabled>
            <span>ğŸš€</span>
            <span>æ¿€æ´»å¥–åŠ±</span>
          </button>
          
          <button class="lp-reward-action-btn claim" id="claimBtn" disabled>
            <span>ğŸ’°</span>
            <span>é¢†å–å¥–åŠ±</span>
          </button>
          
          <button class="lp-reward-action-btn referral" id="claimReferralBtn" disabled>
            <span>ğŸ</span>
            <span>é¢†å–æ¨è</span>
          </button>
        </div>

        <!-- å¸®åŠ©ä¿¡æ¯ -->
        <div style="background: rgba(26, 115, 232, 0.1); border-radius: 12px; padding: 16px; margin-top: 20px; border: 1px solid rgba(26, 115, 232, 0.3);">
          <div style="font-size: 14px; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <span>â“</span>
            <span>é‡è¦æç¤º</span>
          </div>
          <ul style="list-style: none; padding: 0; margin: 0;">
            <li style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; display: flex; align-items: flex-start; gap: 8px; line-height: 1.4;">
              <span>âœ“</span>
              <span>æŒæœ‰æ—¶é•¿è¶Šé•¿ï¼Œå¥–åŠ±å€ç‡è¶Šé«˜ï¼ˆæœ€é«˜3å€ï¼‰</span>
            </li>
            <li style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; display: flex; align-items: flex-start; gap: 8px; line-height: 1.4;">
              <span>âœ“</span>
              <span>æ¯7å¤©å¯é¢†å–ä¸€æ¬¡å¥–åŠ±</span>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- é£é™©æç¤º -->
    <div class="risk-warning">
      <div class="risk-title">
        <span>âš ï¸</span>
        <span>é£é™©æç¤º</span>
      </div>
      æœ¬åº”ç”¨ä»…ä½œä¸ºæŠ€æœ¯æ¼”ç¤ºï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚åŠ å¯†è´§å¸å¸‚åœºæ³¢åŠ¨å·¨å¤§ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚
    </div>

    <!-- é¡µè„š -->
    <div class="footer">LOMswap Â· Conflux eSpace</div>
  </div>

  <!-- æ·»åŠ æµåŠ¨æ€§æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="addModal">
    <div class="modal-card">
      <h3 class="modal-title">æ·»åŠ æµåŠ¨æ€§</h3>
      
      <div class="modal-input-group">
        <label class="modal-input-label">CFX æ•°é‡</label>
        <div style="display: flex; gap: 8px;">
          <input type="number" class="modal-input" id="addCfx" placeholder="0" step="any" min="0">
          <button class="btn" id="cfxMaxBtn" style="height: auto; padding: 8px 12px; min-width: 50px; font-size: 12px;">MAX</button>
        </div>
        <div style="text-align: right; margin-top: 4px; font-size: 11px; color: var(--text-secondary);">
          ä½™é¢: <span id="addCfxBal">0</span> CFX
        </div>
      </div>
      
      <div style="text-align: center; font-size: 20px; margin: 12px 0;">+</div>
      
      <div class="modal-input-group">
        <label class="modal-input-label">LOM æ•°é‡</label>
        <div style="display: flex; gap: 8px;">
          <input type="number" class="modal-input" id="addLom" placeholder="0" step="any" min="0">
          <button class="btn" id="lomMaxBtn" style="height: auto; padding: 8px 12px; min-width: 50px; font-size: 12px;">MAX</button>
        </div>
        <div style="text-align: right; margin-top: 4px; font-size: 11px; color: var(--text-secondary);">
          ä½™é¢: <span id="addLomBal">0</span> LOM
        </div>
      </div>
      
      <div style="background: rgba(26, 115, 232, 0.1); border-radius: 10px; padding: 10px; margin: 12px 0; text-align: center;">
        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">æ¯”ä¾‹</div>
        <div style="font-size: 14px; font-weight: 600;" id="addRatio">1 CFX = 0 LOM</div>
      </div>
      
      <div class="modal-actions">
        <button class="modal-btn cancel" id="cancelAddBtn">å–æ¶ˆ</button>
        <button class="modal-btn confirm" id="confirmAddBtn" disabled>ç¡®è®¤æ·»åŠ </button>
      </div>
    </div>
  </div>

  <!-- ç§»é™¤æµåŠ¨æ€§æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="removeModal">
    <div class="modal-card">
      <h3 class="modal-title">ç§»é™¤æµåŠ¨æ€§</h3>
      
      <div class="remove-percentage">
        <span id="removePercent">100%</span>
      </div>
      
      <input type="range" min="0" max="100" value="100" step="1" class="percentage-slider" id="removeSlider">
      
      <div class="percentage-options">
        <div class="percentage-option" data-percent="25">25%</div>
        <div class="percentage-option" data-percent="50">50%</div>
        <div class="percentage-option" data-percent="75">75%</div>
        <div class="percentage-option active" data-percent="100">100%</div>
      </div>
      
      <div class="remove-estimate">
        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px;">é¢„è®¡è·å¾—</div>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <div style="font-size: 16px; font-weight: bold;">
            <span id="removeEstCfx">0</span> CFX
          </div>
          <div style="font-size: 16px; font-weight: bold;">
            <span id="removeEstLom">0</span> LOM
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="modal-btn cancel" id="cancelRemoveBtn">å–æ¶ˆ</button>
        <button class="modal-btn confirm" id="confirmRemoveBtn" style="background: var(--gradient-red);">ç¡®è®¤ç§»é™¤</button>
      </div>
    </div>
  </div>

  <script>
    'use strict';

    // ==================== é…ç½® ====================
    const APP_CONFIG = {
      CONTRACTS: {
        ROUTER: "0x62b0873055bf896dd869e172119871ac24aea305",
        LOM: "0xb4ca1cb2651a822bf65c614c880a26fd124932a3",
        WCFX: "0x14b2d3bc65e74dae1030eafd8ac30c533c976a9b",
        PAIR: "0x063128f4e6BDFBC693d03649000B6E4dA00Bec85",
        LP_REWARD: "0x233f9C12514A29d860e482eB29f1EE1f8fcC59aa"
      },
      CHAIN_ID: 1030
    };

    // ==================== çŠ¶æ€ ====================
    let provider, signer, account;
    let router, pair, lom, lpRewardContract;
    let slippage = 0.1;
    let fromToken = "CFX";
    let toToken = "LOM";
    let currentRatio = 0;
    let currentReserves = { cfx: 0, lom: 0 };
    let lpRewardUserInfo = null;
    let lpBalance = 0;
    let referrerAddress = '';

    // ==================== å·¥å…·å‡½æ•° ====================
    const Utils = {
      formatDisplay(value) {
        if (!value && value !== 0) return '0.000000';
        const num = parseFloat(value);
        if (isNaN(num)) return '0.000000';
        return num.toFixed(6).replace(/\.?0+$/, '');
      },

      formatAddress(address) {
        if (!address) return '';
        return address.slice(0, 6) + '...' + address.slice(-4);
      },

      showError(message) {
        alert(message);
      }
    };

    // ==================== åˆçº¦ABI ====================
    const ROUTER_ABI = [
      "function getAmountsOut(uint amountIn, address[] path) view returns (uint[] memory amounts)",
      "function swapExactETHForTokensSupportingFeeOnTransferTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) payable",
      "function swapExactTokensForETHSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline)",
      "function addLiquidityETH(address token, uint amountTokenDesired, uint amountTokenMin, uint amountETHMin, address to, uint deadline) payable returns (uint amountToken, uint amountETH, uint liquidity)",
      "function removeLiquidityETH(address token, uint liquidity, uint amountTokenMin, uint amountETHMin, address to, uint deadline) returns (uint amountToken, uint amountETH)"
    ];

    const ERC20_ABI = [
      "function approve(address spender, uint256 amount) returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function balanceOf(address owner) view returns (uint256)",
      "function decimals() view returns (uint8)"
    ];

    const PAIR_ABI = [
      "function getReserves() view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)",
      "function totalSupply() view returns (uint256)",
      "function balanceOf(address owner) view returns (uint256)",
      "function token0() view returns (address)"
    ];

    const LP_REWARD_ABI = [
      "function users(address) view returns (uint256 shares, uint256 rewardDebt, uint256 pendingReferral, uint256 lastClaimTime, uint256 activeTime, uint256 lastReduceTime, uint256 referralUnlockTime, address referrer, bool cleanInFirst30Days)",
      "function minActivation() view returns (uint256)",
      "function totalShares() view returns (uint256)",
      "function rewardPerSecond() view returns (uint256)",
      "function pendingReward(address user) view returns (uint256)",
      "function activate(address referrer)",
      "function claimAll()",
      "function claimReferral()"
    ];

    // ==================== æ ¸å¿ƒåŠŸèƒ½ ====================
    class AppCore {
      static async connectWallet() {
        try {
          if (!window.ethereum) {
            Utils.showError("è¯·å®‰è£…TPæˆ–web3é’±åŒ…");
            return false;
          }
          
          const accounts = await window.ethereum.request({
            method: 'eth_requestAccounts'
          });
          
          if (!accounts || accounts.length === 0) {
            throw new Error('ç”¨æˆ·æ‹’ç»è¿æ¥');
          }
          
          account = accounts[0];
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          
          await this.checkNetwork();
          this.initContracts();
          
          // ä»localStorageæ¢å¤æ¨èäººåœ°å€
          referrerAddress = localStorage.getItem(`lomswap_referrer_${account.toLowerCase()}`) || '';
          
          this.updateUI();
          DataManager.refreshAll();
          LPRewardManager.refreshUserInfo();
          
          return true;
        } catch (error) {
          Utils.showError(`è¿æ¥å¤±è´¥: ${error.message}`);
          return false;
        }
      }

      static async checkNetwork() {
        const network = await provider.getNetwork();
        if (network.chainId !== APP_CONFIG.CHAIN_ID) {
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0x' + APP_CONFIG.CHAIN_ID.toString(16) }]
            });
          } catch (error) {
            Utils.showError('è¯·åˆ‡æ¢åˆ°Conflux eSpaceç½‘ç»œ');
            throw error;
          }
        }
      }

      static initContracts() {
        router = new ethers.Contract(APP_CONFIG.CONTRACTS.ROUTER, ROUTER_ABI, signer);
        pair = new ethers.Contract(APP_CONFIG.CONTRACTS.PAIR, PAIR_ABI, signer);
        lom = new ethers.Contract(APP_CONFIG.CONTRACTS.LOM, ERC20_ABI, signer);
        
        if (APP_CONFIG.CONTRACTS.LP_REWARD) {
          lpRewardContract = new ethers.Contract(
            APP_CONFIG.CONTRACTS.LP_REWARD,
            LP_REWARD_ABI,
            signer
          );
        }
      }

      static updateUI() {
        const walletBtn = document.getElementById("walletBtn");
        const swapBtn = document.getElementById("swapBtn");
        
        if (account) {
          const displayAddress = Utils.formatAddress(account);
          walletBtn.textContent = displayAddress;
          walletBtn.classList.add('connected');
          swapBtn.textContent = "è¯·è¾“å…¥æ•°é‡";
          swapBtn.disabled = false;
        } else {
          walletBtn.textContent = "è¿æ¥é’±åŒ…";
          walletBtn.classList.remove('connected');
          swapBtn.textContent = "è¿æ¥é’±åŒ…";
          swapBtn.disabled = false;
        }
      }
    }

    // ==================== æ•°æ®ç®¡ç† ====================
    const DataManager = {
      async refreshAll() {
        if (!account) return;
        await this.updateAllBalances();
        await this.updatePoolInfo();
        this.updateSwapButtonState();
      },

      async updateAllBalances() {
        if (!account) return;
        
        try {
          // CFXä½™é¢
          const cfxBal = await provider.getBalance(account);
          const cfxBalance = parseFloat(ethers.utils.formatEther(cfxBal));
          document.getElementById("fromBal").textContent = Utils.formatDisplay(cfxBalance);
          document.getElementById("addCfxBal").textContent = Utils.formatDisplay(cfxBalance);
          
          // LOMä½™é¢
          const lomBal = await lom.balanceOf(account);
          const lomBalance = parseFloat(ethers.utils.formatUnits(lomBal, 18));
          document.getElementById("toBal").textContent = Utils.formatDisplay(lomBalance);
          document.getElementById("addLomBal").textContent = Utils.formatDisplay(lomBalance);
          
          // LPä»£å¸ä½™é¢
          if (pair) {
            const lpBal = await pair.balanceOf(account);
            const lpAmt = parseFloat(ethers.utils.formatUnits(lpBal, 18));
            document.getElementById("removeBtn").disabled = lpBal.isZero();
            lpBalance = lpAmt;
          }
          
        } catch (error) {
          console.error("æ›´æ–°ä½™é¢å¤±è´¥:", error);
        }
      },

      async updatePoolInfo() {
        try {
          if (!pair || !account) return;
          
          const [r0, r1] = await pair.getReserves();
          const t0 = await pair.token0();
          const totalSupply = await pair.totalSupply();
          
          const reserveCfx = t0.toLowerCase() === APP_CONFIG.CONTRACTS.WCFX.toLowerCase() ? r0 : r1;
          const reserveLom = t0.toLowerCase() === APP_CONFIG.CONTRACTS.WCFX.toLowerCase() ? r1 : r0;
          
          const cfxReserve = parseFloat(ethers.utils.formatEther(reserveCfx));
          const lomReserve = parseFloat(ethers.utils.formatUnits(reserveLom, 18));
          
          currentReserves.cfx = cfxReserve;
          currentReserves.lom = lomReserve;
          
          currentRatio = lomReserve / cfxReserve;
          
          document.getElementById("cfxReserve").textContent = cfxReserve.toFixed(2);
          document.getElementById("lomReserve").textContent = lomReserve.toFixed(2);
          document.getElementById("addRatio").textContent = `1 CFX = ${currentRatio.toFixed(6)} LOM`;

          const totalSupplyNum = parseFloat(ethers.utils.formatUnits(totalSupply, 18));
          
          const lpBal = await pair.balanceOf(account);
          const lpAmt = parseFloat(ethers.utils.formatUnits(lpBal, 18));
          
          if (totalSupplyNum > 0 && lpAmt > 0) {
            const share = (lpAmt / totalSupplyNum) * 100;
            const userCfx = cfxReserve * (share / 100);
            const userLom = lomReserve * (share / 100);
            
            document.getElementById("userCfx").textContent = userCfx.toFixed(2);
            document.getElementById("userLom").textContent = userLom.toFixed(2);
            document.getElementById("userLp").textContent = lpAmt.toFixed(2);
            document.getElementById("userPoolShare").textContent = share.toFixed(4) + "%";
          }
          
        } catch (error) {
          console.error("æ›´æ–°æ± å­ä¿¡æ¯å¤±è´¥:", error);
        }
      },

      updateSwapButtonState() {
        const swapBtn = document.getElementById("swapBtn");
        const fromAmount = document.getElementById("fromAmount").value;
        
        if (!account) {
          swapBtn.textContent = "è¿æ¥é’±åŒ…";
          swapBtn.disabled = false;
          return;
        }
        
        if (!fromAmount || fromAmount === "0" || fromAmount === "") {
          swapBtn.textContent = "è¯·è¾“å…¥æ•°é‡";
          swapBtn.disabled = true;
          return;
        }
        
        swapBtn.textContent = "ç«‹å³å…‘æ¢";
        swapBtn.disabled = false;
      }
    };

    // ==================== LPå¥–åŠ±ç®¡ç† ====================
    const LPRewardManager = {
      async refreshUserInfo() {
        if (!account || !lpRewardContract) return;
        
        try {
          const userInfo = await lpRewardContract.users(account);
          
          lpRewardUserInfo = {
            shares: parseFloat(ethers.utils.formatUnits(userInfo.shares, 18)),
            pendingReferral: parseFloat(ethers.utils.formatUnits(userInfo.pendingReferral, 18)),
            lastClaimTime: userInfo.lastClaimTime.toNumber(),
            activeTime: userInfo.activeTime.toNumber(),
            referrer: userInfo.referrer
          };
          
          this.updateUI();
          
        } catch (error) {
          console.error('åˆ·æ–°LPå¥–åŠ±ä¿¡æ¯å¤±è´¥:', error);
        }
      },

      updateUI() {
        const isActivated = lpRewardUserInfo && lpRewardUserInfo.shares > 0;
        const referralSection = document.getElementById('referralSection');
        
        document.getElementById('activationStatus').textContent = isActivated ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»';
        document.getElementById('lpBalance').textContent = `${Utils.formatDisplay(lpBalance)} LPT`;
        
        if (isActivated) {
          // å·²æ¿€æ´»ï¼šéšè—æ¨èè¾“å…¥æ¡†
          referralSection.style.display = 'none';
          
          const daysHeld = Math.floor((Date.now() / 1000 - lpRewardUserInfo.activeTime) / 86400);
          document.getElementById('daysHeld').textContent = `${daysHeld} å¤©`;
          
          const multiplier = this.calculateMultiplier(daysHeld);
          document.getElementById('rewardMultiplier').textContent = `${multiplier.toFixed(1)}x`;
          
          this.highlightMultiplier(daysHeld);
          this.updateRewardInfo();
          
          // æ¿€æ´»æŒ‰é’®çŠ¶æ€
          document.getElementById('activateBtn').disabled = true;
          document.getElementById('activateBtn').innerHTML = '<span>âœ…</span><span>å·²æ¿€æ´»</span>';
          
          // é¢†å–æŒ‰é’®çŠ¶æ€ï¼ˆæ ¹æ®æ—¶é—´åˆ¤æ–­ï¼‰
          const canClaim = this.canClaimReward();
          document.getElementById('claimBtn').disabled = !canClaim;
          document.getElementById('claimBtn').innerHTML = canClaim ? 
            '<span>ğŸ’°</span><span>é¢†å–å¥–åŠ±</span>' : 
            '<span>â³</span><span>ç­‰å¾…ä¸­</span>';
          
          // æ¨èå¥–åŠ±æŒ‰é’®çŠ¶æ€
          const canClaimReferral = this.canClaimReferral();
          document.getElementById('claimReferralBtn').disabled = !canClaimReferral;
          document.getElementById('claimReferralBtn').innerHTML = canClaimReferral ? 
            '<span>ğŸ</span><span>é¢†å–æ¨è</span>' : 
            '<span>ğŸ”’</span><span>é”å®šä¸­</span>';
          
        } else {
          // æœªæ¿€æ´»ï¼šæ˜¾ç¤ºæ¨èè¾“å…¥æ¡†ï¼ˆå¦‚æœç”¨æˆ·æœ‰ä¿å­˜çš„æ¨èäººåœ°å€ï¼‰
          if (referrerAddress) {
            document.getElementById('referrerAddress').value = referrerAddress;
            referralSection.style.display = 'block';
          } else {
            referralSection.style.display = 'block';
          }
          
          document.getElementById('daysHeld').textContent = '0 å¤©';
          document.getElementById('rewardMultiplier').textContent = '1.0x';
          
          // æ¿€æ´»æŒ‰é’®çŠ¶æ€
          const canActivate = this.canActivate();
          document.getElementById('activateBtn').disabled = !canActivate;
          document.getElementById('activateBtn').innerHTML = canActivate ? 
            '<span>ğŸš€</span><span>æ¿€æ´»å¥–åŠ±</span>' : 
            '<span>â³</span><span>æ¡ä»¶ä¸ç¬¦</span>';
          
          // å…¶ä»–æŒ‰é’®çŠ¶æ€
          document.getElementById('claimBtn').disabled = true;
          document.getElementById('claimReferralBtn').disabled = true;
        }
      },

      calculateMultiplier(daysHeld) {
        if (daysHeld >= 360) return 3.0;
        if (daysHeld >= 180) return 2.0;
        if (daysHeld >= 90) return 1.5;
        return 1.0;
      },

      highlightMultiplier(daysHeld) {
        document.querySelectorAll('.lp-reward-multiplier-item').forEach(item => item.classList.remove('active'));
        if (daysHeld >= 360) {
          document.getElementById('multiplier360d').classList.add('active');
        } else if (daysHeld >= 180) {
          document.getElementById('multiplier180d').classList.add('active');
        } else if (daysHeld >= 90) {
          document.getElementById('multiplier90d').classList.add('active');
        } else {
          document.getElementById('multiplier30d').classList.add('active');
        }
      },

      async updateRewardInfo() {
        if (!lpRewardContract || !lpRewardUserInfo) return;
        
        try {
          const pendingReward = await lpRewardContract.pendingReward(account);
          const pendingRewardAmount = parseFloat(ethers.utils.formatUnits(pendingReward, 18));
          
          document.getElementById('pendingReward').textContent = `${Utils.formatDisplay(pendingRewardAmount)} LOM`;
          
          // è®¡ç®—ä¸‹æ¬¡é¢†å–æ—¶é—´
          const nextClaimTime = lpRewardUserInfo.lastClaimTime + 7 * 86400;
          const now = Math.floor(Date.now() / 1000);
          
          if (now >= nextClaimTime) {
            document.getElementById('nextClaimTime').textContent = 'ç°åœ¨å¯ä»¥é¢†å–';
          } else {
            const timeLeft = nextClaimTime - now;
            const daysLeft = Math.floor(timeLeft / 86400);
            const hoursLeft = Math.floor((timeLeft % 86400) / 3600);
            document.getElementById('nextClaimTime').textContent = `${daysLeft}å¤©${hoursLeft}å°æ—¶å`;
          }
          
          document.getElementById('pendingReferral').textContent = `${Utils.formatDisplay(lpRewardUserInfo.pendingReferral)} LOM`;
          
        } catch (error) {
          console.error('æ›´æ–°å¥–åŠ±ä¿¡æ¯å¤±è´¥:', error);
        }
      },

      canActivate() {
        if (!account || !pair) return false;
        if (lpRewardUserInfo && lpRewardUserInfo.shares > 0) return false;
        return lpBalance > 0;
      },

      canClaimReward() {
        if (!lpRewardUserInfo) return false;
        const now = Math.floor(Date.now() / 1000);
        const timeSinceLastClaim = now - lpRewardUserInfo.lastClaimTime;
        return timeSinceLastClaim >= 7 * 86400;
      },

      canClaimReferral() {
        if (!lpRewardUserInfo || lpRewardUserInfo.pendingReferral <= 0) return false;
        return true;
      },

      async activateReward() {
        if (!account || !lpRewardContract) return;
        
        try {
          // ä¿å­˜æ¨èäººåœ°å€åˆ°localStorage
          if (referrerAddress) {
            localStorage.setItem(`lomswap_referrer_${account.toLowerCase()}`, referrerAddress);
          }
          
          const tx = await lpRewardContract.activate(referrerAddress || ethers.constants.AddressZero);
          await tx.wait();
          
          await this.refreshUserInfo();
          Utils.showError('æ¿€æ´»æˆåŠŸï¼');
          
        } catch (error) {
          Utils.showError(`æ¿€æ´»å¤±è´¥: ${error.message}`);
        }
      },

      async claimReward() {
        if (!account || !lpRewardContract) return;
        
        try {
          const tx = await lpRewardContract.claimAll();
          await tx.wait();
          
          await this.refreshUserInfo();
          Utils.showError('é¢†å–å¥–åŠ±æˆåŠŸï¼');
          
        } catch (error) {
          Utils.showError(`é¢†å–å¤±è´¥: ${error.message}`);
        }
      },

      async claimReferralReward() {
        if (!account || !lpRewardContract) return;
        
        try {
          const tx = await lpRewardContract.claimReferral();
          await tx.wait();
          
          await this.refreshUserInfo();
          Utils.showError('é¢†å–æ¨èå¥–åŠ±æˆåŠŸï¼');
          
        } catch (error) {
          Utils.showError(`é¢†å–å¤±è´¥: ${error.message}`);
        }
      }
    };

    // ==================== äº‹ä»¶å¤„ç† ====================
    const EventHandlers = {
      init() {
        this.setupWalletEvents();
        this.setupSwapEvents();
        this.setupLiquidityEvents();
        this.setupLPRewardEvents();
        this.setupModalEvents();
        this.setupTabEvents();
      },

      setupWalletEvents() {
        document.getElementById("walletBtn").addEventListener("click", async () => {
          if (account) {
            if (confirm("ç¡®å®šè¦æ–­å¼€é’±åŒ…è¿æ¥å—ï¼Ÿ")) {
              account = null;
              AppCore.updateUI();
              return;
            }
          }
          
          await AppCore.connectWallet();
        });
      },

      setupSwapEvents() {
        document.getElementById("fromAmount").addEventListener("input", () => {
          SwapModule.updateOutputFromInput();
        });
        
        document.getElementById("reverse").addEventListener("click", () => {
          [fromToken, toToken] = [toToken, fromToken];
          
          document.getElementById("fromTokenSymbol").textContent = fromToken;
          document.getElementById("toTokenSymbol").textContent = toToken;
          
          const fromLogo = fromToken === 'CFX' ? 'https://i.imgur.com/70cXbUI.jpeg' : 'https://i.imgur.com/HddyTrv.jpeg';
          const toLogo = toToken === 'CFX' ? 'https://i.imgur.com/70cXbUI.jpeg' : 'https://i.imgur.com/HddyTrv.jpeg';
          
          document.getElementById("fromTokenLogo").style.backgroundImage = `url('${fromLogo}')`;
          document.getElementById("toTokenLogo").style.backgroundImage = `url('${toLogo}')`;
          
          document.getElementById("fromAmount").value = "";
          document.getElementById("toAmount").value = "";
          
          DataManager.updateAllBalances();
          DataManager.updateSwapButtonState();
        });
        
        document.getElementById("swapBtn").addEventListener("click", async () => {
          if (!account) {
            await AppCore.connectWallet();
          } else {
            await SwapModule.executeSwap();
          }
        });
        
        // ç™¾åˆ†æ¯”æŒ‰é’®
        document.querySelectorAll('.percent-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const percent = parseFloat(e.target.dataset.percent);
            document.querySelectorAll('.percent-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            
            if (!account) {
              Utils.showError("è¯·å…ˆè¿æ¥é’±åŒ…");
              return;
            }
            
            let balance = parseFloat(document.getElementById("fromBal").textContent);
            if (balance > 0) {
              let amount = balance * percent;
              if (percent === 1) {
                amount = Math.max(0, balance - 0.1);
              }
              
              if (amount > 0) {
                document.getElementById("fromAmount").value = Utils.formatDisplay(amount);
                SwapModule.updateOutputFromInput();
              }
            }
          });
        });
        
        // æ»‘ç‚¹æŒ‰é’®
        document.querySelectorAll('.slippage-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            slippage = parseFloat(e.target.dataset.slip);
            document.querySelectorAll('.slippage-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            
            if (document.getElementById("fromAmount").value) {
              SwapModule.updateOutputFromInput();
            }
          });
        });
      },

      setupLiquidityEvents() {
        document.getElementById("addBtn").addEventListener("click", () => {
          if (!account) {
            Utils.showError("è¯·å…ˆè¿æ¥é’±åŒ…");
            return;
          }
          
          document.getElementById("addModal").style.display = "flex";
          document.getElementById("addCfx").value = "";
          document.getElementById("addLom").value = "";
          document.getElementById("confirmAddBtn").disabled = true;
        });
        
        document.getElementById("removeBtn").addEventListener("click", () => {
          if (!account) {
            Utils.showError("è¯·å…ˆè¿æ¥é’±åŒ…");
            return;
          }
          
          document.getElementById("removeModal").style.display = "flex";
          LiquidityModule.updateRemoveEstimate(100);
        });
        
        document.getElementById("cfxMaxBtn").addEventListener("click", () => LiquidityModule.setMaxCfx());
        document.getElementById("lomMaxBtn").addEventListener("click", () => LiquidityModule.setMaxLom());
        
        document.getElementById("cancelAddBtn").addEventListener("click", () => {
          document.getElementById("addModal").style.display = "none";
        });
        
        document.getElementById("confirmAddBtn").addEventListener("click", async () => {
          await LiquidityModule.addLiquidity();
        });
        
        document.getElementById("addCfx").addEventListener("input", () => {
          const cfxAmount = document.getElementById("addCfx").value;
          if (!cfxAmount || cfxAmount === "") {
            document.getElementById("addLom").value = "";
            document.getElementById("confirmAddBtn").disabled = true;
            return;
          }
          
          if (currentRatio > 0) {
            const cfxNum = parseFloat(cfxAmount);
            const lomAmount = cfxNum * currentRatio;
            document.getElementById("addLom").value = Utils.formatDisplay(lomAmount);
          }
          
          LiquidityModule.updateAddButtonState();
        });
        
        document.getElementById("addLom").addEventListener("input", () => {
          const lomAmount = document.getElementById("addLom").value;
          if (!lomAmount || lomAmount === "") {
            document.getElementById("addCfx").value = "";
            document.getElementById("confirmAddBtn").disabled = true;
            return;
          }
          
          if (currentRatio > 0) {
            const lomNum = parseFloat(lomAmount);
            const cfxAmount = lomNum / currentRatio;
            document.getElementById("addCfx").value = Utils.formatDisplay(cfxAmount);
          }
          
          LiquidityModule.updateAddButtonState();
        });
        
        // ç§»é™¤æµåŠ¨æ€§å¤„ç†
        document.getElementById("removeSlider").addEventListener("input", (e) => {
          LiquidityModule.updateRemoveEstimate(e.target.value);
        });
        
        document.querySelectorAll('.percentage-option').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const percent = e.target.dataset.percent;
            document.querySelectorAll('.percentage-option').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            document.getElementById("removeSlider").value = percent;
            document.getElementById("removePercent").textContent = percent + "%";
            LiquidityModule.updateRemoveEstimate(percent);
          });
        });
        
        document.getElementById("cancelRemoveBtn").addEventListener("click", () => {
          document.getElementById("removeModal").style.display = "none";
        });
        
        document.getElementById("confirmRemoveBtn").addEventListener("click", async () => {
          await LiquidityModule.removeLiquidity();
        });
      },

      setupLPRewardEvents() {
        document.getElementById("activateBtn").addEventListener("click", () => {
          referrerAddress = document.getElementById('referrerAddress').value.trim();
          LPRewardManager.activateReward();
        });
        
        document.getElementById("claimBtn").addEventListener("click", () => {
          LPRewardManager.claimReward();
        });
        
        document.getElementById("claimReferralBtn").addEventListener("click", () => {
          LPRewardManager.claimReferralReward();
        });
        
        document.getElementById('referrerAddress').addEventListener('input', (e) => {
          referrerAddress = e.target.value.trim();
        });
      },

      setupModalEvents() {
        document.addEventListener("click", (e) => {
          if (e.target.classList.contains("modal-overlay")) {
            e.target.style.display = "none";
          }
        });
      },

      setupTabEvents() {
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const tabId = btn.dataset.tab;
            
            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(tabId + 'Tab').classList.add('active');
            
            if (account && tabId === 'lpReward') {
              LPRewardManager.refreshUserInfo();
            }
          });
        });
      }
    };

    // ==================== äº¤æ¢æ¨¡å— ====================
    const SwapModule = {
      async executeSwap() {
        const fromAmount = document.getElementById('fromAmount').value;
        
        if (!fromAmount || fromAmount === '0') {
          Utils.showError("è¯·è¾“å…¥å…‘æ¢æ•°é‡");
          return;
        }
        
        try {
          const amountIn = ethers.utils.parseEther(fromAmount);
          const path = [APP_CONFIG.CONTRACTS.WCFX, APP_CONFIG.CONTRACTS.LOM];
          const amounts = await router.getAmountsOut(amountIn, path);
          const minOut = amounts[1].mul(1000 - slippage * 10).div(1000);
          
          const deadline = Math.floor(Date.now() / 1000) + 1200;
          
          const tx = await router.swapExactETHForTokensSupportingFeeOnTransferTokens(
            minOut, path, account, deadline, 
            { value: amountIn }
          );
          
          await tx.wait();
          
          document.getElementById('fromAmount').value = '';
          document.getElementById('toAmount').value = '';
          
          Utils.showError('å…‘æ¢æˆåŠŸï¼');
          
          await DataManager.refreshAll();
          
        } catch (error) {
          Utils.showError(`å…‘æ¢å¤±è´¥: ${error.message}`);
        }
      },

      async updateOutputFromInput() {
        const amount = document.getElementById('fromAmount').value;
        
        if (!amount || amount === '0' || amount === '' || !router) {
          document.getElementById('toAmount').value = "";
          document.getElementById('minReceived').textContent = `0 ${toToken}`;
          DataManager.updateSwapButtonState();
          return;
        }
        
        try {
          const amountIn = ethers.utils.parseEther(amount);
          const path = [APP_CONFIG.CONTRACTS.WCFX, APP_CONFIG.CONTRACTS.LOM];
          
          const amounts = await router.getAmountsOut(amountIn, path);
          const out = parseFloat(ethers.utils.formatUnits(amounts[1], 18));
          
          document.getElementById('toAmount').value = Utils.formatDisplay(out);
          
          const minOut = amounts[1].mul(1000 - slippage * 10).div(1000);
          const minOutFormatted = parseFloat(ethers.utils.formatUnits(minOut, 18)).toFixed(6);
          document.getElementById('minReceived').textContent = `${minOutFormatted} ${toToken}`;
          
          const price = out / parseFloat(amount);
          document.getElementById('price').textContent = `1 ${fromToken} = ${price.toFixed(6)} ${toToken}`;
          
          DataManager.updateSwapButtonState();
          
        } catch (error) {
          console.error('è®¡ç®—è¾“å‡ºå¤±è´¥:', error);
          document.getElementById('toAmount').value = "";
          document.getElementById('swapBtn').textContent = 'è®¡ç®—å¤±è´¥';
          document.getElementById('swapBtn').disabled = true;
        }
      }
    };

    // ==================== æµåŠ¨æ€§æ¨¡å— ====================
    const LiquidityModule = {
      async addLiquidity() {
        const cfxAmount = document.getElementById("addCfx").value;
        const lomAmount = document.getElementById("addLom").value;
        
        if (!cfxAmount || !lomAmount || parseFloat(cfxAmount) <= 0 || parseFloat(lomAmount) <= 0) {
          Utils.showError("è¯·è¾“å…¥æœ‰æ•ˆæ•°é‡");
          return;
        }
        
        try {
          const amountCfx = ethers.utils.parseEther(cfxAmount);
          const amountLom = ethers.utils.parseUnits(lomAmount, 18);
          
          const allowance = await lom.allowance(account, APP_CONFIG.CONTRACTS.ROUTER);
          if (allowance.lt(amountLom)) {
            const approveTx = await lom.approve(APP_CONFIG.CONTRACTS.ROUTER, ethers.constants.MaxUint256);
            await approveTx.wait();
          }
          
          const minCfx = amountCfx.mul(1000 - slippage * 10).div(1000);
          const minLom = amountLom.mul(1000 - slippage * 10).div(1000);
          const deadline = Math.floor(Date.now() / 1000) + 1800;
          
          const tx = await router.addLiquidityETH(
            APP_CONFIG.CONTRACTS.LOM,
            amountLom,
            minLom,
            minCfx,
            account,
            deadline,
            { value: amountCfx }
          );
          
          await tx.wait();
          
          document.getElementById("addModal").style.display = "none";
          
          Utils.showError('æ·»åŠ æµåŠ¨æ€§æˆåŠŸï¼');
          
          await DataManager.refreshAll();
          
        } catch (error) {
          Utils.showError(`æ·»åŠ æµåŠ¨æ€§å¤±è´¥: ${error.message}`);
        }
      },

      async removeLiquidity() {
        const percent = document.getElementById("removeSlider").value;
        
        try {
          const lpBal = await pair.balanceOf(account);
          const liquidity = lpBal.mul(percent).div(100);
          
          if (liquidity.isZero()) {
            throw new Error('æ²¡æœ‰æµåŠ¨æ€§å¯ç§»é™¤');
          }
          
          const allowance = await pair.allowance(account, APP_CONFIG.CONTRACTS.ROUTER);
          if (allowance.lt(liquidity)) {
            const approveTx = await pair.approve(APP_CONFIG.CONTRACTS.ROUTER, ethers.constants.MaxUint256);
            await approveTx.wait();
          }
          
          const deadline = Math.floor(Date.now() / 1000) + 1800;
          
          const tx = await router.removeLiquidityETH(
            APP_CONFIG.CONTRACTS.LOM, 
            liquidity, 
            0,
            0,
            account, 
            deadline
          );
          
          await tx.wait();
          
          document.getElementById("removeModal").style.display = "none";
          
          Utils.showError('ç§»é™¤æµåŠ¨æ€§æˆåŠŸï¼');
          
          await DataManager.refreshAll();
          
        } catch (error) {
          Utils.showError(`ç§»é™¤æµåŠ¨æ€§å¤±è´¥: ${error.message}`);
        }
      },

      async updateRemoveEstimate(percent) {
        try {
          if (!account || !pair) return;
          
          document.getElementById("removePercent").textContent = percent + "%";
          
          const lpBal = await pair.balanceOf(account);
          const liquidity = lpBal.mul(percent).div(100);
          
          if (liquidity.isZero()) {
            document.getElementById("removeEstCfx").textContent = "0.000000";
            document.getElementById("removeEstLom").textContent = "0.000000";
            return;
          }
          
          const total = await pair.totalSupply();
          const { cfx: rCfx, lom: rLom } = currentReserves;
          
          const cfxReserve = ethers.utils.parseEther(rCfx.toString());
          const lomReserve = ethers.utils.parseUnits(rLom.toString(), 18);
          
          const cfxOut = cfxReserve.mul(liquidity).div(total);
          const lomOut = lomReserve.mul(liquidity).div(total);
          
          const cfxOutFormatted = parseFloat(ethers.utils.formatEther(cfxOut)).toFixed(6);
          const lomOutFormatted = parseFloat(ethers.utils.formatUnits(lomOut, 18)).toFixed(6);
          
          document.getElementById("removeEstCfx").textContent = cfxOutFormatted;
          document.getElementById("removeEstLom").textContent = lomOutFormatted;
          
        } catch (error) {
          console.error("æ›´æ–°ç§»é™¤ä¼°ç®—å¤±è´¥:", error);
        }
      },

      updateAddButtonState() {
        const cfxAmount = document.getElementById("addCfx").value;
        const lomAmount = document.getElementById("addLom").value;
        const cfxBalance = parseFloat(document.getElementById("addCfxBal").textContent);
        const lomBalance = parseFloat(document.getElementById("addLomBal").textContent);
        const confirmButton = document.getElementById("confirmAddBtn");
        
        if (!cfxAmount || !lomAmount || cfxAmount === "" || lomAmount === "") {
          confirmButton.disabled = true;
          return;
        }
        
        const cfxNum = parseFloat(cfxAmount);
        const lomNum = parseFloat(lomAmount);
        
        if (isNaN(cfxNum) || isNaN(lomNum) || cfxNum <= 0 || lomNum <= 0) {
          confirmButton.disabled = true;
          return;
        }
        
        if (cfxNum > cfxBalance || lomNum > lomBalance) {
          confirmButton.disabled = true;
          return;
        }
        
        confirmButton.disabled = false;
      },

      async setMaxCfx() {
        const cfxBal = parseFloat(document.getElementById("addCfxBal").textContent);
        if (cfxBal <= 0) {
          Utils.showError("CFXä½™é¢ä¸è¶³");
          return;
        }
        
        const maxCfx = Math.max(0, cfxBal - 0.1);
        document.getElementById("addCfx").value = Utils.formatDisplay(maxCfx);
        
        if (currentRatio > 0) {
          const requiredLom = maxCfx * currentRatio;
          document.getElementById("addLom").value = Utils.formatDisplay(requiredLom);
        }
        
        this.updateAddButtonState();
      },

      async setMaxLom() {
        const lomBal = parseFloat(document.getElementById("addLomBal").textContent);
        if (lomBal <= 0) {
          Utils.showError("LOMä½™é¢ä¸è¶³");
          return;
        }
        
        document.getElementById("addLom").value = Utils.formatDisplay(lomBal);
        
        if (currentRatio > 0) {
          const requiredCfx = lomBal / currentRatio;
          document.getElementById("addCfx").value = Utils.formatDisplay(requiredCfx);
        }
        
        this.updateAddButtonState();
      }
    };

    // ==================== åˆå§‹åŒ– ====================
    document.addEventListener('DOMContentLoaded', function() {
      EventHandlers.init();
      
      if (window.ethereum) {
        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            account = null;
            AppCore.updateUI();
          } else {
            account = accounts[0];
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            AppCore.initContracts();
            AppCore.updateUI();
            DataManager.refreshAll();
            LPRewardManager.refreshUserInfo();
          }
        });
        
        window.ethereum.on('chainChanged', () => {
          location.reload();
        });
      }
    });
  </script>
</body>
</html>
