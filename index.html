<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOMswap - LPæŒ–çŸ¿</title>
  
  <!-- æ”¶è—å›¾æ ‡å’Œç¤¾äº¤åª’ä½“æ ‡ç­¾ -->
  <link rel="icon" type="image/x-icon" href="https://i.imgur.com/HddyTrv.jpeg">
  <link rel="apple-touch-icon" href="https://i.imgur.com/HddyTrv.jpeg">
  <link rel="shortcut icon" href="https://i.imgur.com/HddyTrv.jpeg">
  
  <!-- Open Graph æ ‡ç­¾ï¼Œç”¨äºç¤¾äº¤åª’ä½“åˆ†äº« -->
  <meta property="og:title" content="LOMswap - LPæŒ–çŸ¿å†œåœº">
  <meta property="og:description" content="è´¨æŠ¼CFX-LOM LPä»£å¸ï¼Œèµšå–LOMå¥–åŠ±">
  <meta property="og:image" content="https://i.imgur.com/HddyTrv.jpeg">
  <meta property="og:url" content="https://lom-dex.com">
  <meta name="twitter:card" content="summary_large_image">
  
  <!-- å®‰å…¨ç­–ç•¥ -->
  <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self' https:;
                 script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval';
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' https://i.imgur.com data:;
                 connect-src 'self' https://*.confluxrpc.com wss: blob:;
                 font-src 'self' data:;
                 frame-src 'none';
                 object-src 'none';">
  
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    /* ========== åŸºç¡€æ ·å¼ ========== */
    :root {
      --primary-dark: #0d1117;
      --primary-blue: #1a73e8;
      --accent-purple: #8a2be2;
      --accent-yellow: #ffd700;
      --accent-red: #ff4757;
      --accent-green: #2ea043;
      --card-bg: #161b22;
      --card-bg-light: #1c2128;
      --border-color: #30363d;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --success: #2ea043;
      --warning: #ff6b6b;
      --bronze: #cd7f32;
      --silver: #c0c0c0;
      --gold: #ffd700;
      --gradient-primary: linear-gradient(135deg, #1a73e8, #8a2be2);
      --gradient-yellow: linear-gradient(135deg, #ffd700, #ffa500);
      --gradient-red: linear-gradient(135deg, #ff4757, #ff6b81);
      --gradient-green: linear-gradient(135deg, #2ea043, #3ddc84);
      --gradient-card: linear-gradient(135deg, rgba(26, 115, 232, 0.1), rgba(138, 43, 226, 0.05));
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent !important;
    }
    
    body {
      background: var(--primary-dark);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(26, 115, 232, 0.05) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(138, 43, 226, 0.05) 0%, transparent 40%);
    }
    
    .app {
      width: 100%;
      max-width: 480px;
      animation: fadeIn 0.5s ease-out;
    }

    /* ========== å¤´éƒ¨æ ·å¼ ========== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 0 10px;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }
    
    .logo-img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-image: url('https://i.imgur.com/HddyTrv.jpeg');
      background-size: cover;
      background-position: center;
      border: 2px solid var(--accent-yellow);
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
    }
    
    .logo-text {
      font-size: 24px;
      font-weight: 900;
      background: var(--gradient-yellow);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .btn {
      background: var(--gradient-primary);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px 16px;
      font-size: 14px;
      height: 40px;
      white-space: nowrap;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(26, 115, 232, 0.3);
    }
    
    #walletBtn.connected {
      background: rgba(46, 160, 67, 0.15);
      border: 1px solid var(--success);
      color: var(--success);
      font-size: 13px;
    }
    
    /* ========== æ ‡ç­¾é¡µæ ·å¼ ========== */
    .tab-container {
      margin-bottom: 20px;
    }
    
    .tabs {
      display: flex;
      background: var(--card-bg);
      border-radius: 16px;
      padding: 4px;
      border: 1px solid var(--border-color);
    }
    
    .tab-btn {
      flex: 1;
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .tab-btn.active {
      background: var(--gradient-primary);
      color: white;
      box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* ========== å¡ç‰‡æ ·å¼ ========== */
    .card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* ========== LPæŒ–çŸ¿é¡µé¢æ ·å¼ ========== */
    .farm-card {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(138, 43, 226, 0.1));
      border-radius: 16px;
      padding: 16px;
      margin: 16px 0;
      border: 1px solid var(--border-color);
      text-align: center;
    }
    
    .farm-title {
      font-size: 20px;
      font-weight: bold;
      color: var(--accent-yellow);
      margin-bottom: 8px;
    }
    
    .farm-description {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
      line-height: 1.4;
    }
    
    /* å¥–åŠ±æ± çŠ¶æ€ */
    .pool-status {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
      border: 1px solid var(--border-color);
    }
    
    .status-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      text-align: center;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .status-item {
      text-align: center;
    }
    
    .status-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .status-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .status-value.highlight {
      color: var(--accent-yellow);
    }
    
    /* ç”¨æˆ·ä¿¡æ¯ */
    .user-info-card {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 16px;
      margin: 16px 0;
      border: 1px solid var(--border-color);
      display: none;
    }
    
    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .user-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .user-level {
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .level-bronze {
      background: rgba(205, 127, 50, 0.2);
      color: var(--bronze);
      border: 1px solid rgba(205, 127, 50, 0.4);
    }
    
    .level-silver {
      background: rgba(192, 192, 192, 0.2);
      color: var(--silver);
      border: 1px solid rgba(192, 192, 192, 0.4);
    }
    
    .level-gold {
      background: rgba(255, 215, 0, 0.2);
      color: var(--gold);
      border: 1px solid rgba(255, 215, 0, 0.4);
    }
    
    .user-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .user-item {
      background: rgba(26, 115, 232, 0.05);
      border-radius: 8px;
      padding: 8px;
      text-align: center;
    }
    
    .user-label {
      font-size: 10px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .user-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    /* æ“ä½œæŒ‰é’® */
    .farm-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 16px;
    }
    
    .farm-btn {
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .farm-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .farm-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .activate-btn {
      background: rgba(46, 160, 67, 0.1);
      color: var(--success);
      border: 1px solid rgba(46, 160, 67, 0.3);
    }
    
    .sync-btn {
      background: var(--gradient-yellow);
      color: #0f172a;
    }
    
    .claim-btn {
      background: var(--gradient-primary);
      color: white;
    }
    
    .checkin-btn {
      background: rgba(138, 43, 226, 0.1);
      color: var(--accent-purple);
      border: 1px solid rgba(138, 43, 226, 0.3);
    }
    
    /* é¢„ä¼°å¥–åŠ± */
    .estimate-card {
      background: rgba(26, 115, 232, 0.1);
      border-radius: 12px;
      padding: 12px;
      margin: 12px 0;
      border: 1px solid var(--border-color);
    }
    
    .estimate-title {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-align: center;
    }
    
    .estimate-values {
      display: flex;
      justify-content: space-around;
      align-items: center;
    }
    
    .estimate-item {
      text-align: center;
    }
    
    .estimate-label {
      font-size: 10px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .estimate-amount {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    /* æ¨¡æ€æ¡† */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(13, 17, 23, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }
    
    .modal-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      border: 1px solid var(--border-color);
      position: relative;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      text-align: center;
    }
    
    .modal-content {
      margin: 20px 0;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
    }
    
    .modal-btn.cancel {
      background: var(--card-bg);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }
    
    .modal-btn.confirm {
      background: var(--gradient-primary);
      color: white;
    }
    
    .modal-btn.confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }
    
    /* äº¤æ˜“çŠ¶æ€ */
    .tx-status {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--gradient-primary);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 8px 24px rgba(26, 115, 232, 0.4);
      z-index: 3000;
      display: none;
      animation: slideDown 0.3s ease;
    }
    
    .tx-status.success {
      background: var(--gradient-green);
    }
    
    .tx-status.error {
      background: var(--gradient-red);
    }
    
    /* åŠ¨ç”» */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(26, 115, 232, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-blue);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* å“åº”å¼ */
    @media (max-width: 480px) {
      .app {
        padding: 0;
      }
      
      .card {
        margin: 10px;
        padding: 14px;
      }
      
      .status-grid,
      .user-grid {
        grid-template-columns: 1fr;
      }
      
      .farm-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- ä¸»åº”ç”¨å®¹å™¨ -->
  <div class="app">
    <!-- å¤´éƒ¨ -->
    <div class="header">
      <div class="logo-container">
        <div class="logo-img"></div>
        <div class="logo-text">LOMswap</div>
      </div>
      <div class="header-buttons">
        <button class="btn" id="walletBtn">è¿æ¥é’±åŒ…</button>
      </div>
    </div>

    <!-- æ ‡ç­¾é¡µ -->
    <div class="tab-container">
      <div class="tabs">
        <button class="tab-btn" data-tab="swap">å…‘æ¢</button>
        <button class="tab-btn" data-tab="liquidity">æµåŠ¨æ€§</button>
        <button class="tab-btn active" data-tab="farm">LPæŒ–çŸ¿</button>
      </div>
    </div>

    <!-- LPæŒ–çŸ¿é¡µé¢ -->
    <div class="tab-content active" id="farmTab">
      <div class="card">
        <div class="card-title">
          <span>ğŸšœ</span>
          <span>LOMæŒ–çŸ¿å†œåœº</span>
        </div>

        <!-- å†œåœºä»‹ç» -->
        <div class="farm-card">
          <div class="farm-title">ğŸ¯ LOMå¥–åŠ±å†œåœº</div>
          <div class="farm-description">
            è´¨æŠ¼CFX-LOM LPä»£å¸ï¼Œèµšå–LOMå¥–åŠ±ã€‚æ€»å¥–åŠ±æ± ï¼š25,555,555 LOM
          </div>
          
          <!-- å¥–åŠ±æ± çŠ¶æ€ -->
          <div class="pool-status">
            <div class="status-title">å¥–åŠ±æ± çŠ¶æ€</div>
            <div class="status-grid" id="poolStatusGrid">
              <div class="status-item">
                <div class="status-label">æ€»å­˜æ¬¾</div>
                <div class="status-value" id="totalDeposited">0 LOM</div>
              </div>
              <div class="status-item">
                <div class="status-label">å·²åˆ†å‘</div>
                <div class="status-value" id="totalDistributed">0 LOM</div>
              </div>
              <div class="status-item">
                <div class="status-label">å‰©ä½™</div>
                <div class="status-value highlight" id="remainingLOM">0 LOM</div>
              </div>
              <div class="status-item">
                <div class="status-label">çŠ¶æ€</div>
                <div class="status-value" id="farmingStatus">æœªæ¿€æ´»</div>
              </div>
            </div>
          </div>

          <!-- ç”¨æˆ·ä¿¡æ¯ -->
          <div class="user-info-card" id="userInfoCard">
            <div class="user-header">
              <div class="user-title">æˆ‘çš„å†œåœº</div>
              <div class="user-level" id="userLevel">BRONZE</div>
            </div>
            
            <div class="user-grid">
              <div class="user-item">
                <div class="user-label">LPä½™é¢</div>
                <div class="user-value" id="userLPBalance">0</div>
              </div>
              <div class="user-item">
                <div class="user-label">å¾…é¢†å–å¥–åŠ±</div>
                <div class="user-value" id="pendingRewards">0 LOM</div>
              </div>
              <div class="user-item">
                <div class="user-label">æ´»åŠ¨åˆ†æ•°</div>
                <div class="user-value" id="activityScore">0</div>
              </div>
              <div class="user-item">
                <div class="user-label">è¿ç»­å¤©æ•°</div>
                <div class="user-value" id="consecutiveDays">0</div>
              </div>
              <div class="user-item">
                <div class="user-label">ä»Šæ—¥å·²å¾—</div>
                <div class="user-value" id="dailyEarned">0 LOM</div>
              </div>
              <div class="user-item">
                <div class="user-label">ä»Šæ—¥å‰©ä½™</div>
                <div class="user-value" id="dailyLeft">3000 LOM</div>
              </div>
            </div>
            
            <!-- é¢„ä¼°å¥–åŠ± -->
            <div class="estimate-card">
              <div class="estimate-title">ä¸‹æ¬¡åŒæ­¥é¢„ä¼°å¥–åŠ±</div>
              <div class="estimate-values">
                <div class="estimate-item">
                  <div class="estimate-label">å®‰å…¨é¢„ä¼°</div>
                  <div class="estimate-amount" id="safeEstimate">0 LOM</div>
                </div>
                <div class="estimate-item">
                  <div class="estimate-label">ä¹è§‚é¢„ä¼°</div>
                  <div class="estimate-amount" id="optimisticEstimate">0 LOM</div>
                </div>
              </div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="farm-actions">
              <button class="farm-btn sync-btn" id="syncBtn">
                <span id="syncIcon">ğŸ”„</span>
                <span id="syncText">åŒæ­¥å¥–åŠ±</span>
                <span id="syncTimer" style="margin-left: auto; font-size: 11px;"></span>
              </button>
              <button class="farm-btn claim-btn" id="claimBtn">
                <span>ğŸ’°</span>
                <span>é¢†å–LOMå¥–åŠ±</span>
              </button>
              <button class="farm-btn checkin-btn" id="checkinBtn">
                <span>ğŸ“…</span>
                <span>æ¯æ—¥ç­¾åˆ°</span>
              </button>
            </div>
          </div>
          
          <!-- æ¿€æ´»è´¦æˆ· -->
          <div class="farm-actions" id="activateSection">
            <div class="farm-description" style="margin-bottom: 12px;">
              æ‚¨éœ€è¦å…ˆæ¿€æ´»è´¦æˆ·æ‰èƒ½å¼€å§‹æŒ–çŸ¿ã€‚è¯·ç¡®ä¿æ‚¨æŒæœ‰CFX-LOM LPä»£å¸ã€‚
            </div>
            <button class="farm-btn activate-btn" id="activateBtn">
              <span>âœ…</span>
              <span>æ¿€æ´»è´¦æˆ·</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- é¡µè„š -->
    <div class="footer">LOMswap Â· LPæŒ–çŸ¿å†œåœº Â· Conflux eSpace</div>
  </div>

  <!-- ç¡®è®¤æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal-card">
      <h3 class="modal-title" id="confirmTitle">ç¡®è®¤æ“ä½œ</h3>
      <div class="modal-content" id="confirmContent">
        <!-- å†…å®¹åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div class="modal-actions">
        <button class="modal-btn cancel" id="cancelBtn">å–æ¶ˆ</button>
        <button class="modal-btn confirm" id="confirmBtn">ç¡®è®¤</button>
      </div>
    </div>
  </div>

  <!-- äº¤æ˜“çŠ¶æ€æç¤º -->
  <div class="tx-status" id="txStatus"></div>

  <script>
    'use strict';

    // ==================== é…ç½® ====================
    const CONFIG = {
      CHAIN_ID: 1030,
      CONTRACTS: {
        // LPä»£å¸åˆçº¦ (CFX-LOM Pair)
        LP_TOKEN: "0x063128f4e6BDFBC693d03649000B6E4dA00Bec85",
        // LOMä»£å¸åˆçº¦
        LOM: "0xb4ca1cb2651a822bf65c614c880a26fd124932a3",
        // LPå¥–åŠ±å†œåœºåˆçº¦
        LP_REWARD_FARM: "0xD1a50fB7DbDE52a180Ab6Dc83a6969869259D32a"
      }
    };

    // ==================== åˆçº¦ABI ====================
    const LP_REWARD_FARM_ABI = [
      // ç”¨æˆ·åŠŸèƒ½
      "function activate()",
      "function sync() returns (uint256 totalReward)",
      "function dailyCheckIn()",
      "function claimLOMRewards()",
      
      // æŸ¥è¯¢åŠŸèƒ½
      "function getPoolInfo() view returns (uint256 totalUsers, uint256 lomDeposited, uint256 lomDistributed, uint256 lomRemaining, uint256 currentDailyRate, uint256 currentDailyLimit, bool isActive, bool isPaused)",
      "function getUserInfo(address userAddr) view returns (uint256 currentBalance, uint256 pendingLOMRewards, uint256 activityScore, string memory level, uint256 consecutiveDays, uint256 nextSyncAvailable, uint256 dailyLOMLeft, bool canCheckInToday)",
      "function getPendingRewardsEstimate(address userAddr) view returns (uint256 safeRewards, uint256 optimisticRewards, bool estimateValid)",
      "function getLOMPoolStatus() view returns (uint256 maxSupply, uint256 totalDeposited, uint256 totalDistributed, uint256 remaining, uint256 depositProgress, uint256 distributionProgress, uint256 estimatedDaysLeft, string memory status)",
      
      // çŠ¶æ€å˜é‡
      "function farmingActive() view returns (bool)",
      "function totalLOMDeposited() view returns (uint256)",
      "function totalLOMDistributed() view returns (uint256)",
      "function remainingLOM() view returns (uint256)",
      
      // ç”¨æˆ·æ˜ å°„
      "function users(address) view returns (uint256 lastSyncTime, uint256 lastCheckInTime, uint256 firstJoinTime, uint256 lastRewardDay, uint256 activityScore, uint256 consecutiveDays, uint256 totalSyncs, uint8 level, bool isActive)"
    ];

    const ERC20_ABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function symbol() view returns (string)"
    ];

    // ==================== å…¨å±€å˜é‡ ====================
    let provider, signer, account;
    let lpToken, lomToken, farmContract;
    let refreshInterval;
    let currentAction = null;

    // ==================== å·¥å…·å‡½æ•° ====================
    const Utils = {
      formatUnits(value, decimals = 18) {
        try {
          return ethers.utils.formatUnits(value, decimals);
        } catch {
          return "0";
        }
      },

      parseUnits(value, decimals = 18) {
        try {
          return ethers.utils.parseUnits(value.toString(), decimals);
        } catch {
          return ethers.BigNumber.from(0);
        }
      },

      formatNumber(num, decimals = 2) {
        if (!num && num !== 0) return "0";
        const n = parseFloat(num);
        if (isNaN(n)) return "0";
        
        if (n >= 1000000) {
          return (n / 1000000).toFixed(decimals) + "M";
        } else if (n >= 1000) {
          return (n / 1000).toFixed(decimals) + "K";
        } else {
          const fixed = n.toFixed(decimals);
          return fixed.replace(/\.?0+$/, "");
        }
      },

      formatTime(seconds) {
        if (seconds <= 0) return "éšæ—¶";
        
        if (seconds < 60) {
          return `${Math.ceil(seconds)}ç§’å`;
        } else if (seconds < 3600) {
          return `${Math.ceil(seconds / 60)}åˆ†é’Ÿå`;
        } else if (seconds < 86400) {
          return `${Math.ceil(seconds / 3600)}å°æ—¶å`;
        } else {
          return `${Math.ceil(seconds / 86400)}å¤©å`;
        }
      },

      showStatus(message, type = "info") {
        const status = document.getElementById("txStatus");
        status.textContent = message;
        status.className = `tx-status ${type}`;
        status.style.display = "block";
        
        setTimeout(() => {
          status.style.display = "none";
        }, 5000);
      },

      showLoading(button, text) {
        button.disabled = true;
        button.innerHTML = `<span class="loading-spinner"></span><span>${text}</span>`;
      },

      hideLoading(button, text) {
        button.disabled = false;
        button.innerHTML = text;
      },

      async confirmAction(title, content) {
        return new Promise((resolve) => {
          const modal = document.getElementById("confirmModal");
          const titleEl = document.getElementById("confirmTitle");
          const contentEl = document.getElementById("confirmContent");
          const cancelBtn = document.getElementById("cancelBtn");
          const confirmBtn = document.getElementById("confirmBtn");
          
          titleEl.textContent = title;
          contentEl.innerHTML = content;
          modal.style.display = "flex";
          
          const cleanup = () => {
            modal.style.display = "none";
            cancelBtn.onclick = null;
            confirmBtn.onclick = null;
          };
          
          cancelBtn.onclick = () => {
            cleanup();
            resolve(false);
          };
          
          confirmBtn.onclick = () => {
            cleanup();
            resolve(true);
          };
        });
      }
    };

    // ==================== é’±åŒ…ç®¡ç† ====================
    const WalletManager = {
      async connect() {
        try {
          if (!window.ethereum) {
            Utils.showStatus("è¯·å®‰è£…TPæˆ–web3é’±åŒ…", "error");
            return false;
          }
          
          const accounts = await window.ethereum.request({
            method: 'eth_requestAccounts'
          });
          
          if (!accounts || accounts.length === 0) {
            throw new Error("ç”¨æˆ·æ‹’ç»è¿æ¥");
          }
          
          account = accounts[0];
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          
          await this.checkNetwork();
          await this.initContracts();
          this.updateUI();
          
          if (refreshInterval) clearInterval(refreshInterval);
          refreshInterval = setInterval(() => FarmManager.refreshFarmData(), 10000);
          
          Utils.showStatus("é’±åŒ…è¿æ¥æˆåŠŸ", "success");
          return true;
          
        } catch (error) {
          console.error("é’±åŒ…è¿æ¥å¤±è´¥:", error);
          Utils.showStatus(`è¿æ¥å¤±è´¥: ${error.message}`, "error");
          return false;
        }
      },

      async checkNetwork() {
        const network = await provider.getNetwork();
        if (network.chainId !== CONFIG.CHAIN_ID) {
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: '0x' + CONFIG.CHAIN_ID.toString(16) }]
            });
          } catch (error) {
            if (error.code === 4902) {
              Utils.showStatus("è¯·æ·»åŠ Conflux eSpaceç½‘ç»œ", "error");
            } else {
              Utils.showStatus("è¯·åˆ‡æ¢åˆ°Conflux eSpaceç½‘ç»œ", "error");
            }
            throw error;
          }
        }
      },

      async initContracts() {
        lpToken = new ethers.Contract(CONFIG.CONTRACTS.LP_TOKEN, ERC20_ABI, signer);
        lomToken = new ethers.Contract(CONFIG.CONTRACTS.LOM, ERC20_ABI, signer);
        farmContract = new ethers.Contract(CONFIG.CONTRACTS.LP_REWARD_FARM, LP_REWARD_FARM_ABI, signer);
      },

      updateUI() {
        const walletBtn = document.getElementById("walletBtn");
        if (account) {
          const shortAddr = account.slice(0, 6) + "..." + account.slice(-4);
          walletBtn.textContent = shortAddr;
          walletBtn.classList.add("connected");
        } else {
          walletBtn.textContent = "è¿æ¥é’±åŒ…";
          walletBtn.classList.remove("connected");
        }
      },

      disconnect() {
        account = null;
        provider = null;
        signer = null;
        
        if (refreshInterval) {
          clearInterval(refreshInterval);
          refreshInterval = null;
        }
        
        this.updateUI();
        FarmManager.resetUI();
        Utils.showStatus("é’±åŒ…å·²æ–­å¼€è¿æ¥", "success");
      }
    };

    // ==================== å†œåœºç®¡ç† ====================
    const FarmManager = {
      async refreshFarmData() {
        if (!account) return;
        
        try {
          // è·å–å†œåœºä¿¡æ¯
          await this.updatePoolInfo();
          
          // è·å–ç”¨æˆ·ä¿¡æ¯
          await this.updateUserInfo();
          
          // æ›´æ–°åŒæ­¥è®¡æ—¶å™¨
          this.updateSyncTimer();
          
        } catch (error) {
          console.error("åˆ·æ–°å†œåœºæ•°æ®å¤±è´¥:", error);
        }
      },

      async updatePoolInfo() {
        try {
          const poolInfo = await farmContract.getPoolInfo();
          
          // æ›´æ–°UI
          document.getElementById("totalDeposited").textContent = 
            Utils.formatNumber(Utils.formatUnits(poolInfo.lomDeposited)) + " LOM";
          document.getElementById("totalDistributed").textContent = 
            Utils.formatNumber(Utils.formatUnits(poolInfo.lomDistributed)) + " LOM";
          document.getElementById("remainingLOM").textContent = 
            Utils.formatNumber(Utils.formatUnits(poolInfo.lomRemaining)) + " LOM";
          
          const status = poolInfo.isActive ? 
            (poolInfo.isPaused ? "å·²æš‚åœ" : "è¿è¡Œä¸­") : 
            "æœªæ¿€æ´»";
          document.getElementById("farmingStatus").textContent = status;
          document.getElementById("farmingStatus").style.color = 
            poolInfo.isActive && !poolInfo.isPaused ? "var(--success)" : "var(--warning)";
            
        } catch (error) {
          console.error("è·å–å†œåœºä¿¡æ¯å¤±è´¥:", error);
        }
      },

      async updateUserInfo() {
        try {
          const userInfo = await farmContract.getUserInfo(account);
          const userInfoCard = document.getElementById("userInfoCard");
          const activateSection = document.getElementById("activateSection");
          
          if (userInfo.currentBalance > 0) {
            // ç”¨æˆ·å·²æ¿€æ´»
            userInfoCard.style.display = "block";
            activateSection.style.display = "none";
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            document.getElementById("userLPBalance").textContent = 
              Utils.formatNumber(Utils.formatUnits(userInfo.currentBalance));
            document.getElementById("pendingRewards").textContent = 
              Utils.formatNumber(Utils.formatUnits(userInfo.pendingLOMRewards)) + " LOM";
            document.getElementById("activityScore").textContent = userInfo.activityScore.toString();
            document.getElementById("consecutiveDays").textContent = userInfo.consecutiveDays.toString();
            
            // è®¡ç®—ä»Šæ—¥å·²å¾—å’Œå‰©ä½™
            const dailyEarned = userInfo.dailyLOMLeft < 3000 ? 
              (3000 - Utils.formatUnits(userInfo.dailyLOMLeft)) : 0;
            document.getElementById("dailyEarned").textContent = 
              Utils.formatNumber(dailyEarned) + " LOM";
            document.getElementById("dailyLeft").textContent = 
              Utils.formatNumber(Utils.formatUnits(userInfo.dailyLOMLeft)) + " LOM";
            
            // æ›´æ–°ç­‰çº§
            const levelEl = document.getElementById("userLevel");
            levelEl.textContent = userInfo.level;
            levelEl.className = `user-level level-${userInfo.level.toLowerCase()}`;
            
            // æ›´æ–°é¢„ä¼°å¥–åŠ±
            await this.updateRewardEstimate();
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            this.updateButtonStates(userInfo);
            
          } else {
            // ç”¨æˆ·æœªæ¿€æ´»
            userInfoCard.style.display = "none";
            activateSection.style.display = "block";
            
            // æ£€æŸ¥æ˜¯å¦æœ‰LPä»£å¸ä½™é¢
            const lpBalance = await lpToken.balanceOf(account);
            const activateBtn = document.getElementById("activateBtn");
            activateBtn.disabled = lpBalance.isZero();
          }
          
        } catch (error) {
          console.error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:", error);
        }
      },

      async updateRewardEstimate() {
        try {
          const estimate = await farmContract.getPendingRewardsEstimate(account);
          
          document.getElementById("safeEstimate").textContent = 
            Utils.formatNumber(Utils.formatUnits(estimate.safeRewards)) + " LOM";
          document.getElementById("optimisticEstimate").textContent = 
            Utils.formatNumber(Utils.formatUnits(estimate.optimisticRewards)) + " LOM";
            
        } catch (error) {
          console.error("è·å–å¥–åŠ±é¢„ä¼°å¤±è´¥:", error);
        }
      },

      updateButtonStates(userInfo) {
        const syncBtn = document.getElementById("syncBtn");
        const claimBtn = document.getElementById("claimBtn");
        const checkinBtn = document.getElementById("checkinBtn");
        
        // åŒæ­¥æŒ‰é’®çŠ¶æ€
        if (userInfo.nextSyncAvailable > 0) {
          syncBtn.disabled = true;
          const syncIcon = document.getElementById("syncIcon");
          const syncText = document.getElementById("syncText");
          const syncTimer = document.getElementById("syncTimer");
          
          syncIcon.style.display = "none";
          syncText.textContent = "ç­‰å¾…åŒæ­¥";
          syncTimer.textContent = Utils.formatTime(userInfo.nextSyncAvailable);
        } else {
          syncBtn.disabled = false;
          const syncIcon = document.getElementById("syncIcon");
          const syncText = document.getElementById("syncText");
          const syncTimer = document.getElementById("syncTimer");
          
          syncIcon.style.display = "inline";
          syncText.textContent = "åŒæ­¥å¥–åŠ±";
          syncTimer.textContent = "";
        }
        
        // é¢†å–æŒ‰é’®çŠ¶æ€
        claimBtn.disabled = userInfo.pendingLOMRewards.isZero();
        
        // ç­¾åˆ°æŒ‰é’®çŠ¶æ€
        checkinBtn.disabled = !userInfo.canCheckInToday;
      },

      updateSyncTimer() {
        const syncTimer = document.getElementById("syncTimer");
        if (syncTimer.textContent && syncTimer.textContent !== "éšæ—¶") {
          // è¿™é‡Œå¯ä»¥æ·»åŠ å®æ—¶å€’è®¡æ—¶é€»è¾‘
          // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬ä¾èµ–å®šæœŸåˆ·æ–°
        }
      },

      async activateAccount() {
        try {
          // æ£€æŸ¥LPä½™é¢
          const lpBalance = await lpToken.balanceOf(account);
          if (lpBalance.isZero()) {
            Utils.showStatus("æ‚¨æ²¡æœ‰LPä»£å¸ä½™é¢", "error");
            return;
          }
          
          // ç¡®è®¤å¯¹è¯æ¡†
          const confirmed = await Utils.confirmAction(
            "æ¿€æ´»è´¦æˆ·",
            `
              <div style="text-align: center; padding: 20px 0;">
                <div style="font-size: 48px; margin-bottom: 16px;">âœ…</div>
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">ç¡®è®¤æ¿€æ´»è´¦æˆ·</div>
                <div style="font-size: 14px; color: var(--text-secondary);">
                  æ¿€æ´»åå³å¯å¼€å§‹èµšå–LOMå¥–åŠ±<br>
                  LPä½™é¢: ${Utils.formatNumber(Utils.formatUnits(lpBalance))}
                </div>
              </div>
            `
          );
          
          if (!confirmed) return;
          
          // æ‰§è¡Œæ¿€æ´»
          const activateBtn = document.getElementById("activateBtn");
          Utils.showLoading(activateBtn, "æ¿€æ´»ä¸­...");
          
          const tx = await farmContract.activate();
          await tx.wait();
          
          Utils.showStatus("è´¦æˆ·æ¿€æ´»æˆåŠŸï¼", "success");
          await this.refreshFarmData();
          
        } catch (error) {
          console.error("æ¿€æ´»è´¦æˆ·å¤±è´¥:", error);
          Utils.showStatus(`æ¿€æ´»å¤±è´¥: ${error.message}`, "error");
        } finally {
          const activateBtn = document.getElementById("activateBtn");
          Utils.hideLoading(activateBtn, '<span>âœ…</span><span>æ¿€æ´»è´¦æˆ·</span>');
        }
      },

      async syncRewards() {
        try {
          // è·å–é¢„ä¼°å¥–åŠ±
          const estimate = await farmContract.getPendingRewardsEstimate(account);
          
          // ç¡®è®¤å¯¹è¯æ¡†
          const confirmed = await Utils.confirmAction(
            "åŒæ­¥å¥–åŠ±",
            `
              <div style="text-align: center; padding: 20px 0;">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”„</div>
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">ç¡®è®¤åŒæ­¥å¥–åŠ±</div>
                <div style="font-size: 14px; color: var(--text-secondary);">
                  é¢„ä¼°å¯è·å¾—å¥–åŠ±:<br>
                  <span style="color: var(--accent-yellow); font-weight: 600; font-size: 18px;">
                    ${Utils.formatNumber(Utils.formatUnits(estimate.optimisticRewards))} LOM
                  </span>
                </div>
              </div>
            `
          );
          
          if (!confirmed) return;
          
          // æ‰§è¡ŒåŒæ­¥
          const syncBtn = document.getElementById("syncBtn");
          Utils.showLoading(syncBtn, "åŒæ­¥ä¸­...");
          
          const tx = await farmContract.sync();
          const receipt = await tx.wait();
          
          // ä»äº‹ä»¶ä¸­è·å–å®é™…å¥–åŠ±
          let actualReward = "0";
          if (receipt.events) {
            for (const event of receipt.events) {
              if (event.event === "Synced") {
                actualReward = Utils.formatNumber(Utils.formatUnits(event.args.totalReward));
                break;
              }
            }
          }
          
          Utils.showStatus(`åŒæ­¥æˆåŠŸï¼è·å¾— ${actualReward} LOM`, "success");
          await this.refreshFarmData();
          
        } catch (error) {
          console.error("åŒæ­¥å¥–åŠ±å¤±è´¥:", error);
          Utils.showStatus(`åŒæ­¥å¤±è´¥: ${error.message}`, "error");
        } finally {
          const syncBtn = document.getElementById("syncBtn");
          Utils.hideLoading(syncBtn, '<span>ğŸ”„</span><span>åŒæ­¥å¥–åŠ±</span>');
        }
      },

      async claimRewards() {
        try {
          // è·å–å¾…é¢†å–å¥–åŠ±
          const userInfo = await farmContract.getUserInfo(account);
          const pendingRewards = userInfo.pendingLOMRewards;
          
          if (pendingRewards.isZero()) {
            Utils.showStatus("æ²¡æœ‰å¯é¢†å–çš„å¥–åŠ±", "error");
            return;
          }
          
          // ç¡®è®¤å¯¹è¯æ¡†
          const confirmed = await Utils.confirmAction(
            "é¢†å–å¥–åŠ±",
            `
              <div style="text-align: center; padding: 20px 0;">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ’°</div>
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">ç¡®è®¤é¢†å–LOMå¥–åŠ±</div>
                <div style="font-size: 14px; color: var(--text-secondary);">
                  é¢†å–é‡‘é¢:<br>
                  <span style="color: var(--accent-yellow); font-weight: 600; font-size: 18px;">
                    ${Utils.formatNumber(Utils.formatUnits(pendingRewards))} LOM
                  </span>
                </div>
              </div>
            `
          );
          
          if (!confirmed) return;
          
          // æ‰§è¡Œé¢†å–
          const claimBtn = document.getElementById("claimBtn");
          Utils.showLoading(claimBtn, "é¢†å–ä¸­...");
          
          const tx = await farmContract.claimLOMRewards();
          await tx.wait();
          
          Utils.showStatus(`æˆåŠŸé¢†å– ${Utils.formatNumber(Utils.formatUnits(pendingRewards))} LOM`, "success");
          await this.refreshFarmData();
          
        } catch (error) {
          console.error("é¢†å–å¥–åŠ±å¤±è´¥:", error);
          Utils.showStatus(`é¢†å–å¤±è´¥: ${error.message}`, "error");
        } finally {
          const claimBtn = document.getElementById("claimBtn");
          Utils.hideLoading(claimBtn, '<span>ğŸ’°</span><span>é¢†å–LOMå¥–åŠ±</span>');
        }
      },

      async dailyCheckIn() {
        try {
          // è·å–ç”¨æˆ·ä¿¡æ¯
          const userInfo = await farmContract.getUserInfo(account);
          
          // ç¡®è®¤å¯¹è¯æ¡†
          const confirmed = await Utils.confirmAction(
            "æ¯æ—¥ç­¾åˆ°",
            `
              <div style="text-align: center; padding: 20px 0;">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“…</div>
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">ç¡®è®¤æ¯æ—¥ç­¾åˆ°</div>
                <div style="font-size: 14px; color: var(--text-secondary);">
                  å½“å‰è¿ç»­ç­¾åˆ°å¤©æ•°: ${userInfo.consecutiveDays}<br>
                  ç­¾åˆ°å¯è·å¾—æ´»åŠ¨åˆ†æ•°åŠ æˆ
                </div>
              </div>
            `
          );
          
          if (!confirmed) return;
          
          // æ‰§è¡Œç­¾åˆ°
          const checkinBtn = document.getElementById("checkinBtn");
          Utils.showLoading(checkinBtn, "ç­¾åˆ°ä¸­...");
          
          const tx = await farmContract.dailyCheckIn();
          await tx.wait();
          
          Utils.showStatus("ç­¾åˆ°æˆåŠŸï¼", "success");
          await this.refreshFarmData();
          
        } catch (error) {
          console.error("ç­¾åˆ°å¤±è´¥:", error);
          Utils.showStatus(`ç­¾åˆ°å¤±è´¥: ${error.message}`, "error");
        } finally {
          const checkinBtn = document.getElementById("checkinBtn");
          Utils.hideLoading(checkinBtn, '<span>ğŸ“…</span><span>æ¯æ—¥ç­¾åˆ°</span>');
        }
      },

      resetUI() {
        // é‡ç½®æ‰€æœ‰æ˜¾ç¤º
        const elements = [
          "totalDeposited", "totalDistributed", "remainingLOM", "farmingStatus",
          "userLPBalance", "pendingRewards", "activityScore", "consecutiveDays",
          "dailyEarned", "dailyLeft", "safeEstimate", "optimisticEstimate"
        ];
        
        elements.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            if (id === "farmingStatus") {
              el.textContent = "æœªæ¿€æ´»";
              el.style.color = "";
            } else if (id.includes("LOM") || id === "safeEstimate" || id === "optimisticEstimate") {
              el.textContent = "0 LOM";
            } else {
              el.textContent = "0";
            }
          }
        });
        
        // éšè—ç”¨æˆ·ä¿¡æ¯ï¼Œæ˜¾ç¤ºæ¿€æ´»éƒ¨åˆ†
        document.getElementById("userInfoCard").style.display = "none";
        document.getElementById("activateSection").style.display = "block";
        
        // é‡ç½®æŒ‰é’®
        const activateBtn = document.getElementById("activateBtn");
        activateBtn.disabled = false;
        activateBtn.innerHTML = '<span>âœ…</span><span>æ¿€æ´»è´¦æˆ·</span>';
      }
    };

    // ==================== äº‹ä»¶ç›‘å¬ ====================
    document.addEventListener('DOMContentLoaded', function() {
      // é’±åŒ…æŒ‰é’®
      document.getElementById("walletBtn").addEventListener("click", async () => {
        if (account) {
          if (confirm("ç¡®å®šè¦æ–­å¼€é’±åŒ…è¿æ¥å—ï¼Ÿ")) {
            WalletManager.disconnect();
          }
        } else {
          await WalletManager.connect();
          if (account) {
            await FarmManager.refreshFarmData();
          }
        }
      });
      
      // æ ‡ç­¾é¡µåˆ‡æ¢
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
          
          if (account && btn.dataset.tab === 'farm') {
            FarmManager.refreshFarmData();
          }
        });
      });
      
      // å†œåœºæ“ä½œæŒ‰é’®
      document.getElementById("activateBtn").addEventListener("click", () => FarmManager.activateAccount());
      document.getElementById("syncBtn").addEventListener("click", () => FarmManager.syncRewards());
      document.getElementById("claimBtn").addEventListener("click", () => FarmManager.claimRewards());
      document.getElementById("checkinBtn").addEventListener("click", () => FarmManager.dailyCheckIn());
      
      // ç›‘å¬é’±åŒ…äº‹ä»¶
      if (window.ethereum) {
        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            WalletManager.disconnect();
          } else {
            account = accounts[0];
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            WalletManager.initContracts().then(() => {
              WalletManager.updateUI();
              FarmManager.refreshFarmData();
              if (!refreshInterval) {
                refreshInterval = setInterval(() => FarmManager.refreshFarmData(), 10000);
              }
            });
          }
        });
        
        window.ethereum.on('chainChanged', () => {
          location.reload();
        });
      }
    });
  </script>
</body>
</html>
